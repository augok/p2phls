var us=Object.defineProperty,p=(e,t,n)=>(n=n,(t="symbol"!=typeof t?t+"":t)in(e=e)?us(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n);class B extends Error{constructor(e,t){super(t),p(this,"timestamp"),this.type=e,this.timestamp=performance.now()}}class Dt extends Error{constructor(e){super(),this.type=e}}class gs{constructor(e,t,n){p(this,"requestControls"),p(this,"abortController",new AbortController),p(this,"expectedBytesLength"),p(this,"requestByteRange"),p(this,"onChunkDownloaded"),this.request=e,this.httpConfig=t,this.onChunkDownloaded=n.getEventDispatcher("onChunkDownloaded");t=this.request.segment.byteRange;t&&(this.requestByteRange={...t}),0!==e.loadedBytes&&(this.requestByteRange=this.requestByteRange??{start:0},this.requestByteRange.start=this.requestByteRange.start+e.loadedBytes),this.request.totalBytes&&(this.expectedBytesLength=this.request.totalBytes-this.request.loadedBytes),this.requestControls=this.request.start({downloadSource:"http"},{abort:()=>this.abortController.abort("abort"),notReceivingBytesTimeoutMs:this.httpConfig.httpNotReceivingBytesTimeoutMs}),this.fetch()}async fetch(){var t,n,s,i=this.request.segment;try{let e=await(null==(n=(t=this.httpConfig).httpRequestSetup)?void 0:n.call(t,i.url,i.byteRange,this.abortController.signal,this.requestByteRange));if(e||(s=new Headers(this.requestByteRange?{Range:`bytes=${this.requestByteRange.start}-`+(this.requestByteRange.end??"")}:void 0),e=new Request(i.url,{headers:s,signal:this.abortController.signal})),this.abortController.signal.aborted)throw new DOMException("Request aborted before request fetch","AbortError");var r=await window.fetch(e);if(this.handleResponseHeaders(r),r.body){var o,a=this.requestControls,h=(a.firstBytesReceived(),r.body.getReader());for await(o of async function*(e){for(;;){var{done:t,value:n}=await e.read();if(t)break;yield n}}(h))this.requestControls.addLoadedChunk(o),this.onChunkDownloaded(o.byteLength,"http");a.completeOnSuccess()}}catch(e){this.handleError(e)}}handleResponseHeaders(t){if(!t.ok)throw 406===t.status?(this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText)):new B("http-error",t.statusText);var n=this.requestByteRange;if(n)if(200===t.status){if(this.request.segment.byteRange)throw new B("http-unexpected-status-code");this.request.clearLoadedBytes()}else{if(206!==t.status)throw new B("http-unexpected-status-code",t.statusText);var i=t.headers.get("Content-Length");if(i&&void 0!==this.expectedBytesLength&&this.expectedBytesLength!==+i)throw this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText);let s=t.headers.get("Content-Range"),e=s?(()=>{var e,t,n=s.trim().match(/^bytes (?:(?:(\d+)|)-(?:(\d+)|)|\*)\/(?:(\d+)|\*)$/);if(n)return[,n,e,t]=n,{from:n?parseInt(n):void 0,to:e?parseInt(e):void 0,total:t?parseInt(t):void 0}})():void 0;if(e){var{from:i,to:r,total:o}=e;if(void 0!==o&&this.request.totalBytes!==o||void 0!==i&&n.start!==i||void 0!==r&&void 0!==n.end&&n.end!==r)throw this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText)}}200===t.status&&void 0===this.request.totalBytes&&(o=t.headers.get("Content-Length"))&&this.request.setTotalBytes(+o)}handleError(e){e instanceof Error&&"abort"===e.name&&(e=e instanceof B?e:new B("http-error",e.message),this.requestControls.abortOnError(e))}}function fs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var U,F,_n={exports:{}},L=_n.exports={};function se(){throw new Error("setTimeout has not been defined")}function ie(){throw new Error("clearTimeout has not been defined")}function bn(e){if(U===setTimeout)return setTimeout(e,0);if((U===se||!U)&&setTimeout)return(U=setTimeout)(e,0);try{return U(e,0)}catch{try{return U.call(null,e,0)}catch{return U.call(this,e,0)}}}try{U="function"==typeof setTimeout?setTimeout:se}catch{U=se}try{F="function"==typeof clearTimeout?clearTimeout:ie}catch{F=ie}var X,j=[],it=!1,Tt=-1;function ps(){it&&X&&(it=!1,X.length?j=X.concat(j):Tt=-1,j.length)&&wn()}function wn(){if(!it){var e=bn(ps);it=!0;for(var t=j.length;t;){for(X=j,j=[];++Tt<t;)X&&X[Tt].run();Tt=-1,t=j.length}X=null,it=!1,function(e){if(F===clearTimeout)return clearTimeout(e);if((F===ie||!F)&&clearTimeout)return(F=clearTimeout)(e);try{F(e)}catch{try{return F.call(null,e)}catch{return F.call(this,e)}}}(e)}}function Re(e,t){this.fun=e,this.array=t}function D(){}L.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];j.push(new Re(e,t)),1!==j.length||it||bn(wn)},Re.prototype.run=function(){this.fun.apply(null,this.array)},L.title="browser",L.browser=!0,L.env={},L.argv=[],L.version="",L.versions={},L.on=D,L.addListener=D,L.once=D,L.off=D,L.removeListener=D,L.removeAllListeners=D,L.emit=D,L.prependListener=D,L.prependOnceListener=D,L.listeners=function(e){return[]},L.binding=function(e){throw new Error("process.binding is not supported")},L.cwd=function(){return"/"},L.chdir=function(e){throw new Error("process.chdir is not supported")},L.umask=function(){return 0};let It=fs(_n.exports);var ms=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function et(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Pe,Be,re={exports:{}};function ys(){if(Be)return Pe;Be=1;var i=1e3,r=60*i,o=60*r,a=24*o,h=7*a,d=365.25*a;function l(e,t,n,s){t=1.5*n<=t;return Math.round(e/n)+" "+s+(t?"s":"")}return Pe=function(e,t){t=t||{};var n=typeof e;if(!("string"==n&&0<e.length)){if("number"==n&&isFinite(e))return t.long?(n=e,t=Math.abs(n),a<=t?l(n,t,a,"day"):o<=t?l(n,t,o,"hour"):r<=t?l(n,t,r,"minute"):i<=t?l(n,t,i,"second"):n+" ms"):(t=e,n=Math.abs(t),a<=n?Math.round(t/a)+"d":o<=n?Math.round(t/o)+"h":r<=n?Math.round(t/r)+"m":i<=n?Math.round(t/i)+"s":t+"ms");throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}n=void 0;if(!(100<(n=String(e)).length)){n=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(n){var s=parseFloat(n[1]);switch((n[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return s*d;case"weeks":case"week":case"w":return s*h;case"days":case"day":case"d":return s*a;case"hours":case"hour":case"hrs":case"hr":case"h":return s*o;case"minutes":case"minute":case"mins":case"min":case"m":return s*r;case"seconds":case"second":case"secs":case"sec":case"s":return s*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}}}}var _s=function(t){function a(e){let n,t,s,i=null;function o(...r){if(o.enabled){let s=o,e=Number(new Date),t=e-(n||e),i=(s.diff=t,s.prev=n,s.curr=e,n=e,r[0]=a.coerce(r[0]),"string"!=typeof r[0]&&r.unshift("%O"),0);r[0]=r[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";i++;var n,t=a.formatters[t];return"function"==typeof t&&(n=r[i],e=t.call(s,n),r.splice(i,1),i--),e}),a.formatArgs.call(s,r),(s.log||a.log).apply(s,r)}}return o.namespace=e,o.useColors=a.useColors(),o.color=a.selectColor(e),o.extend=r,o.destroy=a.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==i?i:(t!==a.namespaces&&(t=a.namespaces,s=a.enabled(e)),s),set:e=>{i=e}}),"function"==typeof a.init&&a.init(o),o}function r(e,t){t=a(this.namespace+(void 0===t?":":t)+e);return t.log=this.log,t}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return((a.debug=a).default=a).coerce=function(e){return e instanceof Error?e.stack||e.message:e},a.disable=function(){var e=[...a.names.map(n),...a.skips.map(n).map(e=>"-"+e)].join(",");return a.enable(""),e},a.enable=function(e){let t;a.save(e),a.namespaces=e,a.names=[],a.skips=[];var n=("string"==typeof e?e:"").split(/[\s,]+/),s=n.length;for(t=0;t<s;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?a.skips.push(new RegExp("^"+e.slice(1)+"$")):a.names.push(new RegExp("^"+e+"$")))},a.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=a.skips.length;t<n;t++)if(a.skips[t].test(e))return!1;for(t=0,n=a.names.length;t<n;t++)if(a.names[t].test(e))return!0;return!1},a.humanize=ys(),a.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach(e=>{a[e]=t[e]}),a.names=[],a.skips=[],a.formatters={},a.selectColor=function(t){let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n|=0;return a.colors[Math.abs(n)%a.colors.length]},a.enable(a.load()),a},Sn=(((t,n)=>{n.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),this.useColors){var s="color: "+this.color;e.splice(1,0,s,"color: inherit");let t=0,n=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e)&&(n=t)}),e.splice(n,0,s)}},n.save=function(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch{}},n.load=function(){let e;try{e=n.storage.getItem("debug")}catch{}return e=!e&&void 0!==It&&"env"in It?It.env.DEBUG:e},n.useColors=function(){if(typeof window<"u"&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&31<=parseInt(e[1],10)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage=(()=>{try{return localStorage}catch{}})(),n.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),t.exports=_s(n),t.exports.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}})(re,re.exports),re.exports);let O=et(Sn);var oe={exports:{}},rt="object"==typeof Reflect?Reflect:null,qe=rt&&"function"==typeof rt.apply?rt.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},vn=rt&&"function"==typeof rt.ownKeys?rt.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)},Oe=Number.isNaN||function(e){return e!=e};function v(){v.init.call(this)}oe.exports=v,oe.exports.once=function(i,r){return new Promise(function(e,t){function n(e){i.removeListener(r,s),t(e)}function s(){"function"==typeof i.removeListener&&i.removeListener("error",n),e([].slice.call(arguments))}He(i,r,s,{once:!0}),"error"!==r&&"function"==typeof i.on&&He(i,"error",n,{once:!0})})},(v.EventEmitter=v).prototype._events=void 0,v.prototype._eventsCount=0,v.prototype._maxListeners=void 0;var De=10;function Rt(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function Cn(e){return void 0===e._maxListeners?v.defaultMaxListeners:e._maxListeners}function Me(e,t,n,s){var i,r;return Rt(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),r=i[t]),void 0===r?(r=i[t]=n,++e._eventsCount):("function"==typeof r?r=i[t]=s?[n,r]:[r,n]:s?r.unshift(n):r.push(n),0<(i=Cn(e))&&r.length>i&&!r.warned&&(r.warned=!0,(s=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",s.emitter=e,s.type=t,s.count=r.length,console)&&console.warn&&console.warn(s)),e}function bs(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ne(e,t,n){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},t=bs.bind(e);return t.listener=n,e.wrapFn=t}function Ue(e,t,n){e=e._events;if(void 0===e)return[];e=e[t];{if(void 0===e)return[];if("function"==typeof e)return n?[e.listener||e]:[e];if(n){for(var s=e,i=new Array(s.length),r=0;r<i.length;++r)i[r]=s[r].listener||s[r];return i}return Ln(e,e.length)}}function Fe(e){var t=this._events;if(void 0!==t){t=t[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function Ln(e,t){for(var n=new Array(t),s=0;s<t;++s)n[s]=e[s];return n}function He(n,s,i,r){if("function"==typeof n.on)r.once?n.once(s,i):n.on(s,i);else{if("function"!=typeof n.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n);n.addEventListener(s,function e(t){r.once&&n.removeEventListener(s,e),i(t)})}}Object.defineProperty(v,"defaultMaxListeners",{enumerable:!0,get:function(){return De},set:function(e){if("number"!=typeof e||e<0||Oe(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");De=e}}),v.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},v.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||Oe(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},v.prototype.getMaxListeners=function(){return Cn(this)},v.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){if((r=0<t.length?t[0]:r)instanceof Error)throw r;s=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw s.context=r,s}var r=i[e];if(void 0===r)return!1;if("function"==typeof r)qe(r,this,t);else for(var o=r.length,a=Ln(r,o),n=0;n<o;++n)qe(a[n],this,t);return!0},v.prototype.addListener=function(e,t){return Me(this,e,t,!1)},v.prototype.on=v.prototype.addListener,v.prototype.prependListener=function(e,t){return Me(this,e,t,!0)},v.prototype.once=function(e,t){return Rt(t),this.on(e,Ne(this,e,t)),this},v.prototype.prependOnceListener=function(e,t){return Rt(t),this.prependListener(e,Ne(this,e,t)),this},v.prototype.removeListener=function(e,t){var n,s,i,r,o;if(Rt(t),void 0!==(s=this._events)&&void 0!==(n=s[e]))if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,r=n.length-1;0<=r;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,i=r;break}if(i<0)return this;if(0===i)n.shift();else{var a=n;var h=i;for(;h+1<a.length;h++)a[h]=a[h+1];a.pop()}1===n.length&&(s[e]=n[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},v.prototype.off=v.prototype.removeListener,v.prototype.removeAllListeners=function(e){var t,n;if(void 0!==(n=this._events))if(void 0===n.removeListener)0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]);else if(0===arguments.length){for(var s,i=Object.keys(n),r=0;r<i.length;++r)"removeListener"!==(s=i[r])&&this.removeAllListeners(s);this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;0<=r;r--)this.removeListener(e,t[r]);return this},v.prototype.listeners=function(e){return Ue(this,e,!0)},v.prototype.rawListeners=function(e){return Ue(this,e,!1)},v.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Fe.call(e,t)},v.prototype.listenerCount=Fe,v.prototype.eventNames=function(){return 0<this._eventsCount?vn(this._events):[]};var kn=oe.exports;let xn=et(kn);var ae={exports:{}},ws=function e(i,t){if(i&&t)return e(i)(t);if("function"!=typeof i)throw new TypeError("need wrapper function");return Object.keys(i).forEach(function(e){n[e]=i[e]}),n;function n(){for(var e=new Array(arguments.length),t=0;t<e.length;t++)e[t]=arguments[t];var n=i.apply(this,e),s=e[e.length-1];return"function"==typeof n&&n!==s&&Object.keys(s).forEach(function(e){n[e]=s[e]}),n}},$e=ws;function St(e){function t(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))}return t.called=!1,t}function je(e){function t(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)}var n=e.name||"Function wrapped with `once`";return t.onceError=n+" shouldn't be called more than once",t.called=!1,t}ae.exports=$e(St),ae.exports.strict=$e(je),St.proto=St(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return St(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return je(this)},configurable:!0})});let Ss=et(ae.exports),We;var En="function"==typeof queueMicrotask?queueMicrotask.bind(typeof window<"u"?window:ms):e=>(We=We||Promise.resolve()).then(e).catch(e=>setTimeout(()=>{throw e},0));let he=et(En);var vs=function(e,n){let s,i,t,r=!0;function o(e){function t(){n&&n(e,s),n=null}r?Cs(t):t()}function a(e,t,n){s[e]=n,0!=--i&&!t||o(t)}(i=(Array.isArray(e)?(s=[],e):(t=Object.keys(e),s={},t)).length)?t?t.forEach(function(n){e[n](function(e,t){a(n,e,t)})}):e.forEach(function(e,n){e(function(e,t){a(n,e,t)})}):o(null),r=!1};let Cs=En,Ls=et(vs),W=typeof window<"u"?window:self,ce=W.RTCPeerConnection||W.mozRTCPeerConnection||W.webkitRTCPeerConnection,ks=W.RTCSessionDescription||W.mozRTCSessionDescription||W.webkitRTCSessionDescription,xs=W.RTCIceCandidate||W.mozRTCIceCandidate||W.webkitRTCIceCandidate;var Es="function"==typeof queueMicrotask?queueMicrotask:e=>Promise.resolve().then(e);let Qe=class{constructor(e){if(!(0<e)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){var e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return void 0===this.buffer[this.btm]}};var de={exports:{}};function ze(e){return e.length}var As={byteLength:ze,toString:function(t){var n=t.byteLength;let s="";for(let e=0;e<n;e++)s+=String.fromCharCode(t[e]);return s},write:function(t,n,s=0,e=ze(n)){var i=Math.min(e,t.byteLength-s);for(let e=0;e<i;e++)t[s+e]=n.charCodeAt(e);return i}};let lt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Z=new Uint8Array(256);for(let e=0;e<64;e++)Z[lt.charCodeAt(e)]=e;function Ve(e){let t=e.length;return 61===e.charCodeAt(t-1)&&t--,1<t&&61===e.charCodeAt(t-1)&&t--,3*t>>>2}Z[45]=62,Z[95]=63;var Ts={byteLength:Ve,toString:function(t){var n=t.byteLength;let s="";for(let e=0;e<n;e+=3)s+=lt[t[e]>>2]+lt[(3&t[e])<<4|t[e+1]>>4]+lt[(15&t[e+1])<<2|t[e+2]>>6]+lt[63&t[e+2]];return n%3==2?s=s.substring(0,s.length-1)+"=":n%3==1&&(s=s.substring(0,s.length-2)+"=="),s},write:function(n,s,e=0,t=Ve(s)){var i=Math.min(t,n.byteLength-e);for(let e=0,t=0;t<i;e+=4){var r=Z[s.charCodeAt(e)],o=Z[s.charCodeAt(e+1)],a=Z[s.charCodeAt(e+2)],h=Z[s.charCodeAt(e+3)];n[t++]=r<<2|o>>4,n[t++]=(15&o)<<4|a>>2,n[t++]=(3&a)<<6|63&h}return i}};function Ge(e){return e.length>>>1}var Is={byteLength:Ge,toString:function(e){var t=e.byteLength;e=new DataView(e.buffer,e.byteOffset,t);let n="",s=0;for(var i=t-t%4;s<i;s+=4)n+=e.getUint32(s).toString(16).padStart(8,"0");for(;s<t;s++)n+=e.getUint8(s).toString(16).padStart(2,"0");return n},write:function(t,n,s=0,e=Ge(n)){var i=Math.min(e,t.byteLength-s);for(let e=0;e<i;e++){var r=Je(n.charCodeAt(2*e)),o=Je(n.charCodeAt(2*e+1));if(void 0===r||void 0===o)return t.subarray(0,e);t[s+e]=r<<4|o}return i}};function Je(e){return 48<=e&&e<=57?e-48:65<=e&&e<=70?e-65+10:97<=e&&e<=102?e-97+10:void 0}function le(n){let s=0;for(let e=0,t=n.length;e<t;e++){var i=n.charCodeAt(e);if(55296<=i&&i<=56319&&e+1<t){var r=n.charCodeAt(e+1);if(56320<=r&&r<=57343){s+=4,e++;continue}}s+=i<=127?1:i<=2047?2:3}return s}let ue,ge;if(typeof TextDecoder<"u"){let t=new TextDecoder;ue=function(e){return t.decode(e)}}else ue=function(i){var e=i.byteLength;let r="",o=0;for(;o<e;){let s=i[o];if(s<=127)r+=String.fromCharCode(s),o++;else{let t=0,n=0;if(s<=223?(t=1,n=31&s):s<=239?(t=2,n=15&s):s<=244&&(t=3,n=7&s),0<e-o-t){let e=0;for(;e<t;)s=i[o+e+1],n=n<<6|63&s,e+=1}else n=65533,t=e-o;r+=String.fromCodePoint(n),o+=t+1}}return r};if(typeof TextEncoder<"u"){let i=new TextEncoder;ge=function(e,t,n=0,s=le(t)){s=Math.min(s,e.byteLength-n);return i.encodeInto(t,e.subarray(n,n+s)),s}}else ge=function(n,e,t=0,s=le(e)){s=Math.min(s,n.byteLength-t);n=n.subarray(t,t+s);let i=0,r=0;for(;i<e.length;){var o=e.codePointAt(i);if(o<=127)n[r++]=o,i++;else{let e=0,t=0;for(o<=2047?(e=6,t=192):o<=65535?(e=12,t=224):o<=2097151&&(e=18,t=240),n[r++]=t|o>>e,e-=6;0<=e;)n[r++]=128|o>>e&63,e-=6;i+=65536<=o?2:1}}return s};var Rs={byteLength:le,toString:ue,write:ge};function Ye(e){return 2*e.length}var Ps={byteLength:Ye,toString:function(t){var n=t.byteLength;let s="";for(let e=0;e<n-1;e+=2)s+=String.fromCharCode(t[e]+256*t[e+1]);return s},write:function(t,n,s=0,e=Ye(n)){e=Math.min(e,t.byteLength-s);let i=e;for(let e=0;e<n.length&&!((i-=2)<0);++e){var r=n.charCodeAt(e),o=r>>8;t[s+2*e]=r%256,t[s+2*e+1]=o}return e}},An=(((e,s)=>{let t=As,n=Ts,i=Is,r=Rs,o=Ps,a=255===new Uint8Array(Uint16Array.of(255).buffer)[0];function h(e){switch(e){case"ascii":return t;case"base64":return n;case"hex":return i;case"utf8":case"utf-8":case void 0:return r;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return o;default:throw new Error("Unknown encoding: "+e)}}function d(e){return e instanceof Uint8Array}function l(e,t,n){return"string"==typeof e?(i=e,r=h(t),o=new Uint8Array(r.byteLength(i)),r.write(o,i,0,o.byteLength),o):Array.isArray(e)?(r=e,(i=new Uint8Array(r.length)).set(r),i):ArrayBuffer.isView(e)?(o=e,(s=new Uint8Array(o.byteLength)).set(o),s):new Uint8Array(e,t,n);var s,i,r,o}function u(s,i,r,e,t){if(0!==s.byteLength){if("string"==typeof r?(e=r,r=0):void 0===r?r=t?0:s.length-1:r<0&&(r+=s.byteLength),s.byteLength<=r){if(t)return-1;r=s.byteLength-1}else if(r<0){if(!t)return-1;r=0}if("string"==typeof i)i=l(i,e);else if("number"==typeof i)return i&=255,t?s.indexOf(i,r):s.lastIndexOf(i,r);if(0!==i.byteLength)if(t){let t=-1;for(let e=r;e<s.byteLength;e++)if(s[e]===i[-1===t?0:e-t]){if(-1===t&&(t=e),e-t+1===i.byteLength)return t}else-1!==t&&(e-=e-t),t=-1}else for(let n=r=r+i.byteLength>s.byteLength?s.byteLength-i.byteLength:r;0<=n;n--){let t=!0;for(let e=0;e<i.byteLength;e++)if(s[n+e]!==i[e]){t=!1;break}if(t)return n}}return-1}function c(e,t,n,s){return u(e,t,n,s,!0)}function p(e,t,n){var s=e[t];e[t]=e[n],e[n]=s}e.exports=s={isBuffer:d,isEncoding:function(e){try{return h(e),!0}catch{return!1}},alloc:function(e,t,n){e=new Uint8Array(e);return void 0!==t&&s.fill(e,t,0,e.byteLength,n),e},allocUnsafe:function(e){return new Uint8Array(e)},allocUnsafeSlow:function(e){return new Uint8Array(e)},byteLength:function(e,t){return h(t).byteLength(e)},compare:function(e,t){if(e===t)return 0;var n=Math.min(e.byteLength,t.byteLength);e=new DataView(e.buffer,e.byteOffset,e.byteLength),t=new DataView(t.buffer,t.byteOffset,t.byteLength);let s=0;for(var i=n-n%4;s<i&&e.getUint32(s,a)===t.getUint32(s,a);s+=4);for(;s<n;s++){var r=e.getUint8(s),o=t.getUint8(s);if(r<o)return-1;if(o<r)return 1}return e.byteLength>t.byteLength?1:e.byteLength<t.byteLength?-1:0},concat:function(e,t){void 0===t&&(t=e.reduce((e,t)=>e+t.byteLength,0));var n,s,i=new Uint8Array(t);let r=0;for(n of e){if(r+n.byteLength>i.byteLength)return s=n.subarray(0,i.byteLength-r),i.set(s,r),i;i.set(n,r),r+=n.byteLength}return i},copy:function(e,t,n=0,s=0,i=e.byteLength){if(0<i&&i<s||i===s||0===e.byteLength||0===t.byteLength)return 0;if(n<0)throw new RangeError("targetStart is out of range");if(s<0||s>=e.byteLength)throw new RangeError("sourceStart is out of range");if(i<0)throw new RangeError("sourceEnd is out of range");n>=t.byteLength&&(n=t.byteLength),i>e.byteLength&&(i=e.byteLength);var r=(i=t.byteLength-n<i-s?t.length-n+s:i)-s;return e===t?t.copyWithin(n,s,i):t.set(e.subarray(s,i),n),r},equals:function(t,n){if(t!==n){if(t.byteLength!==n.byteLength)return!1;var s=t.byteLength;t=new DataView(t.buffer,t.byteOffset,t.byteLength),n=new DataView(n.buffer,n.byteOffset,n.byteLength);let e=0;for(var i=s-s%4;e<i;e+=4)if(t.getUint32(e,a)!==n.getUint32(e,a))return!1;for(;e<s;e++)if(t.getUint8(e)!==n.getUint8(e))return!1}return!0},fill:function(t,n,s,i,e){if("string"==typeof n?"string"==typeof s?(e=s,s=0,i=t.byteLength):"string"==typeof i&&(e=i,i=t.byteLength):"number"==typeof n?n&=255:"boolean"==typeof n&&(n=+n),s<0||t.byteLength<s||t.byteLength<i)throw new RangeError("Out of range index");if(!((i=void 0===i?t.byteLength:i)<=(s=void 0===s?0:s)))if("number"==typeof(n=n||0))for(let e=s;e<i;++e)t[e]=n;else{var r=(n=d(n)?n:l(n,e)).byteLength;for(let e=0;e<i-s;++e)t[e+s]=n[e%r]}return t},from:l,includes:function(e,t,n,s){return-1!==c(e,t,n,s)},indexOf:c,lastIndexOf:function(e,t,n,s){return u(e,t,n,s,!1)},swap16:function(t){var n=t.byteLength;if(n%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<n;e+=2)p(t,e,e+1);return t},swap32:function(t){var n=t.byteLength;if(n%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<n;e+=4)p(t,e,e+3),p(t,e+1,e+2);return t},swap64:function(t){var n=t.byteLength;if(n%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<n;e+=8)p(t,e,e+7),p(t,e+1,e+6),p(t,e+2,e+5),p(t,e+3,e+4);return t},toBuffer:function(e){return e},toString:function(e,t,n=0,s=e.byteLength){var i=e.byteLength;return i<=n||s<=n?"":(i<s&&(s=i),(0!==(n=n<0?0:n)||s<i)&&(e=e.subarray(n,s)),h(t).toString(e))},write:function(e,t,n,s,i){return void 0===n?i="utf8":void 0===s&&"string"==typeof n?(i=n,n=void 0):void 0===i&&"string"==typeof s&&(i=s,s=void 0),h(i).write(e,t,n,s)},writeDoubleLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat64(n,t,!0),n+8},writeFloatLE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setFloat32(n,t,!0),n+4},writeUInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setUint32(n,t,!0),n+4},writeInt32LE:function(e,t,n){return void 0===n&&(n=0),new DataView(e.buffer,e.byteOffset,e.byteLength).setInt32(n,t,!0),n+4},readDoubleLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat64(t,!0)},readFloatLE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getFloat32(t,!0)},readUInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(t,!0)},readInt32LE:function(e,t){return void 0===t&&(t=0),new DataView(e.buffer,e.byteOffset,e.byteLength).getInt32(t,!0)}}})(de,de.exports),de.exports);let Bs=An,qs=An,Os=class{constructor(e){this.encoding=e}decode(e){return Bs.toString(e,this.encoding)}flush(){return""}},Ds=class{constructor(){this.codePoint=0,this.bytesSeen=0,this.bytesNeeded=0,this.lowerBoundary=128,this.upperBoundary=191}decode(s){if(0===this.bytesNeeded){let n=!0;for(let e=Math.max(0,s.byteLength-4),t=s.byteLength;e<t&&n;e++)n=s[e]<=127;if(n)return qs.toString(s,"utf8")}let n="";for(let e=0,t=s.byteLength;e<t;e++){var i=s[e];0!==this.bytesNeeded?i<this.lowerBoundary||i>this.upperBoundary?(this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,n+="�"):(this.lowerBoundary=128,this.upperBoundary=191,this.codePoint=this.codePoint<<6|63&i,this.bytesSeen++,this.bytesSeen===this.bytesNeeded&&(n+=String.fromCodePoint(this.codePoint),this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0)):i<=127?n+=String.fromCharCode(i):194<=i&&i<=223?(this.bytesNeeded=1,this.codePoint=31&i):224<=i&&i<=239?(224===i?this.lowerBoundary=160:237===i&&(this.upperBoundary=159),this.bytesNeeded=2,this.codePoint=15&i):240<=i&&i<=244?(240===i&&(this.lowerBoundary=144),244===i&&(this.upperBoundary=143),this.bytesNeeded=3,this.codePoint=7&i):n+="�"}return n}flush(){var e=0<this.bytesNeeded?"�":"";return this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,e}},Ms=kn.EventEmitter,Ae=new Error("Stream was destroyed"),Tn=(new Error("Premature close"),Es),In=class{constructor(e){this.hwm=e||16,this.head=new Qe(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(e){var t;this.length++,this.head.push(e)||(t=this.head,this.head=t.next=new Qe(2*this.head.buffer.length),this.head.push(e))}shift(){0!==this.length&&this.length--;var e,t=this.tail.shift();return void 0===t&&this.tail.next?(e=this.tail.next,this.tail.next=null,this.tail=e,this.tail.shift()):t}peek(){var e=this.tail.peek();return void 0===e&&this.tail.next?this.tail.next.peek():e}isEmpty(){return 0===this.length}},Ns=class{constructor(e="utf8"){switch(this.encoding=(e=>{switch(e=e.toLowerCase()){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:throw new Error("Unknown encoding: "+e)}})(e),this.encoding){case"utf8":this.decoder=new Ds;break;case"utf16le":case"base64":throw new Error("Unsupported encoding: "+this.encoding);default:this.decoder=new Os(this.encoding)}}push(e){return"string"==typeof e?e:this.decoder.decode(e)}write(e){return this.push(e)}end(e){let t="";return e&&(t=this.push(e)),t+=this.decoder.flush()}},bt=536870911,Rn=1^bt,Us=2^bt,Pn=64,Ke=128,Bn=256,Fs=1024,Xe=2048,Hs=4096,$s=8192,Mt=16384,Jt=32768,fe=131072,js=131328,Ws=16^bt,Ze=768^bt,qn=536838143,Qs=32^bt,On=536739839,Nt=2<<18,Dn=4<<18,tn=8<<18,zs=16<<18,Mn=32<<18,pe=64<<18,Yt=128<<18,en=512<<18,Vs=1024<<18,Nn=469499903,Gs=535822335,Un=503316479,Js=268435455,Ut=262160,Ys=536608751,Fn=8404992,yt=14,Ks=15,Hn=8405006,$n=33587200,jn=33587215,Xs=2359296,nn=270794767,vt=Symbol.asyncIterator||Symbol("asyncIterator");class Zs{constructor(e,{highWaterMark:t=16384,map:n=null,mapWritable:s,byteLength:i,byteLengthWritable:r}={}){this.stream=e,this.queue=new In,this.highWaterMark=t,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=r||i||Vn,this.map=s||n,this.afterWrite=ii.bind(this),this.afterUpdateNextTick=ai.bind(this)}get ended(){return!!(this.stream._duplexState&Mn)}push(e){return null!==this.map&&(e=this.map(e)),this.buffered+=this.byteLength(e),this.queue.push(e),this.buffered<this.highWaterMark?(this.stream._duplexState|=tn,!0):(this.stream._duplexState|=6291456,!1)}shift(){var e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=534773759),e}end(e){"function"==typeof e?this.stream.once("finish",e):null!=e&&this.push(e),this.stream._duplexState=(this.stream._duplexState|en)&Gs}autoBatch(e,t){var n=[],s=this.stream;for(n.push(e);(s._duplexState&nn)===Xs;)n.push(s._writableState.shift());if(s._duplexState&Ks)return t(null);s._writev(n,t)}update(){var e=this.stream;e._duplexState|=Nt;do{for(;(e._duplexState&nn)===tn;){var t=this.shift();e._duplexState|=67371008,e._write(t,this.afterWrite)}}while(1310720&e._duplexState||this.updateNonPrimary(),!0===this.continueUpdate());e._duplexState&=536346623}updateNonPrimary(){var e=this.stream;(144965647&e._duplexState)===en?(e._duplexState=402653183&e._duplexState|262144,e._final(si.bind(this))):4!=(e._duplexState&yt)?1==(e._duplexState&jn)&&(e._duplexState=(e._duplexState|Ut)&Rn,e._open(Qn.bind(this))):e._duplexState&$n||(e._duplexState|=Ut,e._destroy(Wn.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&Yt)&&(this.stream._duplexState&=Un,!0)}updateCallback(){(35127311&this.stream._duplexState)===Dn?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&Yt||(this.stream._duplexState|=Yt,this.stream._duplexState&Nt)||Tn(this.afterUpdateNextTick)}}class ti{constructor(e,{highWaterMark:t=16384,map:n=null,mapReadable:s,byteLength:i,byteLengthReadable:r}={}){this.stream=e,this.queue=new In,this.highWaterMark=0===t?1:t,this.buffered=0,this.readAhead=0<t,this.error=null,this.pipeline=null,this.byteLength=r||i||Vn,this.map=s||n,this.pipeTo=null,this.afterRead=ri.bind(this),this.afterUpdateNextTick=oi.bind(this)}get ended(){return!!(this.stream._duplexState&Mt)}pipe(e,t){if(null!==this.pipeTo)throw new Error("Can only pipe to one destination");var n;"function"!=typeof t&&(t=null),this.stream._duplexState|=512,this.pipeTo=e,this.pipeline=new ei(this.stream,e,t),t&&this.stream.on("error",sn),zn(e)?(e._writableState.pipeline=this.pipeline,t&&e.on("error",sn)):(t=this.pipeline.done.bind(this.pipeline,e),n=this.pipeline.done.bind(this.pipeline,e,null),e.on("error",t),e.on("close",n)),e.on("finish",this.pipeline.finished.bind(this.pipeline)),e.on("drain",ni.bind(this)),this.stream.emit("piping",e),e.emit("pipe",this.stream)}push(e){var t=this.stream;return null===e?(this.highWaterMark=0,t._duplexState=536805311&t._duplexState|1024,!1):(null!==this.map&&null===(e=this.map(e))||(this.buffered+=this.byteLength(e),this.queue.push(e),t._duplexState=536805375&t._duplexState|128),this.buffered<this.highWaterMark)}shift(){var e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=536862591),e}unshift(e){for(var t=[null!==this.map?this.map(e):e];0<this.buffered;)t.push(this.shift());for(let e=0;e<t.length-1;e++){var n=t[e];this.buffered+=this.byteLength(n),this.queue.push(n)}this.push(t[t.length-1])}read(){var e,t=this.stream;return(16527&t._duplexState)===Ke?(e=this.shift(),null!==this.pipeTo&&!1===this.pipeTo.write(e)&&(t._duplexState&=Ze),t._duplexState&Xe&&t.emit("data",e),e):(!1===this.readAhead&&(t._duplexState|=fe,this.updateNextTick()),null)}drain(){for(var e=this.stream;(16527&e._duplexState)===Ke&&768&e._duplexState;){var t=this.shift();null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=Ze),e._duplexState&Xe&&e.emit("data",t)}}update(){var e=this.stream;e._duplexState|=32;do{for(this.drain();this.buffered<this.highWaterMark&&(214047&e._duplexState)===fe;)e._duplexState|=65552,e._read(this.afterRead),this.drain()}while(4224==(12431&e._duplexState)&&(e._duplexState|=$s,e.emit("readable")),80&e._duplexState||this.updateNonPrimary(),!0===this.continueUpdate());e._duplexState&=Qs}updateNonPrimary(){var e=this.stream;(1167&e._duplexState)===Fs&&(e._duplexState=536869887&e._duplexState|16384,e.emit("end"),(e._duplexState&Hn)===Fn&&(e._duplexState|=4),null!==this.pipeTo)&&this.pipeTo.end(),4!=(e._duplexState&yt)?1==(e._duplexState&jn)&&(e._duplexState=(e._duplexState|Ut)&Rn,e._open(Qn.bind(this))):e._duplexState&$n||(e._duplexState|=Ut,e._destroy(Wn.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&Jt)&&(this.stream._duplexState&=qn,!0)}updateCallback(){(32879&this.stream._duplexState)===Pn?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&Jt||(this.stream._duplexState|=Jt,32&this.stream._duplexState)||Tn(this.afterUpdateNextTick)}}class ei{constructor(e,t,n){this.from=e,this.to=t,this.afterPipe=n,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(e,t){t&&(this.error=t),e!==this.to||(this.to=null)===this.from?e!==this.from||(this.from=null)===this.to?(null!==this.afterPipe&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null):e._duplexState&Mt||this.to.destroy(this.error||new Error("Readable stream closed before ending")):this.from._duplexState&Mt&&this.pipeToFinished||this.from.destroy(this.error||new Error("Writable stream closed prematurely"))}}function ni(){this.stream._duplexState|=512,this.updateCallback()}function si(e){var t=this.stream;e&&t.destroy(e),t._duplexState&yt||(t._duplexState|=Mn,t.emit("finish")),(t._duplexState&Hn)===Fn&&(t._duplexState|=4),t._duplexState&=Nn,t._duplexState&Nt?this.updateNextTick():this.update()}function Wn(e){var t=this.stream,n=((e=e||this.error===Ae?e:this.error)&&t.emit("error",e),t._duplexState|=8,t.emit("close"),t._readableState),s=t._writableState;if(null!==n&&null!==n.pipeline&&n.pipeline.done(t,e),null!==s){for(;null!==s.drains&&0<s.drains.length;)s.drains.shift().resolve(!1);null!==s.pipeline&&s.pipeline.done(t,e)}}function ii(e){var t=this.stream;if(e&&t.destroy(e),t._duplexState&=Nn,null!==this.drains){var n=this.drains;for(let e=0;e<n.length;e++)0==--n[e].writes&&(n.shift().resolve(!0),e--)}(6553615&t._duplexState)===zs&&(t._duplexState&=532676607,(t._duplexState&pe)===pe)&&t.emit("drain"),this.updateCallback()}function ri(e){e&&this.stream.destroy(e),this.stream._duplexState&=Ws,!1!==this.readAhead||this.stream._duplexState&Bn||(this.stream._duplexState&=On),this.updateCallback()}function oi(){32&this.stream._duplexState||(this.stream._duplexState&=qn,this.update())}function ai(){this.stream._duplexState&Nt||(this.stream._duplexState&=Un,this.update())}function Qn(e){var t=this.stream;e&&t.destroy(e),4&t._duplexState||(17423&t._duplexState||(t._duplexState|=Pn),142606351&t._duplexState||(t._duplexState|=Dn),t.emit("open")),t._duplexState&=Ys,null!==t._writableState&&t._writableState.updateCallback(),null!==t._readableState&&t._readableState.updateCallback()}function hi(e){null!==this._readableState&&("data"===e&&(this._duplexState|=133376,this._readableState.updateNextTick()),"readable"===e)&&(this._duplexState|=Hs,this._readableState.updateNextTick()),null!==this._writableState&&"drain"===e&&(this._duplexState|=pe,this._writableState.updateNextTick())}class ci extends Ms{constructor(e){super(),this._duplexState=0,this._readableState=null,this._writableState=null,e&&(e.open&&(this._open=e.open),e.destroy&&(this._destroy=e.destroy),e.predestroy&&(this._predestroy=e.predestroy),e.signal)&&e.signal.addEventListener("abort",gi.bind(this)),this.on("newListener",hi)}_open(e){e(null)}_destroy(e){e(null)}_predestroy(){}get readable(){return null!==this._readableState||void 0}get writable(){return null!==this._writableState||void 0}get destroyed(){return!!(8&this._duplexState)}get destroying(){return!!(this._duplexState&yt)}destroy(e){this._duplexState&yt||(e=e||Ae,this._duplexState=535822271&this._duplexState|4,null!==this._readableState&&(this._readableState.highWaterMark=0,this._readableState.error=e),null!==this._writableState&&(this._writableState.highWaterMark=0,this._writableState.error=e),this._duplexState|=2,this._predestroy(),this._duplexState&=Us,null!==this._readableState&&this._readableState.updateNextTick(),null!==this._writableState&&this._writableState.updateNextTick())}}class Ft extends ci{constructor(e){super(e),this._duplexState|=8519681,this._readableState=new ti(this,e),e&&(!1===this._readableState.readAhead&&(this._duplexState&=On),e.read&&(this._read=e.read),e.eagerOpen&&this._readableState.updateNextTick(),e.encoding)&&this.setEncoding(e.encoding)}setEncoding(e){let t=new Ns(e),n=this._readableState.map||li;return this._readableState.map=function(e){e=t.push(e);return""===e?null:n(e)},this}_read(e){e(null)}pipe(e,t){return this._readableState.updateNextTick(),this._readableState.pipe(e,t),e}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(e){return this._readableState.updateNextTick(),this._readableState.push(e)}unshift(e){return this._readableState.updateNextTick(),this._readableState.unshift(e)}resume(){return this._duplexState|=js,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=!1===this._readableState.readAhead?536739583:536870655,this}static _fromAsyncIterator(t,e){let n,s=new Ft({...e,read(e){t.next().then(i).then(e.bind(null,null)).catch(e)},predestroy(){n=t.return()},destroy(e){if(!n)return e(null);n.then(e.bind(null,null)).catch(e)}});return s;function i(e){e.done?s.push(null):s.push(e.value)}}static from(t,e){if(zn(n=t)&&n.readable)return t;var n;if(t[vt])return this._fromAsyncIterator(t[vt](),e);Array.isArray(t)||(t=void 0===t?[]:[t]);let s=0;return new Ft({...e,read(e){this.push(s===t.length?null:t[s++]),e(null)}})}static isBackpressured(e){return!!(17422&e._duplexState)||e._readableState.buffered>=e._readableState.highWaterMark}static isPaused(e){return!(e._duplexState&Bn)}[vt](){let s=this,t=null,n=null,i=null;return this.on("error",e=>{t=e}),this.on("readable",function(){null!==n&&r(s.read())}),this.on("close",function(){null!==n&&r(null)}),{[vt](){return this},next:()=>new Promise(function(e,t){n=e,i=t;e=s.read();null!==e?r(e):8&s._duplexState&&r(null)}),return:()=>o(null),throw:e=>o(e)};function r(e){null!==i&&(t?i(t):null!==e||s._duplexState&Mt?n({value:e,done:null===e}):i(Ae),i=n=null)}function o(n){return s.destroy(n),new Promise((e,t)=>{if(8&s._duplexState)return e({value:void 0,done:!0});s.once("close",function(){n?t(n):e({value:void 0,done:!0})})})}}}class di extends Ft{constructor(e){super(e),this._duplexState=1|this._duplexState&fe,this._writableState=new Zs(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final)&&(this._final=e.final)}cork(){this._duplexState|=Vs}uncork(){this._duplexState&=Js,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}function li(e){return e}function ui(e){return!!e._readableState||!!e._writableState}function zn(e){return"number"==typeof e._duplexState&&ui(e)}function Vn(e){return"object"==typeof e&&null!==e&&"number"==typeof e.byteLength?e.byteLength:1024}function sn(){}function gi(){this.destroy(new Error("Stream aborted."))}var Gn=di;function rn(e,t){for(var n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}let C=et(function(e,t,n){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");n=n||{},"object"==typeof t&&(n=t,t=""),t&&(n.code=t);try{return rn(e,n)}catch{n.message=e.message,n.stack=e.stack;t=function(){};return t.prototype=Object.create(Object.getPrototypeOf(e)),rn(new t,n)}}),Ht="0123456789abcdef",Jn=[],$t=[];for(let e=0;e<256;e++)Jn[e]=Ht[e>>4&15]+Ht[15&e],e<16&&(e<10?$t[48+e]=e:$t[87+e]=e);let ht=e=>{var t=e.length;let n="",s=0;for(;s<t;)n+=Jn[e[s++]];return n},me=e=>{var t=e.length>>1,n=t<<1,s=new Uint8Array(t);let i=0,r=0;for(;r<n;)s[i++]=$t[e.charCodeAt(r++)]<<4|$t[e.charCodeAt(r++)];return s};for(var fi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",pi="u"<typeof Uint8Array?[]:new Uint8Array(256),Ct=0;Ct<64;Ct++)pi[fi.charCodeAt(Ct)]=Ct;let mi=new TextDecoder,Yn=(e,t)=>mi.decode(e),yi=new TextEncoder,Te=e=>yi.encode(e),nt=e=>{let t,n="",s=0;for(var i=e.length;s<i;)t=e.charCodeAt(s++),n+=Ht[t>>4]+Ht[15&t];return n},pt=e=>{var t=me(e);if(t.length<=65536)return String.fromCharCode(...t);let n="",s=0;for(;s<t.length;)n+=String.fromCharCode(...t.subarray(s,s+=65536));return n},on=typeof window<"u"?window:self,ye=on.crypto||on.msCrypto||{},jt=(ye.subtle||ye.webkitSubtle,e=>{e=new Uint8Array(e);return ye.getRandomValues(e)}),_i=O("simple-peer"),Kt=65536;function an(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}let mt=class Yg extends Gn{constructor(e){if(super(e=Object.assign({allowHalfOpen:!1},e)),p(this,"_pc"),this.__objectMode=!!e.objectMode,this._id=ht(jt(4)).slice(0,7),this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||ht(jt(20)):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||Yg.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},Yg.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this._destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,!ce)throw C("u"<typeof window?new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"):new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new ce(this.config)}catch(e){return void this.__destroy(C(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch(e=>{this.__destroy(C(e,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof e)try{e=JSON.parse(e)}catch{e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new ks(e)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(e=>{this._addIceCandidate(e)}),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())}).catch(e=>{this.__destroy(C(e,"ERR_SET_REMOTE_DESCRIPTION"))}),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.__destroy(C(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){let t=new xs(e);this._pc.addIceCandidate(t).catch(e=>{!t.address||t.address.endsWith(".local")?console.warn("Ignoring unsupported ICE candidate."):this.__destroy(C(e,"ERR_ADD_ICE_CANDIDATE"))})}send(e){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}_final(e){this._readableState.ended||this.push(null),e(null)}__destroy(e){this.end(),this._destroy(()=>{},e)}_destroy(e,t){this.destroyed||this._destroying||(this._destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),setTimeout(()=>{if(this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch{}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch{}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),e()},0))}_setupData(e){if(!e.channel)return this.__destroy(C(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=Kt),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()};let t=!(this._channel.onerror=e=>{e=e.error instanceof Error?e.error:new Error(`Datachannel error: ${e.message} ${e.filename}:${e.lineno}:`+e.colno);this.__destroy(C(e,"ERR_DATA_CHANNEL"))});this._closingInterval=setInterval(()=>{t=!(!this._channel||"closing"!==this._channel.readyState||(t&&this._onChannelClose(),0))},5e3)}_write(e,t){if(this.destroyed)return t(C(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(e){return this.__destroy(C(e,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>Kt?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_onFinish(){var e;this.destroyed||(e=()=>{setTimeout(()=>this.__destroy(),1e3)},this._connected?e():this.once("connect",e))}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(t=>{if(!this.destroyed){this.trickle||this.allowHalfTrickle||(t.sdp=an(t.sdp)),t.sdp=this.sdpTransform(t.sdp);let e=()=>{var e;this.destroyed||(e=this._pc.localDescription||t,this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp}))};this._pc.setLocalDescription(t).then(()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch(e=>{this.__destroy(C(e,"ERR_SET_LOCAL_DESCRIPTION"))})}}).catch(e=>{this.__destroy(C(e,"ERR_CREATE_OFFER"))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(t=>{if(!this.destroyed){this.trickle||this.allowHalfTrickle||(t.sdp=an(t.sdp)),t.sdp=this.sdpTransform(t.sdp);let e=()=>{var e;this.destroyed||(e=this._pc.localDescription||t,this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp}),this.initiator)||null==(e=this._requestMissingTransceivers)||e.call(this)};this._pc.setLocalDescription(t).then(()=>{this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch(e=>{this.__destroy(C(e,"ERR_SET_LOCAL_DESCRIPTION"))})}}).catch(e=>{this.__destroy(C(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._destroying||"failed"===this._pc.connectionState&&this.__destroy(C(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){var e,t;this.destroyed||(e=this._pc.iceConnectionState,t=this._pc.iceGatheringState,this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.__destroy(C(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.__destroy(C(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED")))}getStats(n){let s=t=>("[object Array]"===Object.prototype.toString.call(t.values)&&t.values.forEach(e=>{Object.assign(t,e)}),t);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then(e=>{let t=[];e.forEach(e=>{t.push(s(e))}),n(null,t)},e=>n(e)):0<this._pc.getStats.length?this._pc.getStats(t=>{if(!this.destroyed){let e=[];t.result().forEach(t=>{let n={};t.names().forEach(e=>{n[e]=t.stat(e)}),n.id=t.id,n.type=t.type,n.timestamp=t.timestamp,e.push(s(n))}),n(null,e)}},e=>n(e)):n(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),!this._connected&&!this._connecting&&this._pcReady&&this._channelReady){this._connecting=!0;let a=()=>{this.destroyed||this._destroying||this.getStats((e,o)=>{if(!this.destroyed&&!this._destroying){let n={},s={},t={},i=!1,r=((o=e?[]:o).forEach(e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(n[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(s[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(t[e.id]=e)}),e=>{i=!0;var t=s[e.localCandidateId],t=(t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4"),n[e.remoteCandidateId]);t&&(t.ip||t.address)?(this.remoteAddress=t.ip||t.address,this.remotePort=Number(t.port)):t&&t.ipAddress?(this.remoteAddress=t.ipAddress,this.remotePort=Number(t.portNumber)):"string"==typeof e.googRemoteAddress&&(t=e.googRemoteAddress.split(":"),this.remoteAddress=t[0],this.remotePort=Number(t[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)});if(o.forEach(e=>{"transport"===e.type&&e.selectedCandidatePairId&&r(t[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&r(e)}),i||Object.keys(t).length&&!Object.keys(s).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.__destroy(C(e,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"'),(0,this._cb)(this._cb=null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref)&&this._interval.unref(),this._debug("connect"),this.emit("connect")}else setTimeout(a,100)}})};a()}}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>Kt||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(t){if(!this.destroyed){let e=t.data;e instanceof ArrayBuffer?e=new Uint8Array(e):!1===this.__objectMode&&(e=Te(e)),this.push(e)}}_onChannelBufferedAmountLow(){!this.destroyed&&this._cb&&(this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount),(0,this._cb)(this._cb=null))}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.__destroy())}_debug(){var e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],_i.apply(null,e)}},q=(mt.WEBRTC_SUPPORT=!!ce,mt.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},mt.channelConfig={},{}),be={DEFAULT_ANNOUNCE_PEERS:50,MAX_ANNOUNCE_PEERS:82,parseUrl:e=>{var t=new URL(e.replace(/^udp:/,"http:"));return e.match(/^udp:/)&&Object.defineProperties(t,{href:{value:t.href.replace(/^http/,"udp")},protocol:{value:t.protocol.replace(/^http/,"udp")},origin:{value:t.origin.replace(/^http/,"udp")}}),t},...Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}))},bi=O("simple-websocket"),ut="function"!=typeof q?WebSocket:q;class Kn extends Gn{constructor(e={}){if("string"==typeof e&&(e={url:e}),super(e=Object.assign({allowHalfOpen:!1},e)),this.__objectMode=!!e.objectMode,null!=e.objectMode&&delete e.objectMode,null==e.url&&null==e.socket)throw new Error("Missing required `url` or `socket` option");if(null!=e.url&&null!=e.socket)throw new Error("Must specify either `url` or `socket` option, not both");if(this._id=ht(jt(4)).slice(0,7),this._debug("new websocket: %o",e),this.connected=!1,this._chunk=null,this._cb=null,this._interval=null,e.socket)this.url=e.socket.url,this._ws=e.socket,this.connected=e.socket.readyState===ut.OPEN;else{this.url=e.url;try{this._ws="function"==typeof q?new ut(e.url,{...e,encoding:void 0}):new ut(e.url)}catch(e){return void he(()=>this.destroy(e))}}this._ws.binaryType="arraybuffer",e.socket&&this.connected?he(()=>this._handleOpen()):this._ws.onopen=()=>this._handleOpen(),this._ws.onmessage=e=>this._handleMessage(e),this._ws.onclose=()=>this._handleClose(),this._ws.onerror=e=>this._handleError(e),this._handleFinishBound=()=>this._handleFinish(),this.once("finish",this._handleFinishBound)}send(e){this._ws.send(e)}_final(e){this._readableState.ended||this.push(null),e(null)}_destroy(e){if(!this.destroyed){if(this._writableState.ended||this.end(),this.connected=!1,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._handleFinishBound&&this.removeListener("finish",this._handleFinishBound),this._handleFinishBound=null,this._ws){let e=this._ws,t=()=>{e.onclose=null};if(e.readyState===ut.CLOSED)t();else try{e.onclose=t,e.close()}catch{t()}e.onopen=null,e.onmessage=null,e.onerror=()=>{}}this._ws=null,e()}}_write(e,t){if(this.destroyed)return t(new Error("cannot write after socket is destroyed"));if(this.connected){try{this.send(e)}catch(e){return this.destroy(e)}"function"!=typeof q&&65536<this._ws.bufferedAmount?(this._debug("start backpressure: bufferedAmount %d",this._ws.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_handleOpen(){if(!this.connected&&!this.destroyed){if(this.connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(e)}this._chunk=null,this._debug('sent chunk from "write before connect"'),(0,this._cb)(this._cb=null)}"function"!=typeof q&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref)&&this._interval.unref(),this._debug("connect"),this.emit("connect")}}_handleMessage(t){if(!this.destroyed){let e=t.data;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),!1===this.__objectMode&&(e=Te(e)),this.push(e)}}_handleClose(){this.destroyed||(this._debug("on close"),this.destroy())}_handleError(e){this.destroy(new Error("Error connecting to "+this.url))}_handleFinish(){var e;this.destroyed||(e=()=>{setTimeout(()=>this.destroy(),1e3)},this.connected?e():this.once("connect",e))}_onInterval(){!this._cb||!this._ws||65536<this._ws.bufferedAmount||(this._debug("ending backpressure: bufferedAmount %d",this._ws.bufferedAmount),(0,this._cb)(this._cb=null))}_debug(){var e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],bi.apply(null,e)}}Kn.WEBSOCKET_SUPPORT=!!ut;class wi extends xn{constructor(e,t){super(),this.client=e,this.announceUrl=t,this.interval=null,this.destroyed=!1}setInterval(e){null==e&&(e=this.DEFAULT_ANNOUNCE_INTERVAL),clearInterval(this.interval),e&&(this.interval=setInterval(()=>{this.announce(this.client._defaultAnnounceOpts())},e),this.interval.unref)&&this.interval.unref()}}let P=O("bittorrent-tracker:websocket-tracker"),M={};class we extends wi{constructor(e,t){super(e,t),P("new websocket tracker %s",t),this.peers={},this.socket=null,this.reconnecting=!1,this.retries=0,this.reconnectTimer=null,this.expectingResponse=!1,this._openSocket()}announce(e){if(!this.destroyed&&!this.reconnecting)if(this.socket.connected){let n=Object.assign({},e,{action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary});if(this._trackerId&&(n.trackerid=this._trackerId),"stopped"===e.event||"completed"===e.event)this._send(n);else{let t=Math.min(e.numwant,5);this._generateOffers(t,e=>{n.numwant=t,n.offers=e,this._send(n)})}}else this.socket.once("connect",()=>{this.announce(e)})}scrape(e){var t;this.destroyed||this.reconnecting||(this.socket.connected?(t={action:"scrape",info_hash:Array.isArray(e.infoHash)&&0<e.infoHash.length?e.infoHash.map(e=>pt(e)):e.infoHash&&pt(e.infoHash)||this.client._infoHashBinary},this._send(t)):this.socket.once("connect",()=>{this.scrape(e)}))}destroy(e=hn){if(this.destroyed)return e(null);for(var t in this.destroyed=!0,clearInterval(this.interval),clearTimeout(this.reconnectTimer),this.peers){t=this.peers[t];clearTimeout(t.trackerTimeout),t.destroy()}if(this.peers=null,this.socket&&(this.socket.removeListener("connect",this._onSocketConnectBound),this.socket.removeListener("data",this._onSocketDataBound),this.socket.removeListener("close",this._onSocketCloseBound),this.socket.removeListener("error",this._onSocketErrorBound),this.socket=null),this._onSocketConnectBound=null,this._onSocketErrorBound=null,this._onSocketDataBound=null,this._onSocketCloseBound=null,M[this.announceUrl]&&--M[this.announceUrl].consumers,0<M[this.announceUrl].consumers)return e();let n,s=M[this.announceUrl];if(delete M[this.announceUrl],s.on("error",hn),s.once("close",e),!this.expectingResponse)return i();function i(){n&&(clearTimeout(n),n=null),s.removeListener("data",i),s.destroy(),s=null}n=setTimeout(i,be.DESTROY_TIMEOUT),s.once("data",i)}_openSocket(){if(this.destroyed=!1,this.peers||(this.peers={}),this._onSocketConnectBound=()=>{this._onSocketConnect()},this._onSocketErrorBound=e=>{this._onSocketError(e)},this._onSocketDataBound=e=>{this._onSocketData(e)},this._onSocketCloseBound=()=>{this._onSocketClose()},this.socket=M[this.announceUrl],this.socket)M[this.announceUrl].consumers+=1,this.socket.connected&&this._onSocketConnectBound();else{var t=new URL(this.announceUrl);let e;this.client._proxyOpts&&!(e="wss:"===t.protocol?this.client._proxyOpts.httpsAgent:this.client._proxyOpts.httpAgent)&&this.client._proxyOpts.socksProxy&&(e=this.client._proxyOpts.socksProxy),this.socket=M[this.announceUrl]=new Kn({url:this.announceUrl,agent:e}),this.socket.consumers=1,this.socket.once("connect",this._onSocketConnectBound)}this.socket.on("data",this._onSocketDataBound),this.socket.once("close",this._onSocketCloseBound),this.socket.once("error",this._onSocketErrorBound)}_onSocketConnect(){this.destroyed||this.reconnecting&&(this.reconnecting=!1,this.retries=0,this.announce(this.client._defaultAnnounceOpts()))}_onSocketData(e){if(!this.destroyed){this.expectingResponse=!1;try{e=JSON.parse(Yn(e))}catch{return void this.client.emit("warning",new Error("Invalid tracker response"))}"announce"===e.action?this._onAnnounceResponse(e):"scrape"===e.action?this._onScrapeResponse(e):this._onSocketError(new Error("invalid action in WS response: "+e.action))}}_onAnnounceResponse(t){if(t.info_hash!==this.client._infoHashBinary)P("ignoring websocket data from %s for %s (looking for %s: reused socket)",this.announceUrl,nt(t.info_hash),this.client.infoHash);else if(!t.peer_id||t.peer_id!==this.client._peerIdBinary){P("received %s from %s for %s",JSON.stringify(t),this.announceUrl,this.client.infoHash);var n=t["failure reason"];if(n)return this.client.emit("warning",new Error(n));var n=t["warning message"],n=(n&&this.client.emit("warning",new Error(n)),t.interval||t["min interval"]),n=(n&&this.setInterval(1e3*n),t["tracker id"]);n&&(this._trackerId=n),null!=t.complete&&(n=Object.assign({},t,{announce:this.announceUrl,infoHash:nt(t.info_hash)}),this.client.emit("update",n));let e;t.offer&&t.peer_id&&(P("creating peer (from remote offer)"),(e=this._createPeer()).id=nt(t.peer_id),e.once("signal",e=>{e={action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary,to_peer_id:t.peer_id,answer:e,offer_id:t.offer_id};this._trackerId&&(e.trackerid=this._trackerId),this._send(e)}),this.client.emit("peer",e),e.signal(t.offer)),t.answer&&t.peer_id&&(n=nt(t.offer_id),(e=this.peers[n])?(e.id=nt(t.peer_id),this.client.emit("peer",e),e.signal(t.answer),clearTimeout(e.trackerTimeout),e.trackerTimeout=null,delete this.peers[n]):P("got unexpected answer: "+JSON.stringify(t.answer)))}}_onScrapeResponse(t){t=t.files||{};var e=Object.keys(t);0!==e.length?e.forEach(e=>{e=Object.assign(t[e],{announce:this.announceUrl,infoHash:nt(e)});this.client.emit("scrape",e)}):this.client.emit("warning",new Error("invalid scrape response"))}_onSocketClose(){this.destroyed||(this.destroy(),this._startReconnectTimer())}_onSocketError(e){this.destroyed||(this.destroy(),this.client.emit("warning",e),this._startReconnectTimer())}_startReconnectTimer(){var e=Math.floor(3e5*Math.random())+Math.min(1e4*Math.pow(2,this.retries),36e5);this.reconnecting=!0,clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{this.retries++,this._openSocket()},e),this.reconnectTimer.unref&&this.reconnectTimer.unref(),P("reconnecting socket in %s ms",e)}_send(e){this.destroyed||(this.expectingResponse=!0,e=JSON.stringify(e),P("send %s",e),this.socket.send(e))}_generateOffers(t,e){let n=this,s=[];P("generating %s offers",t);for(let e=0;e<t;++e)(()=>{let t=ht(jt(20)),e=(P("creating peer (from _generateOffers)"),n.peers[t]=n._createPeer({initiator:!0}));e.once("signal",e=>{s.push({offer:e,offer_id:pt(t)}),i()}),e.trackerTimeout=setTimeout(()=>{P("tracker timeout: destroying peer"),e.trackerTimeout=null,delete n.peers[t],e.destroy()},5e4),e.trackerTimeout.unref&&e.trackerTimeout.unref()})();function i(){s.length===t&&(P("generated %s offers",t),e(s))}i()}_createPeer(e){let t=this,n=(e=Object.assign({trickle:!1,config:t.client._rtcConfig,wrtc:t.client._wrtc},e),new mt(e));return n.once("error",s),n.once("connect",function e(){n.removeListener("error",s),n.removeListener("connect",e)}),n;function s(e){t.client.emit("warning",new Error("Connection error: "+e.message)),n.destroy()}}}function hn(){}we.prototype.DEFAULT_ANNOUNCE_INTERVAL=3e4,we._socketPool=M;let Q=O("bittorrent-tracker:client");class Se extends xn{constructor(e={}){if(super(),!e.peerId)throw new Error("Option `peerId` is required");if(!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");if(!It.browser&&!e.port)throw new Error("Option `port` is required");this.peerId="string"==typeof e.peerId?e.peerId:ht(e.peerId),this._peerIdBuffer=me(this.peerId),this._peerIdBinary=pt(this.peerId),this.infoHash="string"==typeof e.infoHash?e.infoHash.toLowerCase():ht(e.infoHash),this._infoHashBuffer=me(this.infoHash),this._infoHashBinary=pt(this.infoHash),Q("new client %s",this.infoHash),this.destroyed=!1,this._port=e.port,this._getAnnounceOpts=e.getAnnounceOpts,this._rtcConfig=e.rtcConfig,this._userAgent=e.userAgent,this._proxyOpts=e.proxyOpts,this._wrtc="function"==typeof e.wrtc?e.wrtc():e.wrtc;let t="string"==typeof e.announce?[e.announce]:null==e.announce?[]:e.announce,s=(t=t.map(e=>e="/"===(e=ArrayBuffer.isView(e)?Yn(e):e)[e.length-1]?e.substring(0,e.length-1):e),t=Array.from(new Set(t)),!1!==this._wrtc&&(!!this._wrtc||mt.WEBRTC_SUPPORT)),i=e=>{he(()=>{this.emit("warning",e)})};this._trackers=t.map(e=>{let t;try{t=be.parseUrl(e)}catch{return i(new Error("Invalid tracker URL: "+e)),null}var n=t.port;return n<0||65535<n?(i(new Error("Invalid tracker port: "+e)),null):("http:"===(n=t.protocol)||"https:"===n)&&"function"==typeof q||"udp:"===n&&"function"==typeof q?new q(this,e):"ws:"!==n&&"wss:"!==n||!s||"ws:"===n&&typeof window<"u"&&"https:"===window.location.protocol?(i(new Error("Unsupported tracker protocol: "+e)),null):new we(this,e)}).filter(Boolean)}start(e){(e=this._defaultAnnounceOpts(e)).event="started",Q("send `start` %o",e),this._announce(e),this._trackers.forEach(e=>{e.setInterval()})}stop(e){(e=this._defaultAnnounceOpts(e)).event="stopped",Q("send `stop` %o",e),this._announce(e)}complete(e){(e=this._defaultAnnounceOpts(e=e||{})).event="completed",Q("send `complete` %o",e),this._announce(e)}update(e){(e=this._defaultAnnounceOpts(e)).event&&delete e.event,Q("send `update` %o",e),this._announce(e)}_announce(t){this._trackers.forEach(e=>{e.announce(t)})}scrape(t){Q("send `scrape`"),t=t||{},this._trackers.forEach(e=>{e.scrape(t)})}setInterval(t){Q("setInterval %d",t),this._trackers.forEach(e=>{e.setInterval(t)})}destroy(e){var t;this.destroyed||(this.destroyed=!0,Q("destroy"),t=this._trackers.map(t=>e=>{t.destroy(e)}),Ls(t,e),this._trackers=[],this._getAnnounceOpts=null)}_defaultAnnounceOpts(e={}){return null==e.numwant&&(e.numwant=be.DEFAULT_ANNOUNCE_PEERS),null==e.uploaded&&(e.uploaded=0),null==e.downloaded&&(e.downloaded=0),e=this._getAnnounceOpts?Object.assign({},e,this._getAnnounceOpts()):e}}Se.scrape=(e,t)=>{if(t=Ss(t),!e.infoHash)throw new Error("Option `infoHash` is required");if(!e.announce)throw new Error("Option `announce` is required");let n=Object.assign({},e,{infoHash:Array.isArray(e.infoHash)?e.infoHash[0]:e.infoHash,peerId:Te("01234567890123456789"),port:6881}),s=new Se(n),i=(s.once("error",t),s.once("warning",t),Array.isArray(e.infoHash)?e.infoHash.length:1),r={};return s.on("scrape",e=>{--i,r[e.infoHash]=e,0===i&&(s.destroy(),1===(e=Object.keys(r)).length?t(null,r[e[0]]):t(null,r))}),s.scrape({infoHash:e.infoHash}),s};var Xn={exports:{}};function E(e,t,n,s,i,r,o){e=e+(t&n|~t&s)+(i>>>0)+o;return(e<<r|e>>>32-r)+t}function A(e,t,n,s,i,r,o){e=e+(t&s|n&~s)+(i>>>0)+o;return(e<<r|e>>>32-r)+t}function T(e,t,n,s,i,r,o){e=e+(t^n^s)+(i>>>0)+o;return(e<<r|e>>>32-r)+t}function I(e,t,n,s,i,r,o){e=e+(n^(t|~s))+(i>>>0)+o;return(e<<r|e>>>32-r)+t}function Lt(e){return String.fromCharCode(255&e)}function kt(e){return Lt(e)+Lt(e>>>8)+Lt(e>>>16)+Lt(e>>>24)}var ve=function(e){return unescape(encodeURIComponent(e))},Vt=Xn.exports=function(e){return Si(e).toHex()},Pt=Vt.fromBytes=function(e){for(var t=(e=>{for(var t=e.length,n=t<<3,s=new Uint32Array(t+72>>>6<<4),i=0,r=e.length;i<r;++i)s[i>>>2]|=e.charCodeAt(i)<<((3&i)<<3);return s[t>>2]|=128<<(31&n),s[s.length-2]=n,s})(e),n=1732584193,s=4023233417,i=2562383102,r=271733878,o=0,a=t.length;o<a;o+=16){var h=n,d=s,l=i,u=r,n=E(n,s,i,r,t[o+0],7,3614090360),r=E(r,n,s,i,t[o+1],12,3905402710),i=E(i,r,n,s,t[o+2],17,606105819),s=E(s,i,r,n,t[o+3],22,3250441966);n=E(n,s,i,r,t[o+4],7,4118548399),r=E(r,n,s,i,t[o+5],12,1200080426),i=E(i,r,n,s,t[o+6],17,2821735955),s=E(s,i,r,n,t[o+7],22,4249261313),n=E(n,s,i,r,t[o+8],7,1770035416),r=E(r,n,s,i,t[o+9],12,2336552879),i=E(i,r,n,s,t[o+10],17,4294925233),s=E(s,i,r,n,t[o+11],22,2304563134),n=E(n,s,i,r,t[o+12],7,1804603682),r=E(r,n,s,i,t[o+13],12,4254626195),i=E(i,r,n,s,t[o+14],17,2792965006),n=A(n,s=E(s,i,r,n,t[o+15],22,1236535329),i,r,t[o+1],5,4129170786),r=A(r,n,s,i,t[o+6],9,3225465664),i=A(i,r,n,s,t[o+11],14,643717713),s=A(s,i,r,n,t[o+0],20,3921069994),n=A(n,s,i,r,t[o+5],5,3593408605),r=A(r,n,s,i,t[o+10],9,38016083),i=A(i,r,n,s,t[o+15],14,3634488961),s=A(s,i,r,n,t[o+4],20,3889429448),n=A(n,s,i,r,t[o+9],5,568446438),r=A(r,n,s,i,t[o+14],9,3275163606),i=A(i,r,n,s,t[o+3],14,4107603335),s=A(s,i,r,n,t[o+8],20,1163531501),n=A(n,s,i,r,t[o+13],5,2850285829),r=A(r,n,s,i,t[o+2],9,4243563512),i=A(i,r,n,s,t[o+7],14,1735328473),n=T(n,s=A(s,i,r,n,t[o+12],20,2368359562),i,r,t[o+5],4,4294588738),r=T(r,n,s,i,t[o+8],11,2272392833),i=T(i,r,n,s,t[o+11],16,1839030562),s=T(s,i,r,n,t[o+14],23,4259657740),n=T(n,s,i,r,t[o+1],4,2763975236),r=T(r,n,s,i,t[o+4],11,1272893353),i=T(i,r,n,s,t[o+7],16,4139469664),s=T(s,i,r,n,t[o+10],23,3200236656),n=T(n,s,i,r,t[o+13],4,681279174),r=T(r,n,s,i,t[o+0],11,3936430074),i=T(i,r,n,s,t[o+3],16,3572445317),s=T(s,i,r,n,t[o+6],23,76029189),n=T(n,s,i,r,t[o+9],4,3654602809),r=T(r,n,s,i,t[o+12],11,3873151461),i=T(i,r,n,s,t[o+15],16,530742520),n=I(n,s=T(s,i,r,n,t[o+2],23,3299628645),i,r,t[o+0],6,4096336452),r=I(r,n,s,i,t[o+7],10,1126891415),i=I(i,r,n,s,t[o+14],15,2878612391),s=I(s,i,r,n,t[o+5],21,4237533241),n=I(n,s,i,r,t[o+12],6,1700485571),r=I(r,n,s,i,t[o+3],10,2399980690),i=I(i,r,n,s,t[o+10],15,4293915773),s=I(s,i,r,n,t[o+1],21,2240044497),n=I(n,s,i,r,t[o+8],6,1873313359),r=I(r,n,s,i,t[o+15],10,4264355552),i=I(i,r,n,s,t[o+6],15,2734768916),s=I(s,i,r,n,t[o+13],21,1309151649),n=I(n,s,i,r,t[o+4],6,4149444226),r=I(r,n,s,i,t[o+11],10,3174756917),i=I(i,r,n,s,t[o+2],15,718787259),s=I(s,i,r,n,t[o+9],21,3951481745),n=n+h>>>0,s=s+d>>>0,i=i+l>>>0,r=r+u>>>0}var c=new String(kt(n)+kt(s)+kt(i)+kt(r));return c.toHex=function(){for(var e="",t=0,n=c.length;t<n;++t)e+=(256+(255&c.charCodeAt(t))).toString(16).substr(-2);return e},c},Si=Vt.fromUtf8=function(e){return Pt(ve(e))},Zn="./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function cn(e,t){for(var n="";0<=--t;e>>>=6)n+=Zn.charAt(63&e);return n}var xt=[0,6,12,1,7,13,2,8,14,3,9,15,4,10,5,11],vi=Vt.salt=function(e){var t="";for(e=e||8;t+=Zn.charAt(64*Math.random()>>>0),--e;);return t};Vt.crypt=function(e,t){if(64<e.length)throw Error("too long key");t=t||"$1$"+vi(),e=ve(e);for(var n=ve(t.replace(/^\$1\$([^$]+)(?:\$.*)?$/,"$1")),s=Pt(e+n+e),i=e+"$1$"+n,r=e.length;16<r;r-=16)i+=s;for(i+=s.slice(0,r),r=e.length;r;r>>=1)i+=1&r?"\0":e.charAt(0);for(var s=Pt(i),o=0;o<1e3;++o)s=Pt((1&o?e:s)+(o%3?n:"")+(o%7?e:"")+(1&o?s:e));for(var a="$1$"+n+"$",o=0;o<15;o+=3)a+=cn(s.charCodeAt(xt[o+0])<<16|s.charCodeAt(xt[o+1])<<8|s.charCodeAt(xt[o+2]),4);return a+cn(s.charCodeAt(xt[15]),2)};let Ci=et(Xn.exports),Li=`-PM${(()=>{var e="1.0.0".split(".");return""+e[0].padStart(2,"0")+e[1].padStart(2,"0")})()}-`,ki="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";function tt(e){return e.type+"-"+e.index}function dn(e){var t=e.externalId;return`(${tt(e.stream)} | ${t})`}function Ce(e,t){void 0===t&&(t=e.reduce((e,t)=>e+t.byteLength,0));var n,s=new Uint8Array(t);let i=0;for(n of e)s.set(n,i),i+=n.byteLength;return s}function ln(e){var t=new TextEncoder,n=new Uint8Array(e.length);return t.encodeInto(e,n),n}function*un(t){for(let e=t.length-1;0<=e;e--)yield t[e]}function ts(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function ot(e){if(Array.isArray(e))return e.map(e=>ot(e));if(ts(e)){var t,n={};for(t of Object.keys(e))n[t]=ot(e[t]);return n}return e}function dt(s,i,r={}){return"object"==typeof s&&null!==s&&"object"==typeof i&&null!==i&&Object.keys(i).forEach(e=>{if("__proto__"===e||"constructor"===e||"prototype"===e)throw new Error(`Attempt to modify restricted property '${String(e)}'`);var t=i[e],n=r[e];e in s&&(s[e]=void 0===t?void 0===n?void 0:n:t)}),s}function Xt(e){let{defaultConfig:t,baseConfig:n={},specificStreamConfig:s={}}=e,i=ot({...t,...n,...s}),r=Object.keys(t),o={};return r.forEach(e=>{e in i&&(o[e]=i[e])}),o}var V=(e=>(e[e.SegmentsAnnouncement=0]="SegmentsAnnouncement",e[e.SegmentRequest=1]="SegmentRequest",e[e.SegmentData=2]="SegmentData",e[e.SegmentDataSendingCompleted=3]="SegmentDataSendingCompleted",e[e.SegmentAbsent=4]="SegmentAbsent",e[e.CancelSegmentRequest=5]="CancelSegmentRequest",e))(V||{}),at=(e=>(e[e.Min=-1]="Min",e[e.Int=0]="Int",e[e.SimilarIntArray=1]="SimilarIntArray",e[e.String=2]="String",e[e.Max=3]="Max",e))(at||{});function xi(t){var e,n,s=t<0,i=(n=(e=t).toString(2),e=e<0?n.length:n.length+1,Math.ceil(e/8)),r=new Uint8Array(i),o=BigInt(i);t=t<0?-t:t;for(let e=0;e<i;e++){var a=t>>8n*(o-1n-BigInt(e))&0xffn;r[e]=Number(a)}return s&&(r[0]=128|r[0]),r}function Ei(t){let n=BigInt(t.length),s=(e,t)=>{t=8n*(n-1n-BigInt(t));return BigInt(e)<<t},i=s(127&t[0],0);for(let e=1;e<n;e++)i=s(t[e],e)|i;return i=(128&t[0])>>7?-i:i}function gn(e){var e=xi(e),t=0|e.length;return new Uint8Array([t,...e])}function es(e){var t=e[0];if(t>>4)throw new Error("Trying to deserialize integer with invalid serialized item code");t&=15;return{number:Ei(e.slice(1,1+t)),byteLength:1+t}}function Ai(t){var[e,n]=t;if(e>>4!=1)throw new Error("Trying to deserialize similar int array with invalid serialized item code");let s=2;var i=[];for(let e=0;e<n;e++){var{number:r,byteLength:o}=es(t.slice(s)),a=(s+=o,0xffn&r),h=-256n&r;for(let e=0;e<a;e++){var d=BigInt(t[s]);i.push(h|d),s++}}return{numbers:i,byteLength:s}}function Ti(e){var[t,n]=e;if(t>>4!=2)throw new Error("Trying to deserialize bytes (sting) with invalid serialized item code.");t=(15&t)<<8|n,n=e.slice(2,2+t);return{string:new TextDecoder("utf8").decode(n),byteLength:2+t}}class gt{constructor(){p(this,"bytes",[]),p(this,"_length",0)}push(e){this.addBytes(e,"end")}unshift(e){this.addBytes(e,"start")}addBytes(e,t){e=e instanceof Uint8Array?e:Array.isArray(e)?new Uint8Array(e):new Uint8Array([e]);this._length+=e.length,this.bytes["start"===t?"unshift":"push"](e)}getBytesChunks(){return this.bytes}getBuffer(){return Ce(this.bytes,this._length)}get length(){return this._length}}let ct=Gt("cstr",4),_t=Gt("cend",4),Le=Gt("dstr",4),ke=Gt("dend",4),Ii=[ct,Le],Ri=[_t,ke],fn=ct.length+_t.length;function ns(t){let e=ct.length,n=t.slice(-e);return Ii.some(e=>Qt(t,e,4))&&Ri.some(e=>Qt(n,e,4))}class Wt extends Error{constructor(e){super(),this.type=e}}class ss{constructor(e){p(this,"chunks",new gt),p(this,"status","joining"),this.onComplete=e}addCommandChunk(e){if("completed"!==this.status){var t=Qt(e,ct,4);if(!this.chunks.length&&!t)throw new Wt("no-first-chunk");if(this.chunks.length&&t)throw new Wt("incomplete-joining");this.chunks.push(this.unframeCommandChunk(e)),Qt(e.slice(-4),_t,4)&&(this.status="completed",this.onComplete(this.chunks.getBuffer()))}}unframeCommandChunk(e){return e.slice(4,e.length-4)}}class Et{constructor(e,t){p(this,"bytes",new gt),p(this,"resultBuffers",[]),p(this,"status","creating"),this.maxChunkLength=t,this.bytes.push(e)}addInteger(e,t){this.bytes.push(e.charCodeAt(0));e=gn(BigInt(t));this.bytes.push(e)}addSimilarIntArr(e,t){this.bytes.push(e.charCodeAt(0));e=(e=>{var t,n=new Map;for(t of e){var s=-256n&t,i=0xffn&t,r=n.get(s)??new gt;r.length||n.set(s,r),r.push(Number(i))}var o,a,h=new gt;h.push([16,n.size]);for([o,a]of n){var d=a.getBytesChunks().length,d=o|0xffn&BigInt(d);a.unshift(gn(d)),h.push(a.getBuffer())}return h.getBuffer()})(t.map(e=>BigInt(e)));this.bytes.push(e)}addString(e,t){this.bytes.push(e.charCodeAt(0));t=(e=t).length,(n=new gt).push([32|t>>8&15,255&t]),n.push((new TextEncoder).encode(e));var n,t=n.getBuffer();this.bytes.push(t)}complete(){if(!this.bytes.length)throw new Error("Buffer is empty");if("completed"!==this.status){this.status="completed";var t=this.bytes.getBuffer();if(t.length+fn<=this.maxChunkLength)this.resultBuffers.push(At(t,ct,_t));else{let e=Math.ceil(t.length/this.maxChunkLength);Math.ceil(t.length/e)+fn>this.maxChunkLength&&e++;for(var[n,s]of function*(t,n){var s=Math.ceil(t.length/n);for(let e=0;e<n;e++)yield[e,t.slice(e*s,(e+1)*s)]}(t,e))0===n?this.resultBuffers.push(At(s,ct,ke)):n===e-1?this.resultBuffers.push(At(s,Le,_t)):this.resultBuffers.push(At(s,Le,ke))}}}getResultBuffers(){if("creating"!==this.status&&this.resultBuffers.length)return this.resultBuffers;throw new Error("Command is not complete.")}}function is(e){var[t]=e,n={c:t};let s=1;for(;s<e.length;){var i=String.fromCharCode(e[s]);switch(Pi(e[++s])){case at.Int:var{number:r,byteLength:o}=es(e.slice(s));n[i]=Number(r),s+=o;break;case at.SimilarIntArray:var{numbers:r,byteLength:o}=Ai(e.slice(s));n[i]=r.map(e=>Number(e)),s+=o;break;case at.String:var{string:a,byteLength:h}=Ti(e.slice(s));n[i]=a,s+=h}}return n}function Pi(e){e>>=4;if(e<=at.Min||e>=at.Max)throw new Error("Not existing type");return e}function Gt(t,e){if(t.length!==e)throw new Error("Wrong string length");var n=new Uint8Array(e);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}function At(e,t,n){var s=new Uint8Array(e.length+t.length+n.length);return s.set(t),s.set(e,t.length),s.set(n,t.length+e.length),s}function Qt(t,n,s){for(let e=0;e<s;e++)if(t[e]!==n[e])return!1;return!0}function rs(e,t){switch(e.c){case V.CancelSegmentRequest:case V.SegmentAbsent:case V.SegmentDataSendingCompleted:var n=e,s=t;return(s=new Et(n.c,s)).addInteger("i",n.i),s.addInteger("r",n.r),s.complete(),s.getResultBuffers();case V.SegmentRequest:n=e,s=t;return(s=new Et(n.c,s)).addInteger("i",n.i),s.addInteger("r",n.r),n.b&&s.addInteger("b",n.b),s.complete(),s.getResultBuffers();case V.SegmentsAnnouncement:var i=t,{c:r,p:o,l:a}=e,r=new Et(r,i);return null!=a&&a.length&&r.addSimilarIntArr("l",a),null!=o&&o.length&&r.addSimilarIntArr("p",o),r.complete(),r.getResultBuffers();case V.SegmentData:i=e,a=t;return(a=new Et(i.c,a)).addInteger("i",i.i),a.addInteger("s",i.s),a.addInteger("r",i.r),a.complete(),a.getResultBuffers()}}let Bi=Object.freeze(Object.defineProperty({__proto__:null,BinaryCommandChunksJoiner:ss,BinaryCommandJoiningError:Wt,PeerCommandType:V,deserializeCommand:is,isCommandChunk:ns,serializePeerCommand:rs},Symbol.toStringTag,{value:"Module"}));class qi{constructor(e,t,n,s){p(this,"commandChunks"),p(this,"uploadingContext"),p(this,"onChunkDownloaded"),p(this,"onChunkUploaded"),p(this,"onDataReceived",e=>{ns(e)?this.receivingCommandBytes(e):(this.eventHandlers.onSegmentChunkReceived(e),this.onChunkDownloaded(e.byteLength,"p2p",this.connection.idUtf8))}),this.connection=e,this.peerConfig=t,this.eventHandlers=n,this.onChunkDownloaded=s.getEventDispatcher("onChunkDownloaded"),this.onChunkUploaded=s.getEventDispatcher("onChunkUploaded"),e.on("data",this.onDataReceived)}sendCommand(e){var t;for(t of rs(e,this.peerConfig.webRtcMaxMessageSize))this.connection.write(t)}stopUploadingSegmentData(){var e;null!=(e=this.uploadingContext)&&e.stopUploading(),this.uploadingContext=void 0}getUploadingRequestId(){var e;return null==(e=this.uploadingContext)?void 0:e.requestId}async splitSegmentDataToChunksAndUploadAsync(e,t){if(this.uploadingContext)throw new Error("Some segment data is already uploading.");let n=function*(e,t){let n=e.byteLength;for(;0<n;){var s=n>=t?t:n,i=e.byteLength-n,i=e.slice(i,i+s);n-=s,yield i}}(e,this.peerConfig.webRtcMaxMessageSize),{promise:s,resolve:i,reject:r}=(()=>{let n,s;return{promise:new Promise((e,t)=>{n=e,s=t}),resolve:n,reject:s}})(),o=!1;e={stopUploading:()=>{o=!1},requestId:t},this.uploadingContext=e,t=()=>{if(o)for(;;){var e=n.next().value;if(!e){i();break}var t=this.connection.write(e);if(this.onChunkUploaded(e.byteLength,this.connection.idUtf8),!t)break}else r()};try{this.connection.on("drain",t),o=!0,t(),await s}finally{this.connection.off("drain",t),this.uploadingContext===e&&(this.uploadingContext=void 0)}}receivingCommandBytes(e){this.commandChunks||(this.commandChunks=new ss(e=>{this.commandChunks=void 0;e=is(e);this.eventHandlers.onCommandReceived(e)}));try{this.commandChunks.addCommandChunk(e)}catch(e){e instanceof Wt&&(this.commandChunks=void 0)}}}let R=Bi.PeerCommandType;class zt{constructor(e,t,n,s,i){p(this,"id"),p(this,"peerProtocol"),p(this,"downloadingContext"),p(this,"loadedSegments",new Set),p(this,"httpLoadingSegments",new Set),p(this,"downloadingErrors",[]),p(this,"logger",O("p2pml-core:peer")),p(this,"onPeerClosed"),p(this,"onCommandReceived",async e=>{var t;switch(e.c){case R.SegmentsAnnouncement:this.loadedSegments=new Set(e.l),this.httpLoadingSegments=new Set(e.p),this.eventHandlers.onSegmentsAnnouncement();break;case R.SegmentRequest:this.peerProtocol.stopUploadingSegmentData(),this.eventHandlers.onSegmentRequested(this,e.i,e.r,e.b);break;case R.SegmentData:this.downloadingContext&&!this.downloadingContext.isSegmentDataCommandReceived&&({request:s,controls:n,requestId:i}=this.downloadingContext,s.segment.externalId===e.i&&i===e.r)&&(this.downloadingContext.isSegmentDataCommandReceived=!0,n.firstBytesReceived(),void 0===s.totalBytes?s.setTotalBytes(e.s):s.totalBytes-s.loadedBytes!==e.s&&(s.clearLoadedBytes(),this.sendCancelSegmentRequestCommand(s.segment,i),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),this.destroy()));break;case R.SegmentDataSendingCompleted:var n=this.downloadingContext;if(null==n||!n.isSegmentDataCommandReceived)return;var{request:s,controls:i}=n;if(n.request.segment.externalId!==e.i||n.requestId!==e.r)return s.clearLoadedBytes(),this.cancelSegmentDownloading("peer-protocol-violation"),void this.destroy();if(s.loadedBytes!==s.totalBytes)return s.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),void this.destroy();var r=await(null==(r=(t=this.peerConfig).validateP2PSegment)?void 0:r.call(t,s.segment.url,s.segment.byteRange))??!0;if(this.downloadingContext!==n)return;if(!r)return s.clearLoadedBytes(),this.cancelSegmentDownloading("p2p-segment-validation-failed"),void this.destroy();this.downloadingErrors=[],i.completeOnSuccess(),this.downloadingContext=void 0;break;case R.SegmentAbsent:(null==(t=this.downloadingContext)?void 0:t.request.segment.externalId)===e.i&&(null==(n=this.downloadingContext)?void 0:n.requestId)===e.r&&(this.cancelSegmentDownloading("peer-segment-absent"),this.loadedSegments.delete(e.i));break;case R.CancelSegmentRequest:this.peerProtocol.getUploadingRequestId()===e.r&&this.peerProtocol.stopUploadingSegmentData()}}),p(this,"onSegmentChunkReceived",e=>{var t,n;null!=(t=this.downloadingContext)&&t.isSegmentDataCommandReceived&&({request:t,controls:n}=this.downloadingContext,void 0!==t.totalBytes&&t.loadedBytes+e.byteLength>t.totalBytes?(t.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),this.destroy()):n.addLoadedChunk(e))}),p(this,"onPeerConnectionClosed",()=>{this.destroy()}),p(this,"onConnectionError",e=>{this.logger(`peer connection error ${this.id} %O`,e),this.eventTarget.getEventDispatcher("onPeerError")({peerId:this.id,streamType:this.streamType,error:e});e=e.code;"ERR_DATA_CHANNEL"!==e&&"ERR_CONNECTION_FAILURE"!==e||this.destroy()}),p(this,"destroy",()=>{this.cancelSegmentDownloading("peer-closed"),this.connection.destroy(),this.eventHandlers.onPeerClosed(this),this.onPeerClosed({peerId:this.id,streamType:this.streamType}),this.logger("peer closed "+this.id)}),this.connection=e,this.eventHandlers=t,this.peerConfig=n,this.streamType=s,this.eventTarget=i,this.onPeerClosed=i.getEventDispatcher("onPeerClose"),this.id=zt.getPeerIdFromConnection(e),this.peerProtocol=new qi(e,n,{onSegmentChunkReceived:this.onSegmentChunkReceived,onCommandReceived:this.onCommandReceived},i),i.getEventDispatcher("onPeerConnect")({peerId:this.id,streamType:s}),e.on("error",this.onConnectionError),e.on("close",this.onPeerConnectionClosed),e.on("end",this.onPeerConnectionClosed),e.on("finish",this.onPeerConnectionClosed)}get downloadingSegment(){var e;return null==(e=this.downloadingContext)?void 0:e.request.segment}getSegmentStatus(e){e=e.externalId;return this.loadedSegments.has(e)?"loaded":this.httpLoadingSegments.has(e)?"http-loading":void 0}downloadSegment(e){if(this.downloadingContext)throw new Error("Some segment already is downloading");this.downloadingContext={request:e,requestId:Math.floor(1e3*Math.random()),isSegmentDataCommandReceived:!1,controls:e.start({downloadSource:"p2p",peerId:this.id},{notReceivingBytesTimeoutMs:this.peerConfig.p2pNotReceivingBytesTimeoutMs,abort:e=>{var t,n;this.downloadingContext&&({request:t,requestId:n}=this.downloadingContext,this.sendCancelSegmentRequestCommand(t.segment,n),this.downloadingErrors.push(e),this.downloadingContext=void 0,this.downloadingErrors.filter(e=>"bytes-receiving-timeout"===e.type).length>=this.peerConfig.p2pErrorRetries)&&this.destroy()}})};var t={c:R.SegmentRequest,r:this.downloadingContext.requestId,i:e.segment.externalId};e.loadedBytes&&(t.b=e.loadedBytes),this.peerProtocol.sendCommand(t)}async uploadSegmentData(e,t,n){var s=e.externalId,i=(this.logger(`send segment ${e.externalId} to `+this.id),{c:R.SegmentData,i:s,r:t,s:n.byteLength});this.peerProtocol.sendCommand(i);try{await this.peerProtocol.splitSegmentDataToChunksAndUploadAsync(n,t),this.sendSegmentDataSendingCompletedCommand(e,t),this.logger(`segment ${s} has been sent to `+this.id)}catch{this.logger("cancel segment uploading "+s)}}cancelSegmentDownloading(e){var t,n;this.downloadingContext&&({request:n,controls:t}=this.downloadingContext,n=n.segment,this.logger(`cancel segment request ${n.externalId} (${e})`),n=new B(e),t.abortOnError(n),this.downloadingContext=void 0,this.downloadingErrors.push(n))}sendSegmentsAnnouncementCommand(e,t){t={c:R.SegmentsAnnouncement,p:t,l:e};this.peerProtocol.sendCommand(t)}sendSegmentAbsentCommand(e,t){this.peerProtocol.sendCommand({c:R.SegmentAbsent,i:e,r:t})}sendCancelSegmentRequestCommand(e,t){this.peerProtocol.sendCommand({c:R.CancelSegmentRequest,i:e.externalId,r:t})}sendSegmentDataSendingCompletedCommand(e,t){this.peerProtocol.sendCommand({c:R.SegmentDataSendingCompleted,r:t,i:e.externalId})}static getPeerIdFromConnection(e){var t=e.id,n=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)n[e/2]=parseInt(t.slice(e,e+2),16);return(new TextDecoder).decode(n)}}function Oi(){var e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=/\b(iPad|iPhone|Macintosh).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent);return e||t}class Di{constructor(e,t,n,s,i){p(this,"streamShortId"),p(this,"client"),p(this,"_peers",new Map),p(this,"logger",O("p2pml-core:p2p-tracker-client")),p(this,"onReceivePeerConnection",t=>{var e=zt.getPeerIdFromConnection(t);let n=this._peers.get(e);null!=n&&n.peer?t.destroy():(n||(n={potentialConnections:new Set},t.idUtf8=e,n.potentialConnections.add(t),this._peers.set(e,n)),t.on("connect",()=>{if(n&&!n.peer){for(var e of n.potentialConnections)e!==t&&e.destroy();n.potentialConnections.clear(),n.peer=new zt(t,{onPeerClosed:this.onPeerClosed,onSegmentRequested:this.eventHandlers.onSegmentRequested,onSegmentsAnnouncement:this.eventHandlers.onSegmentsAnnouncement},this.config,this.stream.type,this.eventTarget),this.logger(`connected with peer: ${n.peer.id} `+this.streamShortId),this.eventHandlers.onPeerConnected(n.peer)}}))}),p(this,"onTrackerClientWarning",e=>{this.logger(`tracker warning (${this.streamShortId}: ${e})`),this.eventTarget.getEventDispatcher("onTrackerWarning")({streamType:this.stream.type,warning:e})}),p(this,"onTrackerClientError",e=>{this.logger(`tracker error (${this.streamShortId}: ${e})`),this.eventTarget.getEventDispatcher("onTrackerError")({streamType:this.stream.type,error:e})}),p(this,"onPeerClosed",e=>{this.logger("peer closed: "+e.id),this._peers.delete(e.id)}),this.stream=t,this.eventHandlers=n,this.config=s,this.eventTarget=i;n=(e=>(e=Ci.fromUtf8(e).slice(1),btoa(e)))(e),this.streamShortId=tt(t),i=(e=>{var t=[e],n=20-e.length;for(let e=0;e<n;e++)t.push(ki[Math.floor(62*Math.random())]);return t.join("")})(s.trackerClientVersionPrefix);this.client=new Se({infoHash:ln(n),peerId:ln(i),announce:Oi()?s.announceTrackers.slice(0,1):s.announceTrackers,rtcConfig:this.config.rtcConfig}),this.client.on("peer",this.onReceivePeerConnection),this.client.on("warning",this.onTrackerClientWarning),this.client.on("error",this.onTrackerClientError),this.logger(`create new client; 
stream: ${this.streamShortId}; hash: ${n}
peerId: `+i)}start(){this.client.start()}destroy(){this.client.destroy();for(var{peer:e,potentialConnections:t}of this._peers.values()){null!=e&&e.destroy();for(var n of t)n.destroy()}this._peers.clear(),this.logger("destroy client; stream: "+this.streamShortId)}*peers(){for(var e of this._peers.values())null!=e&&e.peer&&(yield e.peer)}}function pn(e,t){for(var n of e.values()){n=n.segments.get(t);if(n)return n}}function Y(e){return e.type+"-"+e.index}function Bt(e,t,n,s){var{highDemandTimeWindow:n,httpDownloadTimeWindow:i,p2pDownloadTimeWindow:r}=n;return{isHighDemand:Zt(e,t,n),isHttpDownloadable:Zt(e,t,i),isP2PDownloadable:Zt(e,t,r)&&(!s||s.isSegmentLoadingOrLoadedBySomeone(e))}}function Zt(e,t,n){var{startTime:e,endTime:s}=e,{position:t,rate:i}=t;return!(t+n*i<e||s<t)}class Mi{constructor(e,t,n,s,i,r,o){p(this,"trackerClient"),p(this,"isAnnounceMicrotaskCreated",!1),p(this,"onPeerConnected",e=>{var{httpLoading:t,loaded:n}=this.getSegmentsAnnouncement();e.sendSegmentsAnnouncementCommand(n,t)}),p(this,"broadcastAnnouncement",()=>{this.isAnnounceMicrotaskCreated||(this.isAnnounceMicrotaskCreated=!0,queueMicrotask(()=>{var e,{httpLoading:t,loaded:n}=this.getSegmentsAnnouncement();for(e of this.trackerClient.peers())e.sendSegmentsAnnouncementCommand(n,t);this.isAnnounceMicrotaskCreated=!1}))}),p(this,"onSegmentRequested",async(e,t,n,s)=>{var i,r=((e,t)=>{for(var n of e.segments.values())if(n.externalId===t)return n})(this.stream,t);r&&((i=await this.segmentStorage.getSegmentData(r))?await e.uploadSegmentData(r,n,void 0!==s?i.slice(s):i):e.sendSegmentAbsentCommand(t,n))}),this.streamManifestUrl=e,this.stream=t,this.requests=n,this.segmentStorage=s,this.config=i,this.eventTarget=r,this.onSegmentAnnouncement=o;e=this.config.swarmId??this.streamManifestUrl,t=this.stream;n=`v2-${e}-`+Y(t);this.trackerClient=new Di(n,this.stream,{onPeerConnected:this.onPeerConnected,onSegmentRequested:this.onSegmentRequested,onSegmentsAnnouncement:this.onSegmentAnnouncement},this.config,this.eventTarget),this.segmentStorage.subscribeOnUpdate(this.stream,this.broadcastAnnouncement),this.trackerClient.start()}downloadSegment(e){var t,n=[];for(t of this.trackerClient.peers())t.downloadingSegment||"loaded"!==t.getSegmentStatus(e)||n.push(t);var s,i=(i=n)[Math.floor(Math.random()*i.length)];i&&(s=this.requests.getOrCreateRequest(e),i.downloadSegment(s))}isSegmentLoadingOrLoadedBySomeone(e){for(var t of this.trackerClient.peers())if(t.getSegmentStatus(e))return!0;return!1}isSegmentLoadedBySomeone(e){for(var t of this.trackerClient.peers())if("loaded"===t.getSegmentStatus(e))return!0;return!1}get connectedPeerCount(){let e=0;for(var t of this.trackerClient.peers())e++;return e}getSegmentsAnnouncement(){var e,t=this.segmentStorage.getStoredSegmentExternalIdsOfStream(this.stream),n=[];for(e of this.requests.httpRequests()){var s=this.stream.segments.get(e.segment.runtimeId);s&&n.push(s.externalId)}return{loaded:t,httpLoading:n}}destroy(){this.segmentStorage.unsubscribeFromUpdate(this.stream,this.broadcastAnnouncement),this.trackerClient.destroy()}}class Ni{constructor(e,t,n,s,i,r,o){p(this,"loaders",new Map),p(this,"_currentLoaderItem"),p(this,"logger",O("p2pml-core:p2p-loaders-container")),this.streamManifestUrl=e,this.requests=n,this.segmentStorage=s,this.config=i,this.eventTarget=r,this.onSegmentAnnouncement=o,this.changeCurrentLoader(t)}createLoader(e){if(this.loaders.has(e.runtimeId))throw new Error("Loader for this stream already exists");let t=new Mi(this.streamManifestUrl,e,this.requests,this.segmentStorage,this.config,this.eventTarget,()=>{this._currentLoaderItem.loader===t&&this.onSegmentAnnouncement()}),n=tt(e);return this.logger("created new loader: "+n),{loader:t,stream:e,loggerInfo:tt(e)}}changeCurrentLoader(e){var t=this.loaders.get(e.runtimeId);this._currentLoaderItem&&(this.segmentStorage.getStoredSegmentExternalIdsOfStream(this._currentLoaderItem.stream).length?this.setLoaderDestroyTimeout(this._currentLoaderItem):this.destroyAndRemoveLoader(this._currentLoaderItem)),t?(this._currentLoaderItem=t,clearTimeout(t.destroyTimeoutId),t.destroyTimeoutId=void 0):(t=this.createLoader(e),this.loaders.set(e.runtimeId,t),this._currentLoaderItem=t),this.logger("change current p2p loader: "+tt(e))}setLoaderDestroyTimeout(e){e.destroyTimeoutId=window.setTimeout(()=>this.destroyAndRemoveLoader(e),this.config.p2pInactiveLoaderDestroyTimeoutMs)}destroyAndRemoveLoader(e){e.loader.destroy(),this.loaders.delete(e.stream.runtimeId),this.logger("destroy p2p loader: ",e.loggerInfo)}get currentLoader(){return this._currentLoaderItem.loader}destroy(){for(var{loader:e,destroyTimeoutId:t}of this.loaders.values())e.destroy(),clearTimeout(t);this.loaders.clear()}}let Ui=class{constructor(e,t,n,s,i,r){p(this,"currentAttempt"),p(this,"_failedAttempts",new Fi),p(this,"finalData"),p(this,"bytes",[]),p(this,"_loadedBytes",0),p(this,"_totalBytes"),p(this,"_status","not-started"),p(this,"progress"),p(this,"notReceivingBytesTimeout"),p(this,"_abortRequestCallback"),p(this,"_logger"),p(this,"_isHandledByProcessQueue",!1),p(this,"onSegmentError"),p(this,"onSegmentAbort"),p(this,"onSegmentStart"),p(this,"onSegmentLoaded"),p(this,"abortOnTimeout",()=>{var e,t;this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.setStatus("failed"),t=new B("bytes-receiving-timeout"),null!=(e=this._abortRequestCallback)&&e.call(this,t),this.logger(`${this.downloadSource} ${this.segment.externalId} failed `+t.type),this._failedAttempts.add({...this.currentAttempt,error:t}),this.onSegmentError({segment:this.segment,error:t,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback())}),p(this,"abortOnError",e=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.setStatus("failed"),this.logger(`${this.downloadSource} ${this.segment.externalId} failed `+e.type),this._failedAttempts.add({...this.currentAttempt,error:e}),this.onSegmentError({segment:this.segment,error:e,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback())}),p(this,"completeOnSuccess",()=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear(),this.finalData=Ce(this.bytes),this.setStatus("succeed"),this._totalBytes=this._loadedBytes,this.onSegmentLoaded({segmentUrl:this.segment.url,bytesLength:this.finalData.byteLength,downloadSource:this.currentAttempt.downloadSource,peerId:"p2p"===this.currentAttempt.downloadSource?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.logger(`${this.currentAttempt.downloadSource} ${this.segment.externalId} succeed`),this.requestProcessQueueCallback())}),p(this,"addLoadedChunk",e=>{var t,n,s;this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&this.progress&&(this.notReceivingBytesTimeout.restart(),t=e.byteLength,{all:n,http:s}=this.bandwidthCalculators,n.addBytes(t),"http"===this.currentAttempt.downloadSource&&s.addBytes(t),this.bytes.push(e),this.progress.lastLoadedChunkTimestamp=performance.now(),this.progress.loadedBytes+=t,this._loadedBytes+=t)}),p(this,"firstBytesReceived",()=>{this.throwErrorIfNotLoadingStatus(),this.notReceivingBytesTimeout.restart()}),this.segment=e,this.requestProcessQueueCallback=t,this.bandwidthCalculators=n,this.playback=s,this.playbackConfig=i,this.onSegmentError=r.getEventDispatcher("onSegmentError"),this.onSegmentAbort=r.getEventDispatcher("onSegmentAbort"),this.onSegmentStart=r.getEventDispatcher("onSegmentStart"),this.onSegmentLoaded=r.getEventDispatcher("onSegmentLoaded");e=this.segment.byteRange,e&&({end:t,start:n}=e,this._totalBytes=t-n+1),this.notReceivingBytesTimeout=new Hi(this.abortOnTimeout),s=this.segment.stream.type;this._logger=O("p2pml-core:request-"+s)}clearLoadedBytes(){this._loadedBytes=0,this.bytes=[],this._totalBytes=void 0}get status(){return this._status}setStatus(e){this._status=e,this._isHandledByProcessQueue=!1}get downloadSource(){var e;return null==(e=this.currentAttempt)?void 0:e.downloadSource}get loadedBytes(){return this._loadedBytes}get totalBytes(){return this._totalBytes}get data(){if("succeed"===this.status)return this.finalData||(this.finalData=Ce(this.bytes)),this.finalData}get failedAttempts(){return this._failedAttempts}get isHandledByProcessQueue(){return this._isHandledByProcessQueue}markHandledByProcessQueue(){this._isHandledByProcessQueue=!0}setTotalBytes(e){if(void 0!==this._totalBytes)throw new Error("Request total bytes value is already set");this._totalBytes=e}start(e,t){if("succeed"===this._status)throw new Error(`Request ${this.segment.externalId} has been already succeed.`);if("loading"===this._status)throw new Error(`Request ${this.segment.externalId} has been already started.`);this.setStatus("loading"),this.currentAttempt={...e},this.progress={startFromByte:this._loadedBytes,loadedBytes:0,startTimestamp:performance.now()},this.manageBandwidthCalculatorsState("start");var{notReceivingBytesTimeoutMs:t,abort:n}=t;return this._abortRequestCallback=n,void 0!==t&&this.notReceivingBytesTimeout.start(t),this.logger(`${e.downloadSource} ${this.segment.externalId} started`),this.onSegmentStart({segment:this.segment,downloadSource:e.downloadSource,peerId:"p2p"===e.downloadSource?e.peerId:void 0}),{firstBytesReceived:this.firstBytesReceived,addLoadedChunk:this.addLoadedChunk,completeOnSuccess:this.completeOnSuccess,abortOnError:this.abortOnError}}abortFromProcessQueue(){var e;this.throwErrorIfNotLoadingStatus(),this.setStatus("aborted"),this.logger(`${null==(e=this.currentAttempt)?void 0:e.downloadSource} ${this.segment.externalId} aborted`),null!=(e=this._abortRequestCallback)&&e.call(this,new B("abort")),this.onSegmentAbort({segment:this.segment,downloadSource:null==(e=this.currentAttempt)?void 0:e.downloadSource,peerId:"p2p"===(null==(e=this.currentAttempt)?void 0:e.downloadSource)?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this._abortRequestCallback=void 0,this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear()}throwErrorIfNotLoadingStatus(){if("loading"!==this._status)throw new Error(`Request has been already ${this.status}.`)}logger(e){var t;this._logger.color="http"===(null==(t=this.currentAttempt)?void 0:t.downloadSource)?"green":"red",this._logger(e),this._logger.color=""}manageBandwidthCalculatorsState(e){var t,{all:n,http:s}=this.bandwidthCalculators,e="start"===e?"startLoading":"stopLoading";"http"===(null==(t=this.currentAttempt)?void 0:t.downloadSource)&&s[e](),n[e]()}};class Fi{constructor(){p(this,"attempts",[])}add(e){this.attempts.push(e)}get httpAttemptsCount(){return this.attempts.reduce((e,t)=>"http"===t.downloadSource?e+1:e,0)}get lastAttempt(){return this.attempts[this.attempts.length-1]}clear(){this.attempts=[]}}class Hi{constructor(e){p(this,"timeoutId"),p(this,"ms"),this.action=e}start(e){if(this.timeoutId)throw new Error("Timeout is already started.");this.ms=e,this.timeoutId=window.setTimeout(this.action,this.ms)}restart(e){this.timeoutId&&clearTimeout(this.timeoutId),e&&(this.ms=e),this.ms&&(this.timeoutId=window.setTimeout(this.action,this.ms))}clear(){clearTimeout(this.timeoutId),this.timeoutId=void 0}}class $i{constructor(e,t,n,s,i){p(this,"requests",new Map),this.requestProcessQueueCallback=e,this.bandwidthCalculators=t,this.playback=n,this.config=s,this.eventTarget=i}get executingHttpCount(){let e=0;for(var t of this.httpRequests())"loading"===t.status&&e++;return e}get executingP2PCount(){let e=0;for(var t of this.p2pRequests())"loading"===t.status&&e++;return e}get(e){return this.requests.get(e)}getOrCreateRequest(e){let t=this.requests.get(e);return t||(t=new Ui(e,this.requestProcessQueueCallback,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),this.requests.set(e,t)),t}remove(e){this.requests.delete(e.segment)}items(){return this.requests.values()}*httpRequests(){for(var e of this.requests.values())"http"===e.downloadSource&&(yield e)}*p2pRequests(){for(var e of this.requests.values())"p2p"===e.downloadSource&&(yield e)}destroy(){for(var e of this.requests.values())"loading"===e.status&&e.abortFromProcessQueue();this.requests.clear()}}class ji{constructor(e,t){p(this,"_status","pending"),p(this,"_shouldBeStartedImmediately",!1),this.segment=e,this.engineCallbacks=t}get status(){return this._status}get shouldBeStartedImmediately(){return this._shouldBeStartedImmediately}resolve(e,t){"pending"===this._status&&(this._status="succeed",this.engineCallbacks.onSuccess({data:e,bandwidth:t}))}reject(){"pending"===this._status&&(this._status="failed",this.engineCallbacks.onError(new Dt("failed")))}abort(){"pending"===this._status&&(this._status="aborted",this.engineCallbacks.onError(new Dt("aborted")))}markAsShouldBeStartedImmediately(){this._shouldBeStartedImmediately=!0}}function*mn(t,n,s,i){var{runtimeId:t,stream:r}=t,o=r.segments.get(t);if(o){var a=r.segments.values();let e;do{var h=a.next();if(h.done)return;e=h.value}while(e!==o);var d,t=Bt(e,n,s,i);if(te(t)){r=a.next();if(r.done)return;var r=r.value,l=Bt(r,n,s,i);if(te(l))return;t.isHighDemand=!0,yield{segment:e,statuses:t},yield{segment:r,statuses:l}}else yield{segment:e,statuses:t};for(d of a){var u=Bt(d,n,s,i);if(te(u))break;yield{segment:d,statuses:u}}}}function te(e){var{isHighDemand:e=!1,isHttpDownloadable:t=!1,isP2PDownloadable:n=!1}=e;return!e&&!t&&!n}class Wi{constructor(e,t,n,s,i,r,o){p(this,"requests"),p(this,"engineRequest"),p(this,"p2pLoaders"),p(this,"playback"),p(this,"segmentAvgDuration"),p(this,"logger"),p(this,"storageCleanUpIntervalId"),p(this,"levelChangedTimestamp"),p(this,"lastQueueProcessingTimeStamp"),p(this,"randomHttpDownloadInterval"),p(this,"isProcessQueueMicrotaskCreated",!1),p(this,"requestProcessQueueMicrotask",(e=!0)=>{let t=performance.now();!e&&void 0!==this.lastQueueProcessingTimeStamp&&t-this.lastQueueProcessingTimeStamp<=1e3||this.isProcessQueueMicrotaskCreated||(this.isProcessQueueMicrotaskCreated=!0,queueMicrotask(()=>{try{this.processQueue(),this.lastQueueProcessingTimeStamp=t}finally{this.isProcessQueueMicrotaskCreated=!1}}))}),this.streamManifestUrl=e,this.lastRequestedSegment=t,this.streamDetails=n,this.config=s,this.bandwidthCalculators=i,this.segmentStorage=r,this.eventTarget=o;let a=this.lastRequestedSegment.stream;if(this.playback={position:this.lastRequestedSegment.startTime,rate:1},this.segmentAvgDuration=(()=>{var e=a.segments;let t=0;var n,s=e.size;for(n of e.values())t+=n.endTime-n.startTime;return t/s})(),this.requests=new $i(this.requestProcessQueueMicrotask,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),!this.segmentStorage.isInitialized)throw new Error("Segment storage is not initialized.");this.segmentStorage.addIsSegmentLockedPredicate(s=>s.stream===a&&((e,t)=>{var{isHighDemand:e=!1,isHttpDownloadable:t=!1,isP2PDownloadable:n=!1}=Bt(s,e,t);return e||t||n})(this.playback,this.config)),this.p2pLoaders=new Ni(this.streamManifestUrl,this.lastRequestedSegment.stream,this.requests,this.segmentStorage,this.config,this.eventTarget,this.requestProcessQueueMicrotask),this.logger=O("p2pml-core:hybrid-loader-"+a.type),this.logger.color="coral",this.setIntervalLoading()}setIntervalLoading(){var e=this.p2pLoaders.currentLoader.connectedPeerCount,e=1e3*Math.random()*e+1e3;this.randomHttpDownloadInterval=window.setTimeout(()=>{this.loadRandomThroughHttp(),this.setIntervalLoading()},e)}async loadSegment(e,t){this.logger("requests: "+dn(e));var n=e.stream,n=(n!==this.lastRequestedSegment.stream&&(this.logger("stream changed to "+tt(n)),this.p2pLoaders.changeCurrentLoader(n)),this.lastRequestedSegment=e,new ji(e,t));this.segmentStorage.hasSegment(e)?(t=await this.segmentStorage.getSegmentData(e))&&(e=this.generateQueue().queueDownloadRatio,n.resolve(t,this.getBandwidth(e))):this.engineRequest=n,this.requestProcessQueueMicrotask()}processRequests(e,t){var n,s=this.lastRequestedSegment.stream,i=this.config.httpErrorRetries,r=performance.now();for(n of this.requests.items()){var{downloadSource:o,status:a,segment:h,isHandledByProcessQueue:d}=n,l=(null==(u=this.engineRequest)?void 0:u.segment)===h?this.engineRequest:void 0;switch(a){case"loading":e.has(h.runtimeId)||l||(n.abortFromProcessQueue(),this.requests.remove(n));break;case"succeed":n.data&&o&&("http"===o&&this.p2pLoaders.currentLoader.broadcastAnnouncement(),l&&(l.resolve(n.data,this.getBandwidth(t)),this.engineRequest=void 0),this.requests.remove(n),this.segmentStorage.storeSegment(n.segment,n.data,this.streamDetails.isLive));break;case"failed":"http"!==o||d||this.p2pLoaders.currentLoader.broadcastAnnouncement(),l||s.segments.has(n.segment.runtimeId)||this.requests.remove(n),n.failedAttempts.httpAttemptsCount>=i&&l&&(this.engineRequest=void 0,l.reject());break;case"not-started":case"aborted":this.requests.remove(n)}n.markHandledByProcessQueue();var u=n.failedAttempts.lastAttempt;u&&6e4<r-u.error.timestamp&&n.failedAttempts.clear()}}processQueue(){var e,{queue:t,queueSegmentIds:n,queueDownloadRatio:s}=this.generateQueue(),{simultaneousHttpDownloads:i,simultaneousP2PDownloads:r,httpErrorRetries:o}=(this.processRequests(n,s),this.config);null!=(n=this.engineRequest)&&n.shouldBeStartedImmediately&&"pending"===this.engineRequest.status&&this.requests.executingHttpCount<i&&(s=this.engineRequest.segment,!(n=this.requests.get(s))||"not-started"===n.status||"failed"===n.status&&n.failedAttempts.httpAttemptsCount<this.config.httpErrorRetries)&&this.loadThroughHttp(s);for(e of t){var a,{statuses:h,segment:d}=e,l=this.requests.get(d);h.isHighDemand?"http"===(null==l?void 0:l.downloadSource)&&"loading"===l.status||"http"===(null==l?void 0:l.downloadSource)&&"failed"===l.status&&l.failedAttempts.httpAttemptsCount>=o||(a="loading"===(null==l?void 0:l.status)&&"p2p"===l.downloadSource,this.requests.executingHttpCount<i||this.abortLastHttpLoadingInQueueAfterItem(t,d)&&this.requests.executingHttpCount<i?(a&&l.abortFromProcessQueue(),this.loadThroughHttp(d)):a||(this.requests.executingP2PCount<r||this.abortLastP2PLoadingInQueueAfterItem(t,d)&&this.requests.executingP2PCount<r)&&this.loadThroughP2P(d)):h.isP2PDownloadable&&"loading"!==(null==l?void 0:l.status)&&(this.requests.executingP2PCount<r||this.p2pLoaders.currentLoader.isSegmentLoadedBySomeone(d)&&this.abortLastP2PLoadingInQueueAfterItem(t,d)&&this.requests.executingP2PCount<r)&&this.loadThroughP2P(d)}}abortSegmentRequest(e){var t;(null==(t=this.engineRequest)?void 0:t.segment.runtimeId)===e&&(this.engineRequest.abort(),this.logger("abort: ",dn(this.engineRequest.segment)),this.engineRequest=void 0,this.requestProcessQueueMicrotask())}loadThroughHttp(e){e=this.requests.getOrCreateRequest(e);new gs(e,this.config,this.eventTarget),this.p2pLoaders.currentLoader.broadcastAnnouncement()}loadThroughP2P(e){this.p2pLoaders.currentLoader.downloadSegment(e)}loadRandomThroughHttp(){var{simultaneousHttpDownloads:t,httpErrorRetries:e}=this.config,n=this.p2pLoaders.currentLoader;if(!(this.requests.executingHttpCount>=t)&&n.connectedPeerCount){var s,i,r,o=[];for({segment:s,statuses:i}of mn(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader))!i.isHttpDownloadable||i.isP2PDownloadable||this.segmentStorage.hasSegment(s)||(r=this.requests.get(s))&&("loading"===r.status||"succeed"===r.status||(r.failedAttempts.httpAttemptsCount??0)>=e)||o.push(s);if(o.length&&t-this.requests.executingHttpCount!=0){var a,h,n=n.connectedPeerCount+1,d=Math.min(o.length,t*n);let e=d/n;for(a of(t=>{for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t})(Array.from({length:d},(e,t)=>t))){if(this.requests.executingHttpCount>=t)break;if((1<=e||Math.random()<=e)&&(h=o[a],this.loadThroughHttp(h)),--e<=0)break}}}}abortLastHttpLoadingInQueueAfterItem(e,t){for(var{segment:n}of un(e)){if(n===t)break;n=this.requests.get(n);if("http"===(null==n?void 0:n.downloadSource)&&"loading"===n.status)return n.abortFromProcessQueue(),!0}return!1}abortLastP2PLoadingInQueueAfterItem(e,t){for(var{segment:n}of un(e)){if(n===t)break;n=this.requests.get(n);if("p2p"===(null==n?void 0:n.downloadSource)&&"loading"===n.status)return n.abortFromProcessQueue(),!0}return!1}generateQueue(){var e,t,n=[],s=new Set;let i=0,r=0;for(t of mn(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader)){i++;var o=t.segment;this.segmentStorage.hasSegment(o)||"succeed"===(null==(e=this.requests.get(o))?void 0:e.status)?r++:(n.push(t),s.add(o.runtimeId))}return{queue:n,queueSegmentIds:s,maxPossibleLength:i,alreadyLoadedCount:r,queueDownloadRatio:0!==i?r/i:0}}getBandwidth(e){var t,{http:n,all:s}=this.bandwidthCalculators,i=this.streamDetails.activeLevelBitrate;return 0===this.streamDetails.activeLevelBitrate?s.getBandwidthLoadingOnly(3):(t=Math.max(s.getBandwidth(30,this.levelChangedTimestamp),s.getBandwidth(60,this.levelChangedTimestamp),s.getBandwidth(90,this.levelChangedTimestamp)),.8<=e||.9*i<=t?Math.max(s.getBandwidthLoadingOnly(1),s.getBandwidthLoadingOnly(3),s.getBandwidthLoadingOnly(5)):(e=Math.max(n.getBandwidthLoadingOnly(1),n.getBandwidthLoadingOnly(3),n.getBandwidthLoadingOnly(5)),Math.max(t,e)))}notifyLevelChanged(){this.levelChangedTimestamp=performance.now()}updatePlayback(e,t){var n,s=this.playback.rate!==t,i=this.playback.position!==e;(s||i)&&(n=.5<Math.abs(e-this.playback.position)/this.segmentAvgDuration,i&&(this.playback.position=e),s&&0!==t&&(this.playback.rate=t),n&&(this.logger("position significantly changed"),null!=(i=this.engineRequest))&&i.markAsShouldBeStartedImmediately(),this.requestProcessQueueMicrotask(n))}updateStream(e){e===this.lastRequestedSegment.stream&&(this.logger("update stream: "+tt(e)),this.requestProcessQueueMicrotask())}destroy(){var e;clearInterval(this.storageCleanUpIntervalId),clearInterval(this.randomHttpDownloadInterval),this.storageCleanUpIntervalId=void 0,null!=(e=this.engineRequest)&&e.abort(),this.requests.destroy(),this.p2pLoaders.destroy()}}class yn{constructor(e=2e4){p(this,"loadingsCount",0),p(this,"bytes",[]),p(this,"loadingOnlyTimestamps",[]),p(this,"timestamps",[]),p(this,"noLoadingsTime",0),p(this,"loadingsStoppedAt",0),this.clearThresholdMs=e}addBytes(e,t=performance.now()){this.bytes.push(e),this.loadingOnlyTimestamps.push(t-this.noLoadingsTime),this.timestamps.push(t)}startLoading(e=performance.now()){this.clearStale(),0===this.loadingsCount&&0!==this.loadingsStoppedAt&&(this.noLoadingsTime+=e-this.loadingsStoppedAt),this.loadingsCount++}stopLoading(e=performance.now()){0<this.loadingsCount&&(this.loadingsCount--,0===this.loadingsCount)&&(this.loadingsStoppedAt=e)}getBandwidthLoadingOnly(e,t=Number.NEGATIVE_INFINITY){if(!this.loadingOnlyTimestamps.length)return 0;var n=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1];let s=n;var i=n-1e3*e;let r=0;for(let e=this.bytes.length-1;0<=e;e--){var o=this.loadingOnlyTimestamps[e];if(o<i||this.timestamps[e]<t)break;s=o,r+=this.bytes[e]}return 8e3*r/(n-s)}getBandwidth(e,t=Number.NEGATIVE_INFINITY,n=performance.now()){if(!this.timestamps.length)return 0;var s=n-1e3*e;let i=n,r=0;for(let e=this.bytes.length-1;0<=e;e--){var o=this.timestamps[e];if(o<s||o<t)break;i=o,r+=this.bytes[e]}return 8e3*r/(n-i)}clearStale(){if(this.loadingOnlyTimestamps.length){var t,n=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1]-this.clearThresholdMs;let e=0;for(t of this.loadingOnlyTimestamps){if(t>n)break;e++}this.bytes.splice(0,e),this.loadingOnlyTimestamps.splice(0,e),this.timestamps.splice(0,e)}}}class os{constructor(){p(this,"events",new Map)}dispatchEvent(e,...t){e=this.events.get(e);if(e)for(var n of e)n(...t)}getEventDispatcher(e){let t=this.events.get(e),n=(t||(t=[],this.events.set(e,t)),t);return(...e)=>{for(var t of n)t(...e)}}addEventListener(e,t){var n=this.events.get(e);n?n.push(t):this.events.set(e,[t])}removeEventListener(e,t){e=this.events.get(e);e&&-1!==(t=e.indexOf(t))&&e.splice(t,1)}}function ee(e){return Y(e.stream)+"|"+e.externalId}class Qi{constructor(e){p(this,"cache",new Map),p(this,"_isInitialized",!1),p(this,"isSegmentLockedPredicates",[]),p(this,"logger"),p(this,"eventTarget",new os),this.storageConfig=e,this.logger=O("p2pml-core:segment-memory-storage"),this.logger.color="RebeccaPurple"}async initialize(){this._isInitialized=!0,this.logger("initialized")}get isInitialized(){return this._isInitialized}addIsSegmentLockedPredicate(e){this.isSegmentLockedPredicates.push(e)}isSegmentLocked(t){return this.isSegmentLockedPredicates.some(e=>e(t))}async storeSegment(e,t,n){var s=ee(e);this.cache.set(s,{segment:e,data:t,lastAccessed:performance.now()}),this.logger("add segment: "+s),this.dispatchStorageUpdatedEvent(e.stream),this.clear(n)}async getSegmentData(e){e=ee(e),e=this.cache.get(e);if(void 0!==e)return e.lastAccessed=performance.now(),e.data}hasSegment(e){e=ee(e);return this.cache.has(e)}getStoredSegmentExternalIdsOfStream(e){var t,n=Y(e),s=[];for({segment:t}of this.cache.values())Y(t.stream)===n&&s.push(t.externalId);return s}async clear(e){var t=1e3*(this.storageConfig.cachedSegmentExpiration??(e?1200:0));if(0==t)return!1;var n,s=[],i=[],r=new Set,o=performance.now();for(n of this.cache.entries()){var[a,h]=n,{lastAccessed:h,segment:d}=h;t<o-h?this.isSegmentLocked(d)||(s.push(a),r.add(d.stream)):i.push(n)}if(0<this.storageConfig.cachedSegmentsCount){let e=i.length-this.storageConfig.cachedSegmentsCount;if(0<e){i.sort(([,e],[,t])=>e.lastAccessed-t.lastAccessed);for(var[l,{segment:u}]of i)if(!this.isSegmentLocked(u)&&(s.push(l),r.add(u.stream),e--,0===e))break}}if(s.length){this.logger(`cleared ${s.length} segments`),s.forEach(e=>this.cache.delete(e));for(var c of r)this.dispatchStorageUpdatedEvent(c)}return 0<s.length}subscribeOnUpdate(e,t){e=Y(e);this.eventTarget.addEventListener("onStorageUpdated-"+e,t)}unsubscribeFromUpdate(e,t){e=Y(e);this.eventTarget.removeEventListener("onStorageUpdated-"+e,t)}dispatchStorageUpdatedEvent(e){this.eventTarget.dispatchEvent("onStorageUpdated-"+Y(e),e)}async destroy(){this.cache.clear(),this._isInitialized=!1}}let xe=class Gx{constructor(e){p(this,"eventTarget",new os),p(this,"manifestResponseUrl"),p(this,"streams",new Map),p(this,"mainStreamConfig"),p(this,"secondaryStreamConfig"),p(this,"commonCoreConfig"),p(this,"bandwidthCalculators",{all:new yn,http:new yn}),p(this,"segmentStorage"),p(this,"mainStreamLoader"),p(this,"secondaryStreamLoader"),p(this,"streamDetails",{isLive:!1,activeLevelBitrate:0});e=function s(i){if(ts(i)){let n={};return Object.keys(i).forEach(e=>{var t;void 0!==i[e]&&void 0!==(t=s(i[e]))&&(n[e]=t)}),n}return i}(e??{});this.commonCoreConfig=Xt({defaultConfig:Gx.DEFAULT_COMMON_CORE_CONFIG,baseConfig:e}),this.mainStreamConfig=Xt({defaultConfig:Gx.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:null==e?void 0:e.mainStream}),this.secondaryStreamConfig=Xt({defaultConfig:Gx.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:null==e?void 0:e.secondaryStream})}getConfig(){return{...ot(this.commonCoreConfig),mainStream:ot(this.mainStreamConfig),secondaryStream:ot(this.secondaryStreamConfig)}}applyDynamicConfig(e){var{mainStream:t,secondaryStream:n}=e;this.overrideAllConfigs(e,t,n),this.mainStreamConfig.isP2PDisabled&&this.destroyStreamLoader("main"),this.secondaryStreamConfig.isP2PDisabled&&this.destroyStreamLoader("secondary")}addEventListener(e,t){this.eventTarget.addEventListener(e,t)}removeEventListener(e,t){this.eventTarget.removeEventListener(e,t)}setManifestResponseUrl(e){this.manifestResponseUrl=e.split("?")[0]}hasSegment(e){return!!pn(this.streams,e)}getStream(e){return this.streams.get(e)}addStreamIfNoneExists(e){this.streams.has(e.runtimeId)||this.streams.set(e.runtimeId,{...e,segments:new Map})}updateStream(e,t,n){var s=this.streams.get(e);if(s){if(t)for(var i of t)s.segments.has(i.runtimeId)||s.segments.set(i.runtimeId,{...i,stream:s});if(n)for(var r of n)s.segments.delete(r);null!=(e=this.mainStreamLoader)&&e.updateStream(s),null!=(t=this.secondaryStreamLoader)&&t.updateStream(s)}}async loadSegment(e,t){if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");this.segmentStorage||(this.segmentStorage=new Qi(this.commonCoreConfig),await this.segmentStorage.initialize());e=this.identifySegment(e);this.getStreamHybridLoader(e).loadSegment(e,t)}abortSegmentLoading(e){var t;null!=(t=this.mainStreamLoader)&&t.abortSegmentRequest(e),null!=(t=this.secondaryStreamLoader)&&t.abortSegmentRequest(e)}updatePlayback(e,t){var n;null!=(n=this.mainStreamLoader)&&n.updatePlayback(e,t),null!=(n=this.secondaryStreamLoader)&&n.updatePlayback(e,t)}setActiveLevelBitrate(e){e!==this.streamDetails.activeLevelBitrate&&(this.streamDetails.activeLevelBitrate=e,null!=(e=this.mainStreamLoader)&&e.notifyLevelChanged(),null!=(e=this.secondaryStreamLoader))&&e.notifyLevelChanged()}setIsLive(e){this.streamDetails.isLive=e}isSegmentLoadable(e){try{var t=this.identifySegment(e);return!("main"===t.stream.type&&this.mainStreamConfig.isP2PDisabled||"secondary"===t.stream.type&&this.secondaryStreamConfig.isP2PDisabled)}catch{return!1}}destroy(){var e;this.streams.clear(),null!=(e=this.mainStreamLoader)&&e.destroy(),null!=(e=this.secondaryStreamLoader)&&e.destroy(),null!=(e=this.segmentStorage)&&e.destroy(),this.mainStreamLoader=void 0,this.secondaryStreamLoader=void 0,this.segmentStorage=void 0,this.manifestResponseUrl=void 0,this.streamDetails={isLive:!1,activeLevelBitrate:0}}identifySegment(e){if(!this.manifestResponseUrl)throw new Error("Manifest response url is undefined");var t=pn(this.streams,e);if(t)return t;throw new Error("Not found segment with id: "+e)}overrideAllConfigs(e,t,n){dt(this.commonCoreConfig,e),dt(this.mainStreamConfig,e),dt(this.secondaryStreamConfig,e),t&&dt(this.mainStreamConfig,t),n&&dt(this.secondaryStreamConfig,n)}destroyStreamLoader(e){"main"===e?(null!=(e=this.mainStreamLoader)&&e.destroy(),this.mainStreamLoader=void 0):(null!=(e=this.secondaryStreamLoader)&&e.destroy(),this.secondaryStreamLoader=void 0)}getStreamHybridLoader(e){return"main"===e.stream.type?(this.mainStreamLoader??(this.mainStreamLoader=this.createNewHybridLoader(e)),this.mainStreamLoader):(this.secondaryStreamLoader??(this.secondaryStreamLoader=this.createNewHybridLoader(e)),this.secondaryStreamLoader)}createNewHybridLoader(e){var t;if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");if(null!=(t=this.segmentStorage)&&t.isInitialized)return t="main"===e.stream.type?this.mainStreamConfig:this.secondaryStreamConfig,new Wi(this.manifestResponseUrl,e,this.streamDetails,t,this.bandwidthCalculators,this.segmentStorage,this.eventTarget);throw new Error("Segment storage is not initialized")}},zi=(p(xe,"DEFAULT_COMMON_CORE_CONFIG",{cachedSegmentExpiration:void 0,cachedSegmentsCount:0}),p(xe,"DEFAULT_STREAM_CONFIG",{isP2PDisabled:!1,simultaneousHttpDownloads:2,simultaneousP2PDownloads:3,highDemandTimeWindow:15,httpDownloadTimeWindow:3e3,p2pDownloadTimeWindow:6e3,webRtcMaxMessageSize:65535,p2pNotReceivingBytesTimeoutMs:2e3,p2pInactiveLoaderDestroyTimeoutMs:3e4,httpNotReceivingBytesTimeoutMs:3e3,httpErrorRetries:3,p2pErrorRetries:3,trackerClientVersionPrefix:Li,announceTrackers:[],rtcConfig:{iceServers:[]},validateP2PSegment:void 0,httpRequestSetup:void 0,swarmId:void 0}),xe),Vi=Sn.debug;var st,Ot,N,K,G,J,ft,as,Ee,z,Gi=Object.defineProperty,hs=e=>{throw TypeError(e)},x=(e,t,n)=>(n=n,(t="symbol"!=typeof t?t+"":t)in(e=e)?Gi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n),Ie=(e,t,n)=>t.has(e)||hs("Cannot "+n),S=(e,t,n)=>(Ie(e,t,"read from private field"),n?n.call(e):t.get(e)),H=(e,t,n)=>t.has(e)?hs("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),$=(e,t,n,s)=>(Ie(e,t,"write to private field"),t.set(e,n),n),ne=(e,t,n)=>(Ie(e,t,"access private method"),n);function cs(e,t){return t?`${e}|${t.start}-`+t.end:e}function ds(e,t){if(void 0!==e&&void 0!==t&&e<=t)return{start:e,end:t}}class Ji{constructor(e,t){H(this,ft),x(this,"context"),x(this,"config"),x(this,"stats"),H(this,st),H(this,Ot),H(this,N),H(this,K),H(this,G),H(this,J),$(this,K,t),$(this,Ot,()=>new e.loader(e)),this.stats={aborted:!1,chunkCount:0,loading:{start:0,first:0,end:0},buffering:{start:0,first:0,end:0},parsing:{start:0,end:0},total:1,loaded:1,bwEstimate:0,retry:0}}load(t,e,n){this.context=t,this.config=e,$(this,st,n);let s=this.stats,{rangeStart:i,rangeEnd:r}=t,o=ds(i,void 0!==r?r-1:void 0);$(this,J,cs(t.url,o));var a=S(this,K).isSegmentLoadable(S(this,J));S(this,K).hasSegment(S(this,J))&&!1!==a?S(this,K).loadSegment(S(this,J),{onSuccess:e=>{$(this,G,e);e=S(this,G).data.byteLength;s.loading=((e,t,n)=>({start:(t=n-8e3*t/e)-10,first:t,end:n}))(S(this,G).bandwidth,e,performance.now()),s.total=s.loaded=e,n.onProgress&&n.onProgress(this.stats,t,S(this,G).data,void 0),n.onSuccess({data:S(this,G).data,url:t.url},this.stats,t,void 0)},onError:e=>{e instanceof Dt&&"aborted"===e.type&&this.stats.aborted||ne(this,ft,as).call(this,e)}}):($(this,N,S(this,Ot).call(this)),S(this,N).stats=this.stats,null!=(a=S(this,N))&&a.load(t,e,n))}abort(){var e,t;S(this,N)?S(this,N).abort():(ne(this,ft,Ee).call(this),null!=(t=null==(e=S(this,st))?void 0:e.onAbort)&&t.call(e,this.stats,this.context,{}))}destroy(){S(this,N)?S(this,N).destroy():(this.stats.aborted||ne(this,ft,Ee).call(this),$(this,st,null),this.config=null)}}st=new WeakMap,Ot=new WeakMap,N=new WeakMap,K=new WeakMap,G=new WeakMap,J=new WeakMap,ft=new WeakSet,as=function(e){var t={code:0,text:""};(e instanceof Dt&&"failed"===e.type||e instanceof Error)&&(t.text=e.message),null!=(e=S(this,st))&&e.onError(t,this.context,null,this.stats)},Ee=function(){!S(this,G)&&S(this,J)&&(this.stats.aborted=!0,S(this,K).abortSegmentLoading(S(this,J)))};class Yi{constructor(e){H(this,z),x(this,"context"),x(this,"stats"),$(this,z,new e.loader(e)),this.stats=S(this,z).stats,this.context=S(this,z).context}load(e,t,n){S(this,z).load(e,t,n)}abort(){S(this,z).abort()}destroy(){S(this,z).destroy()}}z=new WeakMap;class Ki{constructor(e){x(this,"core"),this.core=e}processMainManifest(e){var t,n,s,i,{levels:e,audioTracks:r}=e;for([t,n]of e.entries()){var o=n.url;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(o)?o[0]:o,type:"main",index:t})}for([s,i]of r.entries()){var a=i.url;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(a)?a[0]:a,type:"secondary",index:s})}}updatePlaylist(n){if(n.details){let{url:e,fragments:t,live:d}=n.details,l=this.core.getStream(e);if(l){let a=new Set(l.segments.keys()),h=[];t.forEach((e,t)=>{var n,{url:e,byteRange:s,sn:i,start:r,end:o}=e;"initSegment"===i||([s,n]=s,n=cs(e,s=ds(s,void 0!==n?n-1:void 0)),a.delete(n),l.segments.has(n))||h.push({runtimeId:n,url:e,externalId:d?i:t,byteRange:s,startTime:r,endTime:o})}),(h.length||a.size)&&this.core.updateStream(e,h,a.values())}}}}class ls{constructor(e){x(this,"core"),x(this,"segmentManager"),x(this,"hlsInstanceGetter"),x(this,"currentHlsInstance"),x(this,"debug",Vi("p2pml-hlsjs:engine")),x(this,"updateMediaElementEventHandlers",e=>{var t=null==(t=this.currentHlsInstance)?void 0:t.media;t&&(t[e="register"===e?"addEventListener":"removeEventListener"]("timeupdate",this.handlePlaybackUpdate),t[e]("seeking",this.handlePlaybackUpdate),t[e]("ratechange",this.handlePlaybackUpdate))}),x(this,"handleManifestLoaded",(e,t)=>{var n=t.networkDetails;n instanceof XMLHttpRequest?this.core.setManifestResponseUrl(n.responseURL):n instanceof Response&&this.core.setManifestResponseUrl(n.url),this.segmentManager.processMainManifest(t)}),x(this,"handleLevelSwitching",(e,t)=>{t.bitrate&&this.core.setActiveLevelBitrate(t.bitrate)}),x(this,"handleLevelUpdated",(e,t)=>{this.currentHlsInstance&&this.currentHlsInstance.config.liveSyncDurationCount!==t.details.fragments.length-1&&t.details.live&&"main"===t.details.fragments[0].type&&!this.currentHlsInstance.userConfig.liveSyncDuration&&!this.currentHlsInstance.userConfig.liveSyncDurationCount&&4<t.details.fragments.length&&(this.debug("set liveSyncDurationCount "+(t.details.fragments.length-1)),this.currentHlsInstance.config.liveSyncDurationCount=t.details.fragments.length-1),this.core.setIsLive(t.details.live),this.segmentManager.updatePlaylist(t)}),x(this,"handleMediaAttached",()=>{this.updateMediaElementEventHandlers("register")}),x(this,"handleMediaDetached",()=>{this.updateMediaElementEventHandlers("unregister")}),x(this,"handlePlaybackUpdate",e=>{e=e.target;this.core.updatePlayback(e.currentTime,e.playbackRate)}),x(this,"destroyCore",()=>this.core.destroy()),x(this,"destroy",()=>{this.destroyCore(),this.updateHlsEventsHandlers("unregister"),this.updateMediaElementEventHandlers("unregister"),this.currentHlsInstance=void 0}),this.core=new zi(null==e?void 0:e.core),this.segmentManager=new Ki(this.core)}static injectMixin(e){return e=e,e=class extends e{constructor(...e){let t,n=e[0],{p2p:s,...i}=n??{},r=new ls(s);super({...i,...r.getConfigForHlsJs()}),H(this,o),r.bindHls(this),$(this,o,r),null!=(t=null==s?void 0:s.onHlsJsCreated)&&t.call(s,this)}get p2pEngine(){return S(this,o)}},o=new WeakMap,e;var o}addEventListener(e,t){this.core.addEventListener(e,t)}removeEventListener(e,t){this.core.removeEventListener(e,t)}getConfigForHlsJs(){return{fLoader:this.createFragmentLoaderClass(),pLoader:this.createPlaylistLoaderClass()}}getConfig(){return{core:this.core.getConfig()}}applyDynamicConfig(e){e.core&&this.core.applyDynamicConfig(e.core)}bindHls(e){this.hlsInstanceGetter="function"==typeof e?e:()=>e}initHlsEvents(){var e=null==(e=this.hlsInstanceGetter)?void 0:e.call(this);this.currentHlsInstance!==e&&(this.currentHlsInstance&&this.destroy(),this.currentHlsInstance=e,this.updateHlsEventsHandlers("register"),this.updateMediaElementEventHandlers("register"))}updateHlsEventsHandlers(e){var t=this.currentHlsInstance;t&&(t[e="register"===e?"on":"off"]("hlsManifestLoaded",this.handleManifestLoaded),t[e]("hlsLevelSwitching",this.handleLevelSwitching),t[e]("hlsLevelUpdated",this.handleLevelUpdated),t[e]("hlsAudioTrackLoaded",this.handleLevelUpdated),t[e]("hlsDestroying",this.destroy),t[e]("hlsMediaAttaching",this.destroyCore),t[e]("hlsManifestLoading",this.destroyCore),t[e]("hlsMediaDetached",this.handleMediaDetached),t[e]("hlsMediaAttached",this.handleMediaAttached))}createFragmentLoaderClass(){let t=this.core,e=this;return class extends Ji{constructor(e){super(e,t)}static getEngine(){return e}}}createPlaylistLoaderClass(){let t=this;return class extends Yi{constructor(e){super(e),t.initHlsEvents()}}}}export{ls as HlsJsP2PEngine};