var us=Object.defineProperty,p=(s,t,e)=>((n,i,r)=>i in n?us(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r)(s,typeof t!="symbol"?t+"":t,e);class B extends Error{constructor(t,e){super(e),p(this,"timestamp"),this.type=t,this.timestamp=performance.now()}}class Dt extends Error{constructor(t){super(),this.type=t}}class gs{constructor(t,e,n){p(this,"requestControls"),p(this,"abortController",new AbortController()),p(this,"expectedBytesLength"),p(this,"requestByteRange"),p(this,"onChunkDownloaded"),this.request=t,this.httpConfig=e,this.onChunkDownloaded=n.getEventDispatcher("onChunkDownloaded");const{byteRange:i}=this.request.segment;i&&(this.requestByteRange={...i}),t.loadedBytes!==0&&(this.requestByteRange=this.requestByteRange??{start:0},this.requestByteRange.start=this.requestByteRange.start+t.loadedBytes),this.request.totalBytes&&(this.expectedBytesLength=this.request.totalBytes-this.request.loadedBytes),this.requestControls=this.request.start({downloadSource:"http"},{abort:()=>this.abortController.abort("abort"),notReceivingBytesTimeoutMs:this.httpConfig.httpNotReceivingBytesTimeoutMs}),this.fetch()}async fetch(){var t,e;const{segment:n}=this.request;try{let i=await((e=(t=this.httpConfig).httpRequestSetup)==null?void 0:e.call(t,n.url,n.byteRange,this.abortController.signal,this.requestByteRange));if(!i){const h=new Headers(this.requestByteRange?{Range:`bytes=${this.requestByteRange.start}-${this.requestByteRange.end??""}`}:void 0);i=new Request(n.url,{headers:h,signal:this.abortController.signal})}if(this.abortController.signal.aborted)throw new DOMException("Request aborted before request fetch","AbortError");const r=await window.fetch(i);if(this.handleResponseHeaders(r),!r.body)return;const{requestControls:o}=this;o.firstBytesReceived();const a=r.body.getReader();for await(const h of async function*(c){for(;;){const{done:d,value:f}=await c.read();if(d)break;yield f}}(a))this.requestControls.addLoadedChunk(h),this.onChunkDownloaded(h.byteLength,"http");o.completeOnSuccess()}catch(i){this.handleError(i)}}handleResponseHeaders(t){if(!t.ok)throw t.status===406?(this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText)):new B("http-error",t.statusText);const{requestByteRange:e}=this;if(e)if(t.status===200){if(this.request.segment.byteRange)throw new B("http-unexpected-status-code");this.request.clearLoadedBytes()}else{if(t.status!==206)throw new B("http-unexpected-status-code",t.statusText);const n=t.headers.get("Content-Length");if(n&&this.expectedBytesLength!==void 0&&this.expectedBytesLength!==+n)throw this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText);const i=t.headers.get("Content-Range"),r=i?function(o){const a=o.trim().match(/^bytes (?:(?:(\d+)|)-(?:(\d+)|)|\*)\/(?:(\d+)|\*)$/);if(!a)return;const[,h,c,d]=a;return{from:h?parseInt(h):void 0,to:c?parseInt(c):void 0,total:d?parseInt(d):void 0}}(i):void 0;if(r){const{from:o,to:a,total:h}=r;if(h!==void 0&&this.request.totalBytes!==h||o!==void 0&&e.start!==o||a!==void 0&&e.end!==void 0&&e.end!==a)throw this.request.clearLoadedBytes(),new B("http-bytes-mismatch",t.statusText);}}if(t.status===200&&this.request.totalBytes===void 0){const n=t.headers.get("Content-Length");n&&this.request.setTotalBytes(+n)}}handleError(t){if(t instanceof Error){if(t.name!=="abort")return;const e=t instanceof B?t:new B("http-error",t.message);this.requestControls.abortOnError(e)}}}function fs(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var U,F,_n={exports:{}},L=_n.exports={};function se(){throw new Error("setTimeout has not been defined");}function ie(){throw new Error("clearTimeout has not been defined");}function bn(s){if(U===setTimeout)return setTimeout(s,0);if((U===se||!U)&&setTimeout)return U=setTimeout,setTimeout(s,0);try{return U(s,0)}catch{try{return U.call(null,s,0)}catch{return U.call(this,s,0)}}}(function(){try{U=typeof setTimeout=="function"?setTimeout:se}catch{U=se}try{F=typeof clearTimeout=="function"?clearTimeout:ie}catch{F=ie}})();var X,j=[],it=!1,Tt=-1;function ps(){it&&X&&(it=!1,X.length?j=X.concat(j):Tt=-1,j.length&&wn())}function wn(){if(!it){var s=bn(ps);it=!0;for(var t=j.length;t;){for(X=j,j=[];++Tt<t;)X&&X[Tt].run();Tt=-1,t=j.length}X=null,it=!1,function(e){if(F===clearTimeout)return clearTimeout(e);if((F===ie||!F)&&clearTimeout)return F=clearTimeout,clearTimeout(e);try{return F(e)}catch{try{return F.call(null,e)}catch{return F.call(this,e)}}}(s)}}function Re(s,t){this.fun=s,this.array=t}function D(){}L.nextTick=function(s){var t=new Array(arguments.length-1);if(arguments.length>1)for(var e=1;e<arguments.length;e++)t[e-1]=arguments[e];j.push(new Re(s,t)),j.length!==1||it||bn(wn)},Re.prototype.run=function(){this.fun.apply(null,this.array)},L.title="browser",L.browser=!0,L.env={},L.argv=[],L.version="",L.versions={},L.on=D,L.addListener=D,L.once=D,L.off=D,L.removeListener=D,L.removeAllListeners=D,L.emit=D,L.prependListener=D,L.prependOnceListener=D,L.listeners=function(s){return[]},L.binding=function(s){throw new Error("process.binding is not supported");},L.cwd=function(){return"/"},L.chdir=function(s){throw new Error("process.chdir is not supported");},L.umask=function(){return 0};const It=fs(_n.exports);var ms=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function et(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Pe,Be,re={exports:{}};function ys(){if(Be)return Pe;Be=1;var s=1e3,t=60*s,e=60*t,n=24*e,i=7*n,r=365.25*n;function o(a,h,c,d){var f=h>=1.5*c;return Math.round(a/c)+" "+d+(f?"s":"")}return Pe=function(a,h){h=h||{};var c=typeof a;if(c==="string"&&a.length>0)return function(d){if(!((d=String(d)).length>100)){var f=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(d);if(f){var y=parseFloat(f[1]);switch((f[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return y*r;case"weeks":case"week":case"w":return y*i;case"days":case"day":case"d":return y*n;case"hours":case"hour":case"hrs":case"hr":case"h":return y*e;case"minutes":case"minute":case"mins":case"min":case"m":return y*t;case"seconds":case"second":case"secs":case"sec":case"s":return y*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return y;default:return}}}}(a);if(c==="number"&&isFinite(a))return h.long?function(d){var f=Math.abs(d);return f>=n?o(d,f,n,"day"):f>=e?o(d,f,e,"hour"):f>=t?o(d,f,t,"minute"):f>=s?o(d,f,s,"second"):d+" ms"}(a):function(d){var f=Math.abs(d);return f>=n?Math.round(d/n)+"d":f>=e?Math.round(d/e)+"h":f>=t?Math.round(d/t)+"m":f>=s?Math.round(d/s)+"s":d+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a));}}var _s=function(s){function t(i){let r,o,a,h=null;function c(...d){if(!c.enabled)return;const f=c,y=Number(new Date()),b=y-(r||y);f.diff=b,f.prev=r,f.curr=y,r=y,d[0]=t.coerce(d[0]),typeof d[0]!="string"&&d.unshift("%O");let l=0;d[0]=d[0].replace(/%([a-zA-Z%])/g,(g,u)=>{if(g==="%%")return"%";l++;const m=t.formatters[u];if(typeof m=="function"){const _=d[l];g=m.call(f,_),d.splice(l,1),l--}return g}),t.formatArgs.call(f,d),(f.log||t.log).apply(f,d)}return c.namespace=i,c.useColors=t.useColors(),c.color=t.selectColor(i),c.extend=e,c.destroy=t.destroy,Object.defineProperty(c,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(o!==t.namespaces&&(o=t.namespaces,a=t.enabled(i)),a),set:(d)=>{h=d}}),typeof t.init=="function"&&t.init(c),c}function e(i,r){const o=t(this.namespace+(r===void 0?":":r)+i);return o.log=this.log,o}function n(i){return i.toString().substring(2,i.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(i){return i instanceof Error?i.stack||i.message:i},t.disable=function(){const i=[...t.names.map(n),...t.skips.map(n).map((r)=>"-"+r)].join(",");return t.enable(""),i},t.enable=function(i){let r;t.save(i),t.namespaces=i,t.names=[],t.skips=[];const o=(typeof i=="string"?i:"").split(/[\s,]+/),a=o.length;for(r=0;r<a;r++)o[r]&&((i=o[r].replace(/\*/g,".*?"))[0]==="-"?t.skips.push(new RegExp("^"+i.slice(1)+"$")):t.names.push(new RegExp("^"+i+"$")))},t.enabled=function(i){if(i[i.length-1]==="*")return!0;let r,o;for(r=0,o=t.skips.length;r<o;r++)if(t.skips[r].test(i))return!1;for(r=0,o=t.names.length;r<o;r++)if(t.names[r].test(i))return!0;return!1},t.humanize=ys(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(s).forEach((i)=>{t[i]=s[i]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(i){let r=0;for(let o=0;o<i.length;o++)r=(r<<5)-r+i.charCodeAt(o),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t};(function(s,t){t.formatArgs=function(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;n.splice(1,0,i,"color: inherit");let r=0,o=0;n[0].replace(/%[a-zA-Z%]/g,(a)=>{a!=="%%"&&(r++,a==="%c"&&(o=r))}),n.splice(o,0,i)},t.save=function(n){try{n?t.storage.setItem("debug",n):t.storage.removeItem("debug")}catch{}},t.load=function(){let n;try{n=t.storage.getItem("debug")}catch{}return!n&&It!==void 0&&"env"in It&&(n=It.env.DEBUG),n},t.useColors=function(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let n;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(n=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(n[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch{}}(),t.destroy=(()=>{let n=!1;return()=>{n||(n=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),s.exports=_s(t);const{formatters:e}=s.exports;e.j=function(n){try{return JSON.stringify(n)}catch(i){return"[UnexpectedJSONParseError]: "+i.message}}})(re,re.exports);var Sn=re.exports;const O=et(Sn);var vn,oe={exports:{}},rt=typeof Reflect=="object"?Reflect:null,qe=rt&&typeof rt.apply=="function"?rt.apply:function(s,t,e){return Function.prototype.apply.call(s,t,e)};vn=rt&&typeof rt.ownKeys=="function"?rt.ownKeys:Object.getOwnPropertySymbols?function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:function(s){return Object.getOwnPropertyNames(s)};var Oe=Number.isNaN||function(s){return s!=s};function v(){v.init.call(this)}oe.exports=v,oe.exports.once=function(s,t){return new Promise(function(e,n){function i(o){s.removeListener(t,r),n(o)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",i),e([].slice.call(arguments))}He(s,t,r,{once:!0}),t!=="error"&&function(o,a,h){typeof o.on=="function"&&He(o,"error",a,h)}(s,i,{once:!0})})},v.EventEmitter=v,v.prototype._events=void 0,v.prototype._eventsCount=0,v.prototype._maxListeners=void 0;var De=10;function Rt(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s);}function Cn(s){return s._maxListeners===void 0?v.defaultMaxListeners:s._maxListeners}function Me(s,t,e,n){var i,r,o,a;if(Rt(e),(r=s._events)===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",t,e.listener?e.listener:e),r=s._events),o=r[t]),o===void 0)o=r[t]=e,++s._eventsCount;else if(typeof o=="function"?o=r[t]=n?[e,o]:[o,e]:n?o.unshift(e):o.push(e),(i=Cn(s))>0&&o.length>i&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=s,h.type=t,h.count=o.length,a=h,console&&console.warn&&console.warn(a)}return s}function bs(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ne(s,t,e){var n={fired:!1,wrapFn:void 0,target:s,type:t,listener:e},i=bs.bind(n);return i.listener=e,n.wrapFn=i,i}function Ue(s,t,e){var n=s._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?function(r){for(var o=new Array(r.length),a=0;a<o.length;++a)o[a]=r[a].listener||r[a];return o}(i):Ln(i,i.length)}function Fe(s){var t=this._events;if(t!==void 0){var e=t[s];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}function Ln(s,t){for(var e=new Array(t),n=0;n<t;++n)e[n]=s[n];return e}function He(s,t,e,n){if(typeof s.on=="function")n.once?s.once(t,e):s.on(t,e);else{if(typeof s.addEventListener!="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s);s.addEventListener(t,function i(r){n.once&&s.removeEventListener(t,i),e(r)})}}Object.defineProperty(v,"defaultMaxListeners",{enumerable:!0,get:function(){return De},set:function(s){if(typeof s!="number"||s<0||Oe(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");De=s}}),v.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},v.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||Oe(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this},v.prototype.getMaxListeners=function(){return Cn(this)},v.prototype.emit=function(s){for(var t=[],e=1;e<arguments.length;e++)t.push(arguments[e]);var n=s==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var o=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw o.context=r,o;}var a=i[s];if(a===void 0)return!1;if(typeof a=="function")qe(a,this,t);else{var h=a.length,c=Ln(a,h);for(e=0;e<h;++e)qe(c[e],this,t)}return!0},v.prototype.addListener=function(s,t){return Me(this,s,t,!1)},v.prototype.on=v.prototype.addListener,v.prototype.prependListener=function(s,t){return Me(this,s,t,!0)},v.prototype.once=function(s,t){return Rt(t),this.on(s,Ne(this,s,t)),this},v.prototype.prependOnceListener=function(s,t){return Rt(t),this.prependListener(s,Ne(this,s,t)),this},v.prototype.removeListener=function(s,t){var e,n,i,r,o;if(Rt(t),(n=this._events)===void 0)return this;if((e=n[s])===void 0)return this;if(e===t||e.listener===t)--this._eventsCount==0?this._events=Object.create(null):(delete n[s],n.removeListener&&this.emit("removeListener",s,e.listener||t));else if(typeof e!="function"){for(i=-1,r=e.length-1;r>=0;r--)if(e[r]===t||e[r].listener===t){o=e[r].listener,i=r;break}if(i<0)return this;i===0?e.shift():function(a,h){for(;h+1<a.length;h++)a[h]=a[h+1];a.pop()}(e,i),e.length===1&&(n[s]=e[0]),n.removeListener!==void 0&&this.emit("removeListener",s,o||t)}return this},v.prototype.off=v.prototype.removeListener,v.prototype.removeAllListeners=function(s){var t,e,n;if((e=this._events)===void 0)return this;if(e.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):e[s]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete e[s]),this;if(arguments.length===0){var i,r=Object.keys(e);for(n=0;n<r.length;++n)(i=r[n])!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(t=e[s])=="function")this.removeListener(s,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(s,t[n]);return this},v.prototype.listeners=function(s){return Ue(this,s,!0)},v.prototype.rawListeners=function(s){return Ue(this,s,!1)},v.listenerCount=function(s,t){return typeof s.listenerCount=="function"?s.listenerCount(t):Fe.call(s,t)},v.prototype.listenerCount=Fe,v.prototype.eventNames=function(){return this._eventsCount>0?vn(this._events):[]};var kn=oe.exports;const xn=et(kn);var ae={exports:{}},ws=function s(t,e){if(t&&e)return s(t)(e);if(typeof t!="function")throw new TypeError("need wrapper function");return Object.keys(t).forEach(function(i){n[i]=t[i]}),n;function n(){for(var i=new Array(arguments.length),r=0;r<i.length;r++)i[r]=arguments[r];var o=t.apply(this,i),a=i[i.length-1];return typeof o=="function"&&o!==a&&Object.keys(a).forEach(function(h){o[h]=a[h]}),o}},$e=ws;function St(s){var t=function(){return t.called?t.value:(t.called=!0,t.value=s.apply(this,arguments))};return t.called=!1,t}function je(s){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=s.apply(this,arguments)},e=s.name||"Function wrapped with `once`";return t.onceError=e+" shouldn't be called more than once",t.called=!1,t}ae.exports=$e(St),ae.exports.strict=$e(je),St.proto=St(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return St(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return je(this)},configurable:!0})});const Ss=et(ae.exports);let We;var En=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:ms):(s)=>(We||(We=Promise.resolve())).then(s).catch((t)=>setTimeout(()=>{throw t;},0));const he=et(En);var vs=function(s,t){let e,n,i,r=!0;Array.isArray(s)?(e=[],n=s.length):(i=Object.keys(s),e={},n=i.length);function o(h){function c(){t&&t(h,e),t=null}r?Cs(c):c()}function a(h,c,d){e[h]=d,(--n==0||c)&&o(c)}n?i?i.forEach(function(h){s[h](function(c,d){a(h,c,d)})}):s.forEach(function(h,c){h(function(d,f){a(c,d,f)})}):o(null),r=!1};const Cs=En,Ls=et(vs),W=typeof window<"u"?window:self,ce=W.RTCPeerConnection||W.mozRTCPeerConnection||W.webkitRTCPeerConnection,ks=W.RTCSessionDescription||W.mozRTCSessionDescription||W.webkitRTCSessionDescription,xs=W.RTCIceCandidate||W.mozRTCIceCandidate||W.webkitRTCIceCandidate;var Es=typeof queueMicrotask=="function"?queueMicrotask:(s)=>Promise.resolve().then(s);const Qe=class{constructor(s){if(!(s>0)||s-1&s)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(s),this.mask=s-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(s){return this.buffer[this.top]===void 0&&(this.buffer[this.top]=s,this.top=this.top+1&this.mask,!0)}shift(){const s=this.buffer[this.btm];if(s!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,s}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}};var de={exports:{}};function ze(s){return s.length}var As={byteLength:ze,toString:function(s){const t=s.byteLength;let e="";for(let n=0;n<t;n++)e+=String.fromCharCode(s[n]);return e},write:function(s,t,e=0,n=ze(t)){const i=Math.min(n,s.byteLength-e);for(let r=0;r<i;r++)s[e+r]=t.charCodeAt(r);return i}};const lt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Z=new Uint8Array(256);for(let s=0;s<64;s++)Z[lt.charCodeAt(s)]=s;function Ve(s){let t=s.length;return s.charCodeAt(t-1)===61&&t--,t>1&&s.charCodeAt(t-1)===61&&t--,3*t>>>2}Z[45]=62,Z[95]=63;var Ts={byteLength:Ve,toString:function(s){const t=s.byteLength;let e="";for(let n=0;n<t;n+=3)e+=lt[s[n]>>2]+lt[(3&s[n])<<4|s[n+1]>>4]+lt[(15&s[n+1])<<2|s[n+2]>>6]+lt[63&s[n+2]];return t%3==2?e=e.substring(0,e.length-1)+"=":t%3==1&&(e=e.substring(0,e.length-2)+"=="),e},write:function(s,t,e=0,n=Ve(t)){const i=Math.min(n,s.byteLength-e);for(let r=0,o=0;o<i;r+=4){const a=Z[t.charCodeAt(r)],h=Z[t.charCodeAt(r+1)],c=Z[t.charCodeAt(r+2)],d=Z[t.charCodeAt(r+3)];s[o++]=a<<2|h>>4,s[o++]=(15&h)<<4|c>>2,s[o++]=(3&c)<<6|63&d}return i}};function Ge(s){return s.length>>>1}var Is={byteLength:Ge,toString:function(s){const t=s.byteLength;s=new DataView(s.buffer,s.byteOffset,t);let e="",n=0;for(let i=t-t%4;n<i;n+=4)e+=s.getUint32(n).toString(16).padStart(8,"0");for(;n<t;n++)e+=s.getUint8(n).toString(16).padStart(2,"0");return e},write:function(s,t,e=0,n=Ge(t)){const i=Math.min(n,s.byteLength-e);for(let r=0;r<i;r++){const o=Je(t.charCodeAt(2*r)),a=Je(t.charCodeAt(2*r+1));if(o===void 0||a===void 0)return s.subarray(0,r);s[e+r]=o<<4|a}return i}};function Je(s){return s>=48&&s<=57?s-48:s>=65&&s<=70?s-65+10:s>=97&&s<=102?s-97+10:void 0}function le(s){let t=0;for(let e=0,n=s.length;e<n;e++){const i=s.charCodeAt(e);if(i>=55296&&i<=56319&&e+1<n){const r=s.charCodeAt(e+1);if(r>=56320&&r<=57343){t+=4,e++;continue}}t+=i<=127?1:i<=2047?2:3}return t}let ue,ge;if(typeof TextDecoder<"u"){const s=new TextDecoder();ue=function(t){return s.decode(t)}}else ue=function(s){const t=s.byteLength;let e="",n=0;for(;n<t;){let i=s[n];if(i<=127){e+=String.fromCharCode(i),n++;continue}let r=0,o=0;if(i<=223?(r=1,o=31&i):i<=239?(r=2,o=15&i):i<=244&&(r=3,o=7&i),t-n-r>0){let a=0;for(;a<r;)i=s[n+a+1],o=o<<6|63&i,a+=1}else o=65533,r=t-n;e+=String.fromCodePoint(o),n+=r+1}return e};if(typeof TextEncoder<"u"){const s=new TextEncoder();ge=function(t,e,n=0,i=le(e)){const r=Math.min(i,t.byteLength-n);return s.encodeInto(e,t.subarray(n,n+r)),r}}else ge=function(s,t,e=0,n=le(t)){const i=Math.min(n,s.byteLength-e);s=s.subarray(e,e+i);let r=0,o=0;for(;r<t.length;){const a=t.codePointAt(r);if(a<=127){s[o++]=a,r++;continue}let h=0,c=0;for(a<=2047?(h=6,c=192):a<=65535?(h=12,c=224):a<=2097151&&(h=18,c=240),s[o++]=c|a>>h,h-=6;h>=0;)s[o++]=128|a>>h&63,h-=6;r+=a>=65536?2:1}return i};var Rs={byteLength:le,toString:ue,write:ge};function Ye(s){return 2*s.length}var Ps={byteLength:Ye,toString:function(s){const t=s.byteLength;let e="";for(let n=0;n<t-1;n+=2)e+=String.fromCharCode(s[n]+256*s[n+1]);return e},write:function(s,t,e=0,n=Ye(t)){const i=Math.min(n,s.byteLength-e);let r=i;for(let o=0;o<t.length&&!((r-=2)<0);++o){const a=t.charCodeAt(o),h=a>>8,c=a%256;s[e+2*o]=c,s[e+2*o+1]=h}return i}};(function(s,t){const e=As,n=Ts,i=Is,r=Rs,o=Ps,a=new Uint8Array(Uint16Array.of(255).buffer)[0]===255;function h(l){switch(l){case"ascii":return e;case"base64":return n;case"hex":return i;case"utf8":case"utf-8":case void 0:return r;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return o;default:throw new Error(`Unknown encoding:${l}`)}}function c(l){return l instanceof Uint8Array}function d(l,g,u){return typeof l=="string"?function(m,_){const w=h(_),k=new Uint8Array(w.byteLength(m));return w.write(k,m,0,k.byteLength),k}(l,g):Array.isArray(l)?function(m){const _=new Uint8Array(m.length);return _.set(m),_}(l):ArrayBuffer.isView(l)?function(m){const _=new Uint8Array(m.byteLength);return _.set(m),_}(l):function(m,_,w){return new Uint8Array(m,_,w)}(l,g,u)}function f(l,g,u,m,_){if(l.byteLength===0)return-1;if(typeof u=="string"?(m=u,u=0):u===void 0?u=_?0:l.length-1:u<0&&(u+=l.byteLength),u>=l.byteLength){if(_)return-1;u=l.byteLength-1}else if(u<0){if(!_)return-1;u=0}if(typeof g=="string")g=d(g,m);else if(typeof g=="number")return g&=255,_?l.indexOf(g,u):l.lastIndexOf(g,u);if(g.byteLength===0)return-1;if(_){let w=-1;for(let k=u;k<l.byteLength;k++)if(l[k]===g[w===-1?0:k-w]){if(w===-1&&(w=k),k-w+1===g.byteLength)return w}else w!==-1&&(k-=k-w),w=-1}else{u+g.byteLength>l.byteLength&&(u=l.byteLength-g.byteLength);for(let w=u;w>=0;w--){let k=!0;for(let wt=0;wt<g.byteLength;wt++)if(l[w+wt]!==g[wt]){k=!1;break}if(k)return w}}return-1}function y(l,g,u,m){return f(l,g,u,m,!0)}function b(l,g,u){const m=l[g];l[g]=l[u],l[u]=m}s.exports=t={isBuffer:c,isEncoding:function(l){try{return h(l),!0}catch{return!1}},alloc:function(l,g,u){const m=new Uint8Array(l);return g!==void 0&&t.fill(m,g,0,m.byteLength,u),m},allocUnsafe:function(l){return new Uint8Array(l)},allocUnsafeSlow:function(l){return new Uint8Array(l)},byteLength:function(l,g){return h(g).byteLength(l)},compare:function(l,g){if(l===g)return 0;const u=Math.min(l.byteLength,g.byteLength);l=new DataView(l.buffer,l.byteOffset,l.byteLength),g=new DataView(g.buffer,g.byteOffset,g.byteLength);let m=0;for(let _=u-u%4;m<_&&l.getUint32(m,a)===g.getUint32(m,a);m+=4);for(;m<u;m++){const _=l.getUint8(m),w=g.getUint8(m);if(_<w)return-1;if(_>w)return 1}return l.byteLength>g.byteLength?1:l.byteLength<g.byteLength?-1:0},concat:function(l,g){g===void 0&&(g=l.reduce((_,w)=>_+w.byteLength,0));const u=new Uint8Array(g);let m=0;for(const _ of l){if(m+_.byteLength>u.byteLength){const w=_.subarray(0,u.byteLength-m);return u.set(w,m),u}u.set(_,m),m+=_.byteLength}return u},copy:function(l,g,u=0,m=0,_=l.byteLength){if(_>0&&_<m||_===m||l.byteLength===0||g.byteLength===0)return 0;if(u<0)throw new RangeError("targetStart is out of range");if(m<0||m>=l.byteLength)throw new RangeError("sourceStart is out of range");if(_<0)throw new RangeError("sourceEnd is out of range");u>=g.byteLength&&(u=g.byteLength),_>l.byteLength&&(_=l.byteLength),g.byteLength-u<_-m&&(_=g.length-u+m);const w=_-m;return l===g?g.copyWithin(u,m,_):g.set(l.subarray(m,_),u),w},equals:function(l,g){if(l===g)return!0;if(l.byteLength!==g.byteLength)return!1;const u=l.byteLength;l=new DataView(l.buffer,l.byteOffset,l.byteLength),g=new DataView(g.buffer,g.byteOffset,g.byteLength);let m=0;for(let _=u-u%4;m<_;m+=4)if(l.getUint32(m,a)!==g.getUint32(m,a))return!1;for(;m<u;m++)if(l.getUint8(m)!==g.getUint8(m))return!1;return!0},fill:function(l,g,u,m,_){if(typeof g=="string"?typeof u=="string"?(_=u,u=0,m=l.byteLength):typeof m=="string"&&(_=m,m=l.byteLength):typeof g=="number"?g&=255:typeof g=="boolean"&&(g=+g),u<0||l.byteLength<u||l.byteLength<m)throw new RangeError("Out of range index");if(u===void 0&&(u=0),m===void 0&&(m=l.byteLength),m<=u)return l;if(g||(g=0),typeof g=="number")for(let w=u;w<m;++w)l[w]=g;else{const w=(g=c(g)?g:d(g,_)).byteLength;for(let k=0;k<m-u;++k)l[k+u]=g[k%w]}return l},from:d,includes:function(l,g,u,m){return y(l,g,u,m)!==-1},indexOf:y,lastIndexOf:function(l,g,u,m){return f(l,g,u,m,!1)},swap16:function(l){const g=l.byteLength;if(g%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let u=0;u<g;u+=2)b(l,u,u+1);return l},swap32:function(l){const g=l.byteLength;if(g%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let u=0;u<g;u+=4)b(l,u,u+3),b(l,u+1,u+2);return l},swap64:function(l){const g=l.byteLength;if(g%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let u=0;u<g;u+=8)b(l,u,u+7),b(l,u+1,u+6),b(l,u+2,u+5),b(l,u+3,u+4);return l},toBuffer:function(l){return l},toString:function(l,g,u=0,m=l.byteLength){const _=l.byteLength;return u>=_||m<=u?"":(u<0&&(u=0),m>_&&(m=_),(u!==0||m<_)&&(l=l.subarray(u,m)),h(g).toString(l))},write:function(l,g,u,m,_){return u===void 0?_="utf8":m===void 0&&typeof u=="string"?(_=u,u=void 0):_===void 0&&typeof m=="string"&&(_=m,m=void 0),h(_).write(l,g,u,m)},writeDoubleLE:function(l,g,u){return u===void 0&&(u=0),new DataView(l.buffer,l.byteOffset,l.byteLength).setFloat64(u,g,!0),u+8},writeFloatLE:function(l,g,u){return u===void 0&&(u=0),new DataView(l.buffer,l.byteOffset,l.byteLength).setFloat32(u,g,!0),u+4},writeUInt32LE:function(l,g,u){return u===void 0&&(u=0),new DataView(l.buffer,l.byteOffset,l.byteLength).setUint32(u,g,!0),u+4},writeInt32LE:function(l,g,u){return u===void 0&&(u=0),new DataView(l.buffer,l.byteOffset,l.byteLength).setInt32(u,g,!0),u+4},readDoubleLE:function(l,g){return g===void 0&&(g=0),new DataView(l.buffer,l.byteOffset,l.byteLength).getFloat64(g,!0)},readFloatLE:function(l,g){return g===void 0&&(g=0),new DataView(l.buffer,l.byteOffset,l.byteLength).getFloat32(g,!0)},readUInt32LE:function(l,g){return g===void 0&&(g=0),new DataView(l.buffer,l.byteOffset,l.byteLength).getUint32(g,!0)},readInt32LE:function(l,g){return g===void 0&&(g=0),new DataView(l.buffer,l.byteOffset,l.byteLength).getInt32(g,!0)}}})(de,de.exports);var An=de.exports;const Bs=An,qs=An,Os=class{constructor(s){this.encoding=s}decode(s){return Bs.toString(s,this.encoding)}flush(){return""}},Ds=class{constructor(){this.codePoint=0,this.bytesSeen=0,this.bytesNeeded=0,this.lowerBoundary=128,this.upperBoundary=191}decode(s){if(this.bytesNeeded===0){let e=!0;for(let n=Math.max(0,s.byteLength-4),i=s.byteLength;n<i&&e;n++)e=s[n]<=127;if(e)return qs.toString(s,"utf8")}let t="";for(let e=0,n=s.byteLength;e<n;e++){const i=s[e];this.bytesNeeded!==0?i<this.lowerBoundary||i>this.upperBoundary?(this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,t+="�"):(this.lowerBoundary=128,this.upperBoundary=191,this.codePoint=this.codePoint<<6|63&i,this.bytesSeen++,this.bytesSeen===this.bytesNeeded&&(t+=String.fromCodePoint(this.codePoint),this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0)):i<=127?t+=String.fromCharCode(i):i>=194&&i<=223?(this.bytesNeeded=1,this.codePoint=31&i):i>=224&&i<=239?(i===224?this.lowerBoundary=160:i===237&&(this.upperBoundary=159),this.bytesNeeded=2,this.codePoint=15&i):i>=240&&i<=244?(i===240&&(this.lowerBoundary=144),i===244&&(this.upperBoundary=143),this.bytesNeeded=3,this.codePoint=7&i):t+="�"}return t}flush(){const s=this.bytesNeeded>0?"�":"";return this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,s}},{EventEmitter:Ms}=kn,Ae=new Error("Stream was destroyed"),Tn=(new Error("Premature close"),Es),In=class{constructor(s){this.hwm=s||16,this.head=new Qe(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(s){if(this.length++,!this.head.push(s)){const t=this.head;this.head=t.next=new Qe(2*this.head.buffer.length),this.head.push(s)}}shift(){this.length!==0&&this.length--;const s=this.tail.shift();if(s===void 0&&this.tail.next){const t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return s}peek(){const s=this.tail.peek();return s===void 0&&this.tail.next?this.tail.next.peek():s}isEmpty(){return this.length===0}},Ns=class{constructor(s="utf8"){switch(this.encoding=function(t){switch(t=t.toLowerCase()){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return t;default:throw new Error("Unknown encoding: "+t);}}(s),this.encoding){case"utf8":this.decoder=new Ds();break;case"utf16le":case"base64":throw new Error("Unsupported encoding: "+this.encoding);default:this.decoder=new Os(this.encoding)}}push(s){return typeof s=="string"?s:this.decoder.decode(s)}write(s){return this.push(s)}end(s){let t="";return s&&(t=this.push(s)),t+=this.decoder.flush(),t}},bt=536870911,Rn=1^bt,Us=2^bt,Pn=64,Ke=128,Bn=256,Fs=1024,Xe=2048,Hs=4096,$s=8192,Mt=16384,Jt=32768,fe=131072,js=131328,Ws=16^bt,Ze=768^bt,qn=536838143,Qs=32^bt,On=536739839,Nt=2<<18,Dn=4<<18,tn=8<<18,zs=16<<18,Mn=32<<18,pe=64<<18,Yt=128<<18,en=512<<18,Vs=1024<<18,Nn=469499903,Gs=535822335,Un=503316479,Js=268435455,Ut=262160,Ys=536608751,Fn=8404992,yt=14,Ks=15,Hn=8405006,$n=33587200,jn=33587215,Xs=2359296,nn=270794767,vt=Symbol.asyncIterator||Symbol("asyncIterator");class Zs{constructor(t,{highWaterMark:e=16384,map:n=null,mapWritable:i,byteLength:r,byteLengthWritable:o}={}){this.stream=t,this.queue=new In(),this.highWaterMark=e,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=o||r||Vn,this.map=i||n,this.afterWrite=ii.bind(this),this.afterUpdateNextTick=ai.bind(this)}get ended(){return!!(this.stream._duplexState&Mn)}push(t){return this.map!==null&&(t=this.map(t)),this.buffered+=this.byteLength(t),this.queue.push(t),this.buffered<this.highWaterMark?(this.stream._duplexState|=tn,!0):(this.stream._duplexState|=6291456,!1)}shift(){const t=this.queue.shift();return this.buffered-=this.byteLength(t),this.buffered===0&&(this.stream._duplexState&=534773759),t}end(t){typeof t=="function"?this.stream.once("finish",t):t!=null&&this.push(t),this.stream._duplexState=(this.stream._duplexState|en)&Gs}autoBatch(t,e){const n=[],i=this.stream;for(n.push(t);(i._duplexState&nn)===Xs;)n.push(i._writableState.shift());if(i._duplexState&Ks)return e(null);i._writev(n,e)}update(){const t=this.stream;t._duplexState|=Nt;do{for(;(t._duplexState&nn)===tn;){const e=this.shift();t._duplexState|=67371008,t._write(e,this.afterWrite)}1310720&t._duplexState||this.updateNonPrimary()}while(this.continueUpdate()===!0);t._duplexState&=536346623}updateNonPrimary(){const t=this.stream;if((144965647&t._duplexState)===en)return t._duplexState=402653183&t._duplexState|262144,void t._final(si.bind(this));(t._duplexState&yt)!=4?(t._duplexState&jn)==1&&(t._duplexState=(t._duplexState|Ut)&Rn,t._open(Qn.bind(this))):t._duplexState&$n||(t._duplexState|=Ut,t._destroy(Wn.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&Yt)&&(this.stream._duplexState&=Un,!0)}updateCallback(){(35127311&this.stream._duplexState)===Dn?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&Yt||(this.stream._duplexState|=Yt,this.stream._duplexState&Nt||Tn(this.afterUpdateNextTick))}}class ti{constructor(t,{highWaterMark:e=16384,map:n=null,mapReadable:i,byteLength:r,byteLengthReadable:o}={}){this.stream=t,this.queue=new In(),this.highWaterMark=e===0?1:e,this.buffered=0,this.readAhead=e>0,this.error=null,this.pipeline=null,this.byteLength=o||r||Vn,this.map=i||n,this.pipeTo=null,this.afterRead=ri.bind(this),this.afterUpdateNextTick=oi.bind(this)}get ended(){return!!(this.stream._duplexState&Mt)}pipe(t,e){if(this.pipeTo!==null)throw new Error("Can only pipe to one destination");if(typeof e!="function"&&(e=null),this.stream._duplexState|=512,this.pipeTo=t,this.pipeline=new ei(this.stream,t,e),e&&this.stream.on("error",sn),zn(t))t._writableState.pipeline=this.pipeline,e&&t.on("error",sn),t.on("finish",this.pipeline.finished.bind(this.pipeline));else{const n=this.pipeline.done.bind(this.pipeline,t),i=this.pipeline.done.bind(this.pipeline,t,null);t.on("error",n),t.on("close",i),t.on("finish",this.pipeline.finished.bind(this.pipeline))}t.on("drain",ni.bind(this)),this.stream.emit("piping",t),t.emit("pipe",this.stream)}push(t){const e=this.stream;return t===null?(this.highWaterMark=0,e._duplexState=536805311&e._duplexState|1024,!1):(this.map!==null&&(t=this.map(t))===null||(this.buffered+=this.byteLength(t),this.queue.push(t),e._duplexState=536805375&e._duplexState|128),this.buffered<this.highWaterMark)}shift(){const t=this.queue.shift();return this.buffered-=this.byteLength(t),this.buffered===0&&(this.stream._duplexState&=536862591),t}unshift(t){const e=[this.map!==null?this.map(t):t];for(;this.buffered>0;)e.push(this.shift());for(let n=0;n<e.length-1;n++){const i=e[n];this.buffered+=this.byteLength(i),this.queue.push(i)}this.push(e[e.length-1])}read(){const t=this.stream;if((16527&t._duplexState)===Ke){const e=this.shift();return this.pipeTo!==null&&this.pipeTo.write(e)===!1&&(t._duplexState&=Ze),t._duplexState&Xe&&t.emit("data",e),e}return this.readAhead===!1&&(t._duplexState|=fe,this.updateNextTick()),null}drain(){const t=this.stream;for(;(16527&t._duplexState)===Ke&&768&t._duplexState;){const e=this.shift();this.pipeTo!==null&&this.pipeTo.write(e)===!1&&(t._duplexState&=Ze),t._duplexState&Xe&&t.emit("data",e)}}update(){const t=this.stream;t._duplexState|=32;do{for(this.drain();this.buffered<this.highWaterMark&&(214047&t._duplexState)===fe;)t._duplexState|=65552,t._read(this.afterRead),this.drain();(12431&t._duplexState)==4224&&(t._duplexState|=$s,t.emit("readable")),80&t._duplexState||this.updateNonPrimary()}while(this.continueUpdate()===!0);t._duplexState&=Qs}updateNonPrimary(){const t=this.stream;(1167&t._duplexState)===Fs&&(t._duplexState=536869887&t._duplexState|16384,t.emit("end"),(t._duplexState&Hn)===Fn&&(t._duplexState|=4),this.pipeTo!==null&&this.pipeTo.end()),(t._duplexState&yt)!=4?(t._duplexState&jn)==1&&(t._duplexState=(t._duplexState|Ut)&Rn,t._open(Qn.bind(this))):t._duplexState&$n||(t._duplexState|=Ut,t._destroy(Wn.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&Jt)&&(this.stream._duplexState&=qn,!0)}updateCallback(){(32879&this.stream._duplexState)===Pn?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&Jt||(this.stream._duplexState|=Jt,32&this.stream._duplexState||Tn(this.afterUpdateNextTick))}}class ei{constructor(t,e,n){this.from=t,this.to=e,this.afterPipe=n,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(t,e){e&&(this.error=e),t!==this.to||(this.to=null,this.from===null)?t!==this.from||(this.from=null,this.to===null)?(this.afterPipe!==null&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null):t._duplexState&Mt||this.to.destroy(this.error||new Error("Readable stream closed before ending")):this.from._duplexState&Mt&&this.pipeToFinished||this.from.destroy(this.error||new Error("Writable stream closed prematurely"))}}function ni(){this.stream._duplexState|=512,this.updateCallback()}function si(s){const t=this.stream;s&&t.destroy(s),t._duplexState&yt||(t._duplexState|=Mn,t.emit("finish")),(t._duplexState&Hn)===Fn&&(t._duplexState|=4),t._duplexState&=Nn,t._duplexState&Nt?this.updateNextTick():this.update()}function Wn(s){const t=this.stream;s||this.error===Ae||(s=this.error),s&&t.emit("error",s),t._duplexState|=8,t.emit("close");const e=t._readableState,n=t._writableState;if(e!==null&&e.pipeline!==null&&e.pipeline.done(t,s),n!==null){for(;n.drains!==null&&n.drains.length>0;)n.drains.shift().resolve(!1);n.pipeline!==null&&n.pipeline.done(t,s)}}function ii(s){const t=this.stream;s&&t.destroy(s),t._duplexState&=Nn,this.drains!==null&&function(e){for(let n=0;n<e.length;n++)--e[n].writes==0&&(e.shift().resolve(!0),n--)}(this.drains),(6553615&t._duplexState)===zs&&(t._duplexState&=532676607,(t._duplexState&pe)===pe&&t.emit("drain")),this.updateCallback()}function ri(s){s&&this.stream.destroy(s),this.stream._duplexState&=Ws,this.readAhead!==!1||this.stream._duplexState&Bn||(this.stream._duplexState&=On),this.updateCallback()}function oi(){32&this.stream._duplexState||(this.stream._duplexState&=qn,this.update())}function ai(){this.stream._duplexState&Nt||(this.stream._duplexState&=Un,this.update())}function Qn(s){const t=this.stream;s&&t.destroy(s),4&t._duplexState||(17423&t._duplexState||(t._duplexState|=Pn),142606351&t._duplexState||(t._duplexState|=Dn),t.emit("open")),t._duplexState&=Ys,t._writableState!==null&&t._writableState.updateCallback(),t._readableState!==null&&t._readableState.updateCallback()}function hi(s){this._readableState!==null&&(s==="data"&&(this._duplexState|=133376,this._readableState.updateNextTick()),s==="readable"&&(this._duplexState|=Hs,this._readableState.updateNextTick())),this._writableState!==null&&s==="drain"&&(this._duplexState|=pe,this._writableState.updateNextTick())}class ci extends Ms{constructor(t){super(),this._duplexState=0,this._readableState=null,this._writableState=null,t&&(t.open&&(this._open=t.open),t.destroy&&(this._destroy=t.destroy),t.predestroy&&(this._predestroy=t.predestroy),t.signal&&t.signal.addEventListener("abort",gi.bind(this))),this.on("newListener",hi)}_open(t){t(null)}_destroy(t){t(null)}_predestroy(){}get readable(){return this._readableState!==null||void 0}get writable(){return this._writableState!==null||void 0}get destroyed(){return!!(8&this._duplexState)}get destroying(){return!!(this._duplexState&yt)}destroy(t){this._duplexState&yt||(t||(t=Ae),this._duplexState=535822271&this._duplexState|4,this._readableState!==null&&(this._readableState.highWaterMark=0,this._readableState.error=t),this._writableState!==null&&(this._writableState.highWaterMark=0,this._writableState.error=t),this._duplexState|=2,this._predestroy(),this._duplexState&=Us,this._readableState!==null&&this._readableState.updateNextTick(),this._writableState!==null&&this._writableState.updateNextTick())}}class Ft extends ci{constructor(t){super(t),this._duplexState|=8519681,this._readableState=new ti(this,t),t&&(this._readableState.readAhead===!1&&(this._duplexState&=On),t.read&&(this._read=t.read),t.eagerOpen&&this._readableState.updateNextTick(),t.encoding&&this.setEncoding(t.encoding))}setEncoding(t){const e=new Ns(t),n=this._readableState.map||li;return this._readableState.map=function(i){const r=e.push(i);return r===""?null:n(r)},this}_read(t){t(null)}pipe(t,e){return this._readableState.updateNextTick(),this._readableState.pipe(t,e),t}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(t){return this._readableState.updateNextTick(),this._readableState.push(t)}unshift(t){return this._readableState.updateNextTick(),this._readableState.unshift(t)}resume(){return this._duplexState|=js,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=this._readableState.readAhead===!1?536739583:536870655,this}static _fromAsyncIterator(t,e){let n;const i=new Ft({...e,read(o){t.next().then(r).then(o.bind(null,null)).catch(o)},predestroy(){n=t.return()},destroy(o){if(!n)return o(null);n.then(o.bind(null,null)).catch(o)}});return i;function r(o){o.done?i.push(null):i.push(o.value)}}static from(t,e){if(zn(n=t)&&n.readable)return t;var n;if(t[vt])return this._fromAsyncIterator(t[vt](),e);Array.isArray(t)||(t=t===void 0?[]:[t]);let i=0;return new Ft({...e,read(r){this.push(i===t.length?null:t[i++]),r(null)}})}static isBackpressured(t){return!!(17422&t._duplexState)||t._readableState.buffered>=t._readableState.highWaterMark}static isPaused(t){return!(t._duplexState&Bn)}[vt](){const t=this;let e=null,n=null,i=null;return this.on("error",(a)=>{e=a}),this.on("readable",function(){n!==null&&r(t.read())}),this.on("close",function(){n!==null&&r(null)}),{[vt](){return this},next:()=>new Promise(function(a,h){n=a,i=h;const c=t.read();c!==null?r(c):8&t._duplexState&&r(null)}),return:()=>o(null),throw:(a)=>o(a)};function r(a){i!==null&&(e?i(e):a!==null||t._duplexState&Mt?n({value:a,done:a===null}):i(Ae),i=n=null)}function o(a){return t.destroy(a),new Promise((h,c)=>{if(8&t._duplexState)return h({value:void 0,done:!0});t.once("close",function(){a?c(a):h({value:void 0,done:!0})})})}}}class di extends Ft{constructor(t){super(t),this._duplexState=1|this._duplexState&fe,this._writableState=new Zs(this,t),t&&(t.writev&&(this._writev=t.writev),t.write&&(this._write=t.write),t.final&&(this._final=t.final))}cork(){this._duplexState|=Vs}uncork(){this._duplexState&=Js,this._writableState.updateNextTick()}_writev(t,e){e(null)}_write(t,e){this._writableState.autoBatch(t,e)}_final(t){t(null)}write(t){return this._writableState.updateNextTick(),this._writableState.push(t)}end(t){return this._writableState.updateNextTick(),this._writableState.end(t),this}}function li(s){return s}function ui(s){return!!s._readableState||!!s._writableState}function zn(s){return typeof s._duplexState=="number"&&ui(s)}function Vn(s){return function(t){return typeof t=="object"&&t!==null&&typeof t.byteLength=="number"}(s)?s.byteLength:1024}function sn(){}function gi(){this.destroy(new Error("Stream aborted."))}var Gn=di;function rn(s,t){for(const e in t)Object.defineProperty(s,e,{value:t[e],enumerable:!0,configurable:!0});return s}const C=et(function(s,t,e){if(!s||typeof s=="string")throw new TypeError("Please pass an Error to err-code");e||(e={}),typeof t=="object"&&(e=t,t=""),t&&(e.code=t);try{return rn(s,e)}catch{e.message=s.message,e.stack=s.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(s)),rn(new i(),e)}}),Ht="0123456789abcdef",Jn=[],$t=[];for(let s=0;s<256;s++)Jn[s]=Ht[s>>4&15]+Ht[15&s],s<16&&(s<10?$t[48+s]=s:$t[87+s]=s);const ht=(s)=>{const t=s.length;let e="",n=0;for(;n<t;)e+=Jn[s[n++]];return e},me=(s)=>{const t=s.length>>1,e=t<<1,n=new Uint8Array(t);let i=0,r=0;for(;r<e;)n[i++]=$t[s.charCodeAt(r++)]<<4|$t[s.charCodeAt(r++)];return n};for(var fi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",pi=typeof Uint8Array>"u"?[]:new Uint8Array(256),Ct=0;Ct<64;Ct++)pi[fi.charCodeAt(Ct)]=Ct;const mi=new TextDecoder(),Yn=(s,t)=>mi.decode(s),yi=new TextEncoder(),Te=(s)=>yi.encode(s),nt=(s)=>{let t,e="",n=0;const i=s.length;for(;n<i;)t=s.charCodeAt(n++),e+=Ht[t>>4]+Ht[15&t];return e},pt=(s)=>{const t=me(s);if(t.length<=65536)return String.fromCharCode(...t);let e="",n=0;for(;n<t.length;)e+=String.fromCharCode(...t.subarray(n,n+=65536));return e},on=typeof window<"u"?window:self,ye=on.crypto||on.msCrypto||{};ye.subtle||ye.webkitSubtle;const jt=(s)=>{const t=new Uint8Array(s);return ye.getRandomValues(t)},_i=O("simple-peer"),Kt=65536;function an(s){return s.replace(/a=ice-options:trickle\s\n/g,"")}let mt=class _e extends Gn{constructor(t){if(super(t=Object.assign({allowHalfOpen:!1},t)),p(this,"_pc"),this.__objectMode=!!t.objectMode,this._id=ht(jt(4)).slice(0,7),this._debug("new peer %o",t),this.channelName=t.initiator?t.channelName||ht(jt(20)):null,this.initiator=t.initiator||!1,this.channelConfig=t.channelConfig||_e.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},_e.config,t.config),this.offerOptions=t.offerOptions||{},this.answerOptions=t.answerOptions||{},this.sdpTransform=t.sdpTransform||((e)=>e),this.trickle=t.trickle===void 0||t.trickle,this.allowHalfTrickle=t.allowHalfTrickle!==void 0&&t.allowHalfTrickle,this.iceCompleteTimeout=t.iceCompleteTimeout||5e3,this._destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,!ce)throw C(typeof window>"u"?new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"):new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new ce(this.config)}catch(e){return void this.__destroy(C(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=(e)=>{this._onIceCandidate(e)},typeof this._pc.peerIdentity=="object"&&this._pc.peerIdentity.catch((e)=>{this.__destroy(C(e,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=(e)=>{this._setupData(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(t){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if(typeof t=="string")try{t=JSON.parse(t)}catch{t={}}this._debug("signal()"),t.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),t.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(t.transceiverRequest.kind,t.transceiverRequest.init)),t.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(t.candidate):this._pendingCandidates.push(t.candidate)),t.sdp&&this._pc.setRemoteDescription(new ks(t)).then(()=>{this.destroyed||(this._pendingCandidates.forEach((e)=>{this._addIceCandidate(e)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer())}).catch((e)=>{this.__destroy(C(e,"ERR_SET_REMOTE_DESCRIPTION"))}),t.sdp||t.candidate||t.renegotiate||t.transceiverRequest||this.__destroy(C(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(t){const e=new xs(t);this._pc.addIceCandidate(e).catch((n)=>{var i;!e.address||e.address.endsWith(".local")?(i="Ignoring unsupported ICE candidate.",console.warn(i)):this.__destroy(C(n,"ERR_ADD_ICE_CANDIDATE"))})}send(t){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(t)}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this._destroying){if(this.destroyed)throw C(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}_final(t){this._readableState.ended||this.push(null),t(null)}__destroy(t){this.end(),this._destroy(()=>{},t)}_destroy(t,e){this.destroyed||this._destroying||(this._destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),setTimeout(()=>{if(this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch{}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch{}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),t()},0))}_setupData(t){if(!t.channel)return this.__destroy(C(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=t.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=Kt),this.channelName=this._channel.label,this._channel.onmessage=(n)=>{this._onChannelMessage(n)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=(n)=>{const i=n.error instanceof Error?n.error:new Error(`Datachannel error:${n.message}${n.filename}:${n.lineno}:${n.colno}`);this.__destroy(C(i,"ERR_DATA_CHANNEL"))};let e=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(e&&this._onChannelClose(),e=!0):e=!1},5e3)}_write(t,e){if(this.destroyed)return e(C(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(t)}catch(n){return this.__destroy(C(n,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>Kt?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=e):e(null)}else this._debug("write before connect"),this._chunk=t,this._cb=e}_onFinish(){if(this.destroyed)return;const t=()=>{setTimeout(()=>this.__destroy(),1e3)};this._connected?t():this.once("connect",t)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((t)=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(t.sdp=an(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{if(this.destroyed)return;const n=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:n.type,sdp:n.sdp})};this._pc.setLocalDescription(t).then(()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch((n)=>{this.__destroy(C(n,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch((t)=>{this.__destroy(C(t,"ERR_CREATE_OFFER"))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((t)=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(t.sdp=an(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{var n;if(this.destroyed)return;const i=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:i.type,sdp:i.sdp}),this.initiator||(n=this._requestMissingTransceivers)==null||n.call(this)};this._pc.setLocalDescription(t).then(()=>{this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))}).catch((n)=>{this.__destroy(C(n,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch((t)=>{this.__destroy(C(t,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._destroying||this._pc.connectionState==="failed"&&this.__destroy(C(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const t=this._pc.iceConnectionState,e=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",t,e),this.emit("iceStateChange",t,e),t!=="connected"&&t!=="completed"||(this._pcReady=!0,this._maybeReady()),t==="failed"&&this.__destroy(C(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),t==="closed"&&this.__destroy(C(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(t){const e=(n)=>(Object.prototype.toString.call(n.values)==="[object Array]"&&n.values.forEach((i)=>{Object.assign(n,i)}),n);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then((n)=>{const i=[];n.forEach((r)=>{i.push(e(r))}),t(null,i)},(n)=>t(n)):this._pc.getStats.length>0?this._pc.getStats((n)=>{if(this.destroyed)return;const i=[];n.result().forEach((r)=>{const o={};r.names().forEach((a)=>{o[a]=r.stat(a)}),o.id=r.id,o.type=r.type,o.timestamp=r.timestamp,i.push(e(o))}),t(null,i)},(n)=>t(n)):t(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const t=()=>{this.destroyed||this._destroying||this.getStats((e,n)=>{if(this.destroyed||this._destroying)return;e&&(n=[]);const i={},r={},o={};let a=!1;n.forEach((c)=>{c.type!=="remotecandidate"&&c.type!=="remote-candidate"||(i[c.id]=c),c.type!=="localcandidate"&&c.type!=="local-candidate"||(r[c.id]=c),c.type!=="candidatepair"&&c.type!=="candidate-pair"||(o[c.id]=c)});const h=(c)=>{a=!0;let d=r[c.localCandidateId];d&&(d.ip||d.address)?(this.localAddress=d.ip||d.address,this.localPort=Number(d.port)):d&&d.ipAddress?(this.localAddress=d.ipAddress,this.localPort=Number(d.portNumber)):typeof c.googLocalAddress=="string"&&(d=c.googLocalAddress.split(":"),this.localAddress=d[0],this.localPort=Number(d[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let f=i[c.remoteCandidateId];f&&(f.ip||f.address)?(this.remoteAddress=f.ip||f.address,this.remotePort=Number(f.port)):f&&f.ipAddress?(this.remoteAddress=f.ipAddress,this.remotePort=Number(f.portNumber)):typeof c.googRemoteAddress=="string"&&(f=c.googRemoteAddress.split(":"),this.remoteAddress=f[0],this.remotePort=Number(f[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(n.forEach((c)=>{c.type==="transport"&&c.selectedCandidatePairId&&h(o[c.selectedCandidatePairId]),(c.type==="googCandidatePair"&&c.googActiveConnection==="true"||(c.type==="candidatepair"||c.type==="candidate-pair")&&c.selected)&&h(c)}),a||Object.keys(o).length&&!Object.keys(r).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(d){return this.__destroy(C(d,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const c=this._cb;this._cb=null,c(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(t,100)})};t()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>Kt||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||(this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((t)=>{this._pc.removeTrack(t),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(t){this.destroyed||(t.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}}):t.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),t.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(t){if(this.destroyed)return;let e=t.data;e instanceof ArrayBuffer?e=new Uint8Array(e):this.__objectMode===!1&&(e=Te(e)),this.push(e)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const t=this._cb;this._cb=null,t(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.__destroy())}_debug(){const t=[].slice.call(arguments);t[0]="["+this._id+"] "+t[0],_i.apply(null,t)}};mt.WEBRTC_SUPPORT=!!ce,mt.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},mt.channelConfig={};const q={},be={DEFAULT_ANNOUNCE_PEERS:50,MAX_ANNOUNCE_PEERS:82,parseUrl:(s)=>{const t=new URL(s.replace(/^udp:/,"http:"));return s.match(/^udp:/)&&Object.defineProperties(t,{href:{value:t.href.replace(/^http/,"udp")},protocol:{value:t.protocol.replace(/^http/,"udp")},origin:{value:t.origin.replace(/^http/,"udp")}}),t},...Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}))},bi=O("simple-websocket"),ut=typeof q!="function"?WebSocket:q;class Kn extends Gn{constructor(t={}){if(typeof t=="string"&&(t={url:t}),super(t=Object.assign({allowHalfOpen:!1},t)),this.__objectMode=!!t.objectMode,t.objectMode!=null&&delete t.objectMode,t.url==null&&t.socket==null)throw new Error("Missing required `url` or `socket` option");if(t.url!=null&&t.socket!=null)throw new Error("Must specify either `url` or `socket` option, not both");if(this._id=ht(jt(4)).slice(0,7),this._debug("new websocket: %o",t),this.connected=!1,this._chunk=null,this._cb=null,this._interval=null,t.socket)this.url=t.socket.url,this._ws=t.socket,this.connected=t.socket.readyState===ut.OPEN;else{this.url=t.url;try{this._ws=typeof q=="function"?new ut(t.url,{...t,encoding:void 0}):new ut(t.url)}catch(e){return void he(()=>this.destroy(e))}}this._ws.binaryType="arraybuffer",t.socket&&this.connected?he(()=>this._handleOpen()):this._ws.onopen=()=>this._handleOpen(),this._ws.onmessage=(e)=>this._handleMessage(e),this._ws.onclose=()=>this._handleClose(),this._ws.onerror=(e)=>this._handleError(e),this._handleFinishBound=()=>this._handleFinish(),this.once("finish",this._handleFinishBound)}send(t){this._ws.send(t)}_final(t){this._readableState.ended||this.push(null),t(null)}_destroy(t){if(!this.destroyed){if(this._writableState.ended||this.end(),this.connected=!1,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._handleFinishBound&&this.removeListener("finish",this._handleFinishBound),this._handleFinishBound=null,this._ws){const e=this._ws,n=()=>{e.onclose=null};if(e.readyState===ut.CLOSED)n();else try{e.onclose=n,e.close()}catch{n()}e.onopen=null,e.onmessage=null,e.onerror=()=>{}}this._ws=null,t()}}_write(t,e){if(this.destroyed)return e(new Error("cannot write after socket is destroyed"));if(this.connected){try{this.send(t)}catch(n){return this.destroy(n)}typeof q!="function"&&this._ws.bufferedAmount>65536?(this._debug("start backpressure: bufferedAmount %d",this._ws.bufferedAmount),this._cb=e):e(null)}else this._debug("write before connect"),this._chunk=t,this._cb=e}_handleOpen(){if(!this.connected&&!this.destroyed){if(this.connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(e)}this._chunk=null,this._debug('sent chunk from "write before connect"');const t=this._cb;this._cb=null,t(null)}typeof q!="function"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}}_handleMessage(t){if(this.destroyed)return;let e=t.data;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.__objectMode===!1&&(e=Te(e)),this.push(e)}_handleClose(){this.destroyed||(this._debug("on close"),this.destroy())}_handleError(t){this.destroy(new Error(`Error connecting to ${this.url}`))}_handleFinish(){if(this.destroyed)return;const t=()=>{setTimeout(()=>this.destroy(),1e3)};this.connected?t():this.once("connect",t)}_onInterval(){if(!this._cb||!this._ws||this._ws.bufferedAmount>65536)return;this._debug("ending backpressure: bufferedAmount %d",this._ws.bufferedAmount);const t=this._cb;this._cb=null,t(null)}_debug(){const t=[].slice.call(arguments);t[0]="["+this._id+"] "+t[0],bi.apply(null,t)}}Kn.WEBSOCKET_SUPPORT=!!ut;class wi extends xn{constructor(t,e){super(),this.client=t,this.announceUrl=e,this.interval=null,this.destroyed=!1}setInterval(t){t==null&&(t=this.DEFAULT_ANNOUNCE_INTERVAL),clearInterval(this.interval),t&&(this.interval=setInterval(()=>{this.announce(this.client._defaultAnnounceOpts())},t),this.interval.unref&&this.interval.unref())}}const P=O("bittorrent-tracker:websocket-tracker"),M={};class we extends wi{constructor(t,e){super(t,e),P("new websocket tracker %s",e),this.peers={},this.socket=null,this.reconnecting=!1,this.retries=0,this.reconnectTimer=null,this.expectingResponse=!1,this._openSocket()}announce(t){if(this.destroyed||this.reconnecting)return;if(!this.socket.connected)return void this.socket.once("connect",()=>{this.announce(t)});const e=Object.assign({},t,{action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary});if(this._trackerId&&(e.trackerid=this._trackerId),t.event==="stopped"||t.event==="completed")this._send(e);else{const n=Math.min(t.numwant,5);this._generateOffers(n,(i)=>{e.numwant=n,e.offers=i,this._send(e)})}}scrape(t){if(this.destroyed||this.reconnecting)return;if(!this.socket.connected)return void this.socket.once("connect",()=>{this.scrape(t)});const e={action:"scrape",info_hash:Array.isArray(t.infoHash)&&t.infoHash.length>0?t.infoHash.map((n)=>pt(n)):t.infoHash&&pt(t.infoHash)||this.client._infoHashBinary};this._send(e)}destroy(t=hn){if(this.destroyed)return t(null);this.destroyed=!0,clearInterval(this.interval),clearTimeout(this.reconnectTimer);for(const r in this.peers){const o=this.peers[r];clearTimeout(o.trackerTimeout),o.destroy()}if(this.peers=null,this.socket&&(this.socket.removeListener("connect",this._onSocketConnectBound),this.socket.removeListener("data",this._onSocketDataBound),this.socket.removeListener("close",this._onSocketCloseBound),this.socket.removeListener("error",this._onSocketErrorBound),this.socket=null),this._onSocketConnectBound=null,this._onSocketErrorBound=null,this._onSocketDataBound=null,this._onSocketCloseBound=null,M[this.announceUrl]&&(M[this.announceUrl].consumers-=1),M[this.announceUrl].consumers>0)return t();let e,n=M[this.announceUrl];if(delete M[this.announceUrl],n.on("error",hn),n.once("close",t),!this.expectingResponse)return i();function i(){e&&(clearTimeout(e),e=null),n.removeListener("data",i),n.destroy(),n=null}e=setTimeout(i,be.DESTROY_TIMEOUT),n.once("data",i)}_openSocket(){if(this.destroyed=!1,this.peers||(this.peers={}),this._onSocketConnectBound=()=>{this._onSocketConnect()},this._onSocketErrorBound=(t)=>{this._onSocketError(t)},this._onSocketDataBound=(t)=>{this._onSocketData(t)},this._onSocketCloseBound=()=>{this._onSocketClose()},this.socket=M[this.announceUrl],this.socket)M[this.announceUrl].consumers+=1,this.socket.connected&&this._onSocketConnectBound();else{const t=new URL(this.announceUrl);let e;this.client._proxyOpts&&(e=t.protocol==="wss:"?this.client._proxyOpts.httpsAgent:this.client._proxyOpts.httpAgent,!e&&this.client._proxyOpts.socksProxy&&(e=this.client._proxyOpts.socksProxy)),this.socket=M[this.announceUrl]=new Kn({url:this.announceUrl,agent:e}),this.socket.consumers=1,this.socket.once("connect",this._onSocketConnectBound)}this.socket.on("data",this._onSocketDataBound),this.socket.once("close",this._onSocketCloseBound),this.socket.once("error",this._onSocketErrorBound)}_onSocketConnect(){this.destroyed||this.reconnecting&&(this.reconnecting=!1,this.retries=0,this.announce(this.client._defaultAnnounceOpts()))}_onSocketData(t){if(!this.destroyed){this.expectingResponse=!1;try{t=JSON.parse(Yn(t))}catch{return void this.client.emit("warning",new Error("Invalid tracker response"))}t.action==="announce"?this._onAnnounceResponse(t):t.action==="scrape"?this._onScrapeResponse(t):this._onSocketError(new Error(`invalid action in WS response:${t.action}`))}}_onAnnounceResponse(t){if(t.info_hash!==this.client._infoHashBinary)return void P("ignoring websocket data from %s for %s (looking for %s: reused socket)",this.announceUrl,nt(t.info_hash),this.client.infoHash);if(t.peer_id&&t.peer_id===this.client._peerIdBinary)return;P("received %s from %s for %s",JSON.stringify(t),this.announceUrl,this.client.infoHash);const e=t["failure reason"];if(e)return this.client.emit("warning",new Error(e));const n=t["warning message"];n&&this.client.emit("warning",new Error(n));const i=t.interval||t["min interval"];i&&this.setInterval(1e3*i);const r=t["tracker id"];if(r&&(this._trackerId=r),t.complete!=null){const a=Object.assign({},t,{announce:this.announceUrl,infoHash:nt(t.info_hash)});this.client.emit("update",a)}let o;if(t.offer&&t.peer_id&&(P("creating peer (from remote offer)"),o=this._createPeer(),o.id=nt(t.peer_id),o.once("signal",(a)=>{const h={action:"announce",info_hash:this.client._infoHashBinary,peer_id:this.client._peerIdBinary,to_peer_id:t.peer_id,answer:a,offer_id:t.offer_id};this._trackerId&&(h.trackerid=this._trackerId),this._send(h)}),this.client.emit("peer",o),o.signal(t.offer)),t.answer&&t.peer_id){const a=nt(t.offer_id);o=this.peers[a],o?(o.id=nt(t.peer_id),this.client.emit("peer",o),o.signal(t.answer),clearTimeout(o.trackerTimeout),o.trackerTimeout=null,delete this.peers[a]):P(`got unexpected answer:${JSON.stringify(t.answer)}`)}}_onScrapeResponse(t){t=t.files||{};const e=Object.keys(t);e.length!==0?e.forEach((n)=>{const i=Object.assign(t[n],{announce:this.announceUrl,infoHash:nt(n)});this.client.emit("scrape",i)}):this.client.emit("warning",new Error("invalid scrape response"))}_onSocketClose(){this.destroyed||(this.destroy(),this._startReconnectTimer())}_onSocketError(t){this.destroyed||(this.destroy(),this.client.emit("warning",t),this._startReconnectTimer())}_startReconnectTimer(){const t=Math.floor(3e5*Math.random())+Math.min(1e4*Math.pow(2,this.retries),36e5);this.reconnecting=!0,clearTimeout(this.reconnectTimer),this.reconnectTimer=setTimeout(()=>{this.retries++,this._openSocket()},t),this.reconnectTimer.unref&&this.reconnectTimer.unref(),P("reconnecting socket in %s ms",t)}_send(t){if(this.destroyed)return;this.expectingResponse=!0;const e=JSON.stringify(t);P("send %s",e),this.socket.send(e)}_generateOffers(t,e){const n=this,i=[];P("generating %s offers",t);for(let a=0;a<t;++a)r();function r(){const a=ht(jt(20));P("creating peer (from _generateOffers)");const h=n.peers[a]=n._createPeer({initiator:!0});h.once("signal",(c)=>{i.push({offer:c,offer_id:pt(a)}),o()}),h.trackerTimeout=setTimeout(()=>{P("tracker timeout: destroying peer"),h.trackerTimeout=null,delete n.peers[a],h.destroy()},5e4),h.trackerTimeout.unref&&h.trackerTimeout.unref()}function o(){i.length===t&&(P("generated %s offers",t),e(i))}o()}_createPeer(t){const e=this;t=Object.assign({trickle:!1,config:e.client._rtcConfig,wrtc:e.client._wrtc},t);const n=new mt(t);return n.once("error",i),n.once("connect",function r(){n.removeListener("error",i),n.removeListener("connect",r)}),n;function i(r){e.client.emit("warning",new Error(`Connection error:${r.message}`)),n.destroy()}}}function hn(){}we.prototype.DEFAULT_ANNOUNCE_INTERVAL=3e4,we._socketPool=M;const Q=O("bittorrent-tracker:client");class Se extends xn{constructor(t={}){if(super(),!t.peerId)throw new Error("Option `peerId` is required");if(!t.infoHash)throw new Error("Option `infoHash` is required");if(!t.announce)throw new Error("Option `announce` is required");if(!It.browser&&!t.port)throw new Error("Option `port` is required");this.peerId=typeof t.peerId=="string"?t.peerId:ht(t.peerId),this._peerIdBuffer=me(this.peerId),this._peerIdBinary=pt(this.peerId),this.infoHash=typeof t.infoHash=="string"?t.infoHash.toLowerCase():ht(t.infoHash),this._infoHashBuffer=me(this.infoHash),this._infoHashBinary=pt(this.infoHash),Q("new client %s",this.infoHash),this.destroyed=!1,this._port=t.port,this._getAnnounceOpts=t.getAnnounceOpts,this._rtcConfig=t.rtcConfig,this._userAgent=t.userAgent,this._proxyOpts=t.proxyOpts,this._wrtc=typeof t.wrtc=="function"?t.wrtc():t.wrtc;let e=typeof t.announce=="string"?[t.announce]:t.announce==null?[]:t.announce;e=e.map((r)=>(ArrayBuffer.isView(r)&&(r=Yn(r)),r[r.length-1]==="/"&&(r=r.substring(0,r.length-1)),r)),e=Array.from(new Set(e));const n=this._wrtc!==!1&&(!!this._wrtc||mt.WEBRTC_SUPPORT),i=(r)=>{he(()=>{this.emit("warning",r)})};this._trackers=e.map((r)=>{let o;try{o=be.parseUrl(r)}catch{return i(new Error(`Invalid tracker URL:${r}`)),null}const a=o.port;if(a<0||a>65535)return i(new Error(`Invalid tracker port:${r}`)),null;const h=o.protocol;return h!=="http:"&&h!=="https:"||typeof q!="function"?h==="udp:"&&typeof q=="function"?new q(this,r):h!=="ws:"&&h!=="wss:"||!n||h==="ws:"&&typeof window<"u"&&window.location.protocol==="https:"?(i(new Error(`Unsupported tracker protocol:${r}`)),null):new we(this,r):new q(this,r)}).filter(Boolean)}start(t){(t=this._defaultAnnounceOpts(t)).event="started",Q("send `start` %o",t),this._announce(t),this._trackers.forEach((e)=>{e.setInterval()})}stop(t){(t=this._defaultAnnounceOpts(t)).event="stopped",Q("send `stop` %o",t),this._announce(t)}complete(t){t||(t={}),(t=this._defaultAnnounceOpts(t)).event="completed",Q("send `complete` %o",t),this._announce(t)}update(t){(t=this._defaultAnnounceOpts(t)).event&&delete t.event,Q("send `update` %o",t),this._announce(t)}_announce(t){this._trackers.forEach((e)=>{e.announce(t)})}scrape(t){Q("send `scrape`"),t||(t={}),this._trackers.forEach((e)=>{e.scrape(t)})}setInterval(t){Q("setInterval %d",t),this._trackers.forEach((e)=>{e.setInterval(t)})}destroy(t){if(this.destroyed)return;this.destroyed=!0,Q("destroy");const e=this._trackers.map((n)=>(i)=>{n.destroy(i)});Ls(e,t),this._trackers=[],this._getAnnounceOpts=null}_defaultAnnounceOpts(t={}){return t.numwant==null&&(t.numwant=be.DEFAULT_ANNOUNCE_PEERS),t.uploaded==null&&(t.uploaded=0),t.downloaded==null&&(t.downloaded=0),this._getAnnounceOpts&&(t=Object.assign({},t,this._getAnnounceOpts())),t}}Se.scrape=(s,t)=>{if(t=Ss(t),!s.infoHash)throw new Error("Option `infoHash` is required");if(!s.announce)throw new Error("Option `announce` is required");const e=Object.assign({},s,{infoHash:Array.isArray(s.infoHash)?s.infoHash[0]:s.infoHash,peerId:Te("01234567890123456789"),port:6881}),n=new Se(e);n.once("error",t),n.once("warning",t);let i=Array.isArray(s.infoHash)?s.infoHash.length:1;const r={};return n.on("scrape",(o)=>{if(i-=1,r[o.infoHash]=o,i===0){n.destroy();const a=Object.keys(r);a.length===1?t(null,r[a[0]]):t(null,r)}}),n.scrape({infoHash:s.infoHash}),n};var Xn={exports:{}};function E(s,t,e,n,i,r,o){var a=s+(t&e|~t&n)+(i>>>0)+o;return(a<<r|a>>>32-r)+t}function A(s,t,e,n,i,r,o){var a=s+(t&n|e&~n)+(i>>>0)+o;return(a<<r|a>>>32-r)+t}function T(s,t,e,n,i,r,o){var a=s+(t^e^n)+(i>>>0)+o;return(a<<r|a>>>32-r)+t}function I(s,t,e,n,i,r,o){var a=s+(e^(t|~n))+(i>>>0)+o;return(a<<r|a>>>32-r)+t}function Lt(s){return String.fromCharCode(255&s)}function kt(s){return Lt(s)+Lt(s>>>8)+Lt(s>>>16)+Lt(s>>>24)}var ve=function(s){return unescape(encodeURIComponent(s))},Vt=Xn.exports=function(s){return Si(s).toHex()},Pt=Vt.fromBytes=function(s){for(var t=function(b){for(var l=b.length,g=l<<3,u=new Uint32Array(l+72>>>6<<4),m=0,_=b.length;m<_;++m)u[m>>>2]|=b.charCodeAt(m)<<((3&m)<<3);return u[l>>2]|=128<<(31&g),u[u.length-2]=g,u}(s),e=1732584193,n=4023233417,i=2562383102,r=271733878,o=0,a=t.length;o<a;o+=16){var h=e,c=n,d=i,f=r;e=E(e,n,i,r,t[o+0],7,3614090360),r=E(r,e,n,i,t[o+1],12,3905402710),i=E(i,r,e,n,t[o+2],17,606105819),n=E(n,i,r,e,t[o+3],22,3250441966),e=E(e,n,i,r,t[o+4],7,4118548399),r=E(r,e,n,i,t[o+5],12,1200080426),i=E(i,r,e,n,t[o+6],17,2821735955),n=E(n,i,r,e,t[o+7],22,4249261313),e=E(e,n,i,r,t[o+8],7,1770035416),r=E(r,e,n,i,t[o+9],12,2336552879),i=E(i,r,e,n,t[o+10],17,4294925233),n=E(n,i,r,e,t[o+11],22,2304563134),e=E(e,n,i,r,t[o+12],7,1804603682),r=E(r,e,n,i,t[o+13],12,4254626195),i=E(i,r,e,n,t[o+14],17,2792965006),e=A(e,n=E(n,i,r,e,t[o+15],22,1236535329),i,r,t[o+1],5,4129170786),r=A(r,e,n,i,t[o+6],9,3225465664),i=A(i,r,e,n,t[o+11],14,643717713),n=A(n,i,r,e,t[o+0],20,3921069994),e=A(e,n,i,r,t[o+5],5,3593408605),r=A(r,e,n,i,t[o+10],9,38016083),i=A(i,r,e,n,t[o+15],14,3634488961),n=A(n,i,r,e,t[o+4],20,3889429448),e=A(e,n,i,r,t[o+9],5,568446438),r=A(r,e,n,i,t[o+14],9,3275163606),i=A(i,r,e,n,t[o+3],14,4107603335),n=A(n,i,r,e,t[o+8],20,1163531501),e=A(e,n,i,r,t[o+13],5,2850285829),r=A(r,e,n,i,t[o+2],9,4243563512),i=A(i,r,e,n,t[o+7],14,1735328473),e=T(e,n=A(n,i,r,e,t[o+12],20,2368359562),i,r,t[o+5],4,4294588738),r=T(r,e,n,i,t[o+8],11,2272392833),i=T(i,r,e,n,t[o+11],16,1839030562),n=T(n,i,r,e,t[o+14],23,4259657740),e=T(e,n,i,r,t[o+1],4,2763975236),r=T(r,e,n,i,t[o+4],11,1272893353),i=T(i,r,e,n,t[o+7],16,4139469664),n=T(n,i,r,e,t[o+10],23,3200236656),e=T(e,n,i,r,t[o+13],4,681279174),r=T(r,e,n,i,t[o+0],11,3936430074),i=T(i,r,e,n,t[o+3],16,3572445317),n=T(n,i,r,e,t[o+6],23,76029189),e=T(e,n,i,r,t[o+9],4,3654602809),r=T(r,e,n,i,t[o+12],11,3873151461),i=T(i,r,e,n,t[o+15],16,530742520),e=I(e,n=T(n,i,r,e,t[o+2],23,3299628645),i,r,t[o+0],6,4096336452),r=I(r,e,n,i,t[o+7],10,1126891415),i=I(i,r,e,n,t[o+14],15,2878612391),n=I(n,i,r,e,t[o+5],21,4237533241),e=I(e,n,i,r,t[o+12],6,1700485571),r=I(r,e,n,i,t[o+3],10,2399980690),i=I(i,r,e,n,t[o+10],15,4293915773),n=I(n,i,r,e,t[o+1],21,2240044497),e=I(e,n,i,r,t[o+8],6,1873313359),r=I(r,e,n,i,t[o+15],10,4264355552),i=I(i,r,e,n,t[o+6],15,2734768916),n=I(n,i,r,e,t[o+13],21,1309151649),e=I(e,n,i,r,t[o+4],6,4149444226),r=I(r,e,n,i,t[o+11],10,3174756917),i=I(i,r,e,n,t[o+2],15,718787259),n=I(n,i,r,e,t[o+9],21,3951481745),e=e+h>>>0,n=n+c>>>0,i=i+d>>>0,r=r+f>>>0}var y=new String(kt(e)+kt(n)+kt(i)+kt(r));return y.toHex=function(){for(var b="",l=0,g=y.length;l<g;++l)b+=(256+(255&y.charCodeAt(l))).toString(16).substr(-2);return b},y},Si=Vt.fromUtf8=function(s){return Pt(ve(s))},Zn="./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function cn(s,t){for(var e="";--t>=0;s>>>=6)e+=Zn.charAt(63&s);return e}var xt=[0,6,12,1,7,13,2,8,14,3,9,15,4,10,5,11],vi=Vt.salt=function(s){var t="";s||(s=8);do t+=Zn.charAt(64*Math.random()>>>0);while(--s);return t};Vt.crypt=function(s,t){if(s.length>64)throw Error("too long key");t||(t="$1$"+vi()),s=ve(s);for(var e=ve(t.replace(/^\$1\$([^$]+)(?:\$.*)?$/,"$1")),n=Pt(s+e+s),i=s+"$1$"+e,r=s.length;r>16;r-=16)i+=n;for(i+=n.slice(0,r),r=s.length;r;r>>=1)i+=1&r?"\0":s.charAt(0);n=Pt(i);for(var o=0;o<1e3;++o)n=Pt((1&o?s:n)+(o%3?e:"")+(o%7?s:"")+(1&o?n:s));var a="$1$"+e+"$";for(o=0;o<15;o+=3)a+=cn(n.charCodeAt(xt[o+0])<<16|n.charCodeAt(xt[o+1])<<8|n.charCodeAt(xt[o+2]),4);return a+cn(n.charCodeAt(xt[15]),2)};const Ci=et(Xn.exports),Li=`-PM${function(s){const t=s.split(".");return`${t[0].padStart(2,"0")}${t[1].padStart(2,"0")}`}("1.0.0")}-`,ki="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";function tt(s){return`${s.type}-${s.index}`}function dn(s){const{externalId:t}=s;return`(${tt(s.stream)}|${t})`}function Ce(s,t){t===void 0&&(t=s.reduce((i,r)=>i+r.byteLength,0));const e=new Uint8Array(t);let n=0;for(const i of s)e.set(i,n),n+=i.byteLength;return e}function ln(s){const t=new TextEncoder(),e=new Uint8Array(s.length);return t.encodeInto(s,e),e}function*un(s){for(let t=s.length-1;t>=0;t--)yield s[t]}function ts(s){return!!s&&typeof s=="object"&&!Array.isArray(s)}function ot(s){if(function(t){return Array.isArray(t)}(s))return s.map((t)=>ot(t));if(ts(s)){const t={};for(const e of Object.keys(s))t[e]=ot(s[e]);return t}return s}function dt(s,t,e={}){return typeof s!="object"||s===null||typeof t!="object"||t===null||Object.keys(t).forEach((n)=>{if(n==="__proto__"||n==="constructor"||n==="prototype")throw new Error(`Attempt to modify restricted property'${String(n)}'`);const i=t[n],r=e[n];n in s&&(s[n]=i===void 0?r===void 0?void 0:r:i)}),s}function Xt(s){const{defaultConfig:t,baseConfig:e={},specificStreamConfig:n={}}=s,i=ot({...t,...e,...n}),r=Object.keys(t),o={};return r.forEach((a)=>{a in i&&(o[a]=i[a])}),o}var V=((s)=>(s[s.SegmentsAnnouncement=0]="SegmentsAnnouncement",s[s.SegmentRequest=1]="SegmentRequest",s[s.SegmentData=2]="SegmentData",s[s.SegmentDataSendingCompleted=3]="SegmentDataSendingCompleted",s[s.SegmentAbsent=4]="SegmentAbsent",s[s.CancelSegmentRequest=5]="CancelSegmentRequest",s))(V||{}),at=((s)=>(s[s.Min=-1]="Min",s[s.Int=0]="Int",s[s.SimilarIntArray=1]="SimilarIntArray",s[s.String=2]="String",s[s.Max=3]="Max",s))(at||{});function xi(s){const t=s<0,e=function(r){const o=r.toString(2),a=r<0?o.length:o.length+1;return Math.ceil(a/8)}(s),n=new Uint8Array(e),i=BigInt(e);s=function(r){return r<0?-r:r}(s);for(let r=0;r<e;r++){const o=s>>8n*(i-1n-BigInt(r))&0xffn;n[r]=Number(o)}return t&&(n[0]=128|n[0]),n}function Ei(s){const t=BigInt(s.length),e=(i,r)=>{const o=8n*(t-1n-BigInt(r));return BigInt(i)<<o};let n=e(127&s[0],0);for(let i=1;i<t;i++)n=e(s[i],i)|n;return(128&s[0])>>7&&(n=-n),n}function gn(s){const t=xi(s),e=0|t.length;return new Uint8Array([e,...t])}function es(s){const t=s[0];if(t>>4)throw new Error("Trying to deserialize integer with invalid serialized item code");const e=15&t,n=1+e;return{number:Ei(s.slice(1,n)),byteLength:e+1}}function Ai(s){const[t,e]=s;if(t>>4!==1)throw new Error("Trying to deserialize similar int array with invalid serialized item code");let n=2;const i=[];for(let r=0;r<e;r++){const{number:o,byteLength:a}=es(s.slice(n));n+=a;const h=0xffn&o,c=-256n&o;for(let d=0;d<h;d++){const f=BigInt(s[n]);i.push(c|f),n++}}return{numbers:i,byteLength:n}}function Ti(s){const[t,e]=s;if(t>>4!==2)throw new Error("Trying to deserialize bytes (sting) with invalid serialized item code.");const n=(15&t)<<8|e,i=s.slice(2,n+2);return{string:new TextDecoder("utf8").decode(i),byteLength:n+2}}class gt{constructor(){p(this,"bytes",[]),p(this,"_length",0)}push(t){this.addBytes(t,"end")}unshift(t){this.addBytes(t,"start")}addBytes(t,e){let n;n=t instanceof Uint8Array?t:Array.isArray(t)?new Uint8Array(t):new Uint8Array([t]),this._length+=n.length,this.bytes[e==="start"?"unshift":"push"](n)}getBytesChunks(){return this.bytes}getBuffer(){return Ce(this.bytes,this._length)}get length(){return this._length}}const ct=Gt("cstr",4),_t=Gt("cend",4),Le=Gt("dstr",4),ke=Gt("dend",4),Ii=[ct,Le],Ri=[_t,ke],fn=ct.length+_t.length;function ns(s){const t=ct.length,e=s.slice(-t);return Ii.some((n)=>Qt(s,n,4))&&Ri.some((n)=>Qt(e,n,4))}class Wt extends Error{constructor(t){super(),this.type=t}}class ss{constructor(t){p(this,"chunks",new gt()),p(this,"status","joining"),this.onComplete=t}addCommandChunk(t){if(this.status==="completed")return;const e=Qt(t,ct,4);if(!this.chunks.length&&!e)throw new Wt("no-first-chunk");if(this.chunks.length&&e)throw new Wt("incomplete-joining");this.chunks.push(this.unframeCommandChunk(t)),function(n){return Qt(n.slice(-4),_t,4)}(t)&&(this.status="completed",this.onComplete(this.chunks.getBuffer()))}unframeCommandChunk(t){return t.slice(4,t.length-4)}}class Et{constructor(t,e){p(this,"bytes",new gt()),p(this,"resultBuffers",[]),p(this,"status","creating"),this.maxChunkLength=e,this.bytes.push(t)}addInteger(t,e){this.bytes.push(t.charCodeAt(0));const n=gn(BigInt(e));this.bytes.push(n)}addSimilarIntArr(t,e){this.bytes.push(t.charCodeAt(0));const n=function(i){const r=new Map();for(const a of i){const h=-256n&a,c=0xffn&a,d=r.get(h)??new gt();d.length||r.set(h,d),d.push(Number(c))}const o=new gt();o.push([16,r.size]);for(const[a,h]of r){const{length:c}=h.getBytesChunks(),d=a|0xffn&BigInt(c);h.unshift(gn(d)),o.push(h.getBuffer())}return o.getBuffer()}(e.map((i)=>BigInt(i)));this.bytes.push(n)}addString(t,e){this.bytes.push(t.charCodeAt(0));const n=function(i){const{length:r}=i,o=new gt();return o.push([32|r>>8&15,255&r]),o.push(new TextEncoder().encode(i)),o.getBuffer()}(e);this.bytes.push(n)}complete(){if(!this.bytes.length)throw new Error("Buffer is empty");if(this.status==="completed")return;this.status="completed";const t=this.bytes.getBuffer();if(t.length+fn<=this.maxChunkLength)return void this.resultBuffers.push(At(t,ct,_t));let e=Math.ceil(t.length/this.maxChunkLength);Math.ceil(t.length/e)+fn>this.maxChunkLength&&e++;for(const[n,i]of function*(r,o){const a=Math.ceil(r.length/o);for(let h=0;h<o;h++)yield[h,r.slice(h*a,(h+1)*a)]}(t,e))n===0?this.resultBuffers.push(At(i,ct,ke)):n===e-1?this.resultBuffers.push(At(i,Le,_t)):this.resultBuffers.push(At(i,Le,ke))}getResultBuffers(){if(this.status==="creating"||!this.resultBuffers.length)throw new Error("Command is not complete.");return this.resultBuffers}}function is(s){const[t]=s,e={c:t};let n=1;for(;n<s.length;){const i=String.fromCharCode(s[n]);switch(n++,Pi(s[n])){case at.Int:{const{number:r,byteLength:o}=es(s.slice(n));e[i]=Number(r),n+=o}break;case at.SimilarIntArray:{const{numbers:r,byteLength:o}=Ai(s.slice(n));e[i]=r.map((a)=>Number(a)),n+=o}break;case at.String:{const{string:r,byteLength:o}=Ti(s.slice(n));e[i]=r,n+=o}}}return e}function Pi(s){const t=s>>4;if(t<=at.Min||t>=at.Max)throw new Error("Not existing type");return t}function Gt(s,t){if(s.length!==t)throw new Error("Wrong string length");const e=new Uint8Array(t);for(let n=0;n<s.length;n++)e[n]=s.charCodeAt(n);return e}function At(s,t,e){const n=new Uint8Array(s.length+t.length+e.length);return n.set(t),n.set(s,t.length),n.set(e,t.length+s.length),n}function Qt(s,t,e){for(let n=0;n<e;n++)if(s[n]!==t[n])return!1;return!0}function rs(s,t){switch(s.c){case V.CancelSegmentRequest:case V.SegmentAbsent:case V.SegmentDataSendingCompleted:return function(e,n){const i=new Et(e.c,n);return i.addInteger("i",e.i),i.addInteger("r",e.r),i.complete(),i.getResultBuffers()}(s,t);case V.SegmentRequest:return function(e,n){const i=new Et(e.c,n);return i.addInteger("i",e.i),i.addInteger("r",e.r),e.b&&i.addInteger("b",e.b),i.complete(),i.getResultBuffers()}(s,t);case V.SegmentsAnnouncement:return function(e,n){const{c:i,p:r,l:o}=e,a=new Et(i,n);return o!=null&&o.length&&a.addSimilarIntArr("l",o),r!=null&&r.length&&a.addSimilarIntArr("p",r),a.complete(),a.getResultBuffers()}(s,t);case V.SegmentData:return function(e,n){const i=new Et(e.c,n);return i.addInteger("i",e.i),i.addInteger("s",e.s),i.addInteger("r",e.r),i.complete(),i.getResultBuffers()}(s,t)}}const Bi=Object.freeze(Object.defineProperty({__proto__:null,BinaryCommandChunksJoiner:ss,BinaryCommandJoiningError:Wt,PeerCommandType:V,deserializeCommand:is,isCommandChunk:ns,serializePeerCommand:rs},Symbol.toStringTag,{value:"Module"}));class qi{constructor(t,e,n,i){p(this,"commandChunks"),p(this,"uploadingContext"),p(this,"onChunkDownloaded"),p(this,"onChunkUploaded"),p(this,"onDataReceived",(r)=>{ns(r)?this.receivingCommandBytes(r):(this.eventHandlers.onSegmentChunkReceived(r),this.onChunkDownloaded(r.byteLength,"p2p",this.connection.idUtf8))}),this.connection=t,this.peerConfig=e,this.eventHandlers=n,this.onChunkDownloaded=i.getEventDispatcher("onChunkDownloaded"),this.onChunkUploaded=i.getEventDispatcher("onChunkUploaded"),t.on("data",this.onDataReceived)}sendCommand(t){const e=rs(t,this.peerConfig.webRtcMaxMessageSize);for(const n of e)this.connection.write(n)}stopUploadingSegmentData(){var t;(t=this.uploadingContext)==null||t.stopUploading(),this.uploadingContext=void 0}getUploadingRequestId(){var t;return(t=this.uploadingContext)==null?void 0:t.requestId}async splitSegmentDataToChunksAndUploadAsync(t,e){if(this.uploadingContext)throw new Error("Some segment data is already uploading.");const n=function*(d,f){let y=d.byteLength;for(;y>0;){const b=y>=f?f:y,l=d.byteLength-y,g=d.slice(l,l+b);y-=b,yield g}}(t,this.peerConfig.webRtcMaxMessageSize),{promise:i,resolve:r,reject:o}=function(){let d,f;return{promise:new Promise((y,b)=>{d=y,f=b}),resolve:d,reject:f}}();let a=!1;const h={stopUploading:()=>{a=!1},requestId:e};this.uploadingContext=h;const c=()=>{if(a)for(;;){const d=n.next().value;if(!d){r();break}const f=this.connection.write(d);if(this.onChunkUploaded(d.byteLength,this.connection.idUtf8),!f)break}else o()};try{this.connection.on("drain",c),a=!0,c(),await i}finally{this.connection.off("drain",c),this.uploadingContext===h&&(this.uploadingContext=void 0)}}receivingCommandBytes(t){this.commandChunks||(this.commandChunks=new ss((e)=>{this.commandChunks=void 0;const n=is(e);this.eventHandlers.onCommandReceived(n)}));try{this.commandChunks.addCommandChunk(t)}catch(e){if(!(e instanceof Wt))return;this.commandChunks=void 0}}}const{PeerCommandType:R}=Bi;class zt{constructor(t,e,n,i,r){p(this,"id"),p(this,"peerProtocol"),p(this,"downloadingContext"),p(this,"loadedSegments",new Set()),p(this,"httpLoadingSegments",new Set()),p(this,"downloadingErrors",[]),p(this,"logger",O("p2pml-core:peer")),p(this,"onPeerClosed"),p(this,"onCommandReceived",async(o)=>{var a,h,c,d;switch(o.c){case R.SegmentsAnnouncement:this.loadedSegments=new Set(o.l),this.httpLoadingSegments=new Set(o.p),this.eventHandlers.onSegmentsAnnouncement();break;case R.SegmentRequest:this.peerProtocol.stopUploadingSegmentData(),this.eventHandlers.onSegmentRequested(this,o.i,o.r,o.b);break;case R.SegmentData:{if(!this.downloadingContext||this.downloadingContext.isSegmentDataCommandReceived)break;const{request:f,controls:y,requestId:b}=this.downloadingContext;if(f.segment.externalId!==o.i||b!==o.r)break;this.downloadingContext.isSegmentDataCommandReceived=!0,y.firstBytesReceived(),f.totalBytes===void 0?f.setTotalBytes(o.s):f.totalBytes-f.loadedBytes!==o.s&&(f.clearLoadedBytes(),this.sendCancelSegmentRequestCommand(f.segment,b),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),this.destroy())}break;case R.SegmentDataSendingCompleted:{const f=this.downloadingContext;if(!(f!=null&&f.isSegmentDataCommandReceived))return;const{request:y,controls:b}=f;if(f.request.segment.externalId!==o.i||f.requestId!==o.r)return y.clearLoadedBytes(),this.cancelSegmentDownloading("peer-protocol-violation"),void this.destroy();if(y.loadedBytes!==y.totalBytes)return y.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),void this.destroy();const l=await((h=(a=this.peerConfig).validateP2PSegment)==null?void 0:h.call(a,y.segment.url,y.segment.byteRange))??!0;if(this.downloadingContext!==f)return;if(!l)return y.clearLoadedBytes(),this.cancelSegmentDownloading("p2p-segment-validation-failed"),void this.destroy();this.downloadingErrors=[],b.completeOnSuccess(),this.downloadingContext=void 0;break}case R.SegmentAbsent:((c=this.downloadingContext)==null?void 0:c.request.segment.externalId)===o.i&&((d=this.downloadingContext)==null?void 0:d.requestId)===o.r&&(this.cancelSegmentDownloading("peer-segment-absent"),this.loadedSegments.delete(o.i));break;case R.CancelSegmentRequest:if(this.peerProtocol.getUploadingRequestId()!==o.r)break;this.peerProtocol.stopUploadingSegmentData()}}),p(this,"onSegmentChunkReceived",(o)=>{var a;if(!((a=this.downloadingContext)!=null&&a.isSegmentDataCommandReceived))return;const{request:h,controls:c}=this.downloadingContext;if(h.totalBytes!==void 0&&h.loadedBytes+o.byteLength>h.totalBytes)return h.clearLoadedBytes(),this.cancelSegmentDownloading("peer-response-bytes-length-mismatch"),void this.destroy();c.addLoadedChunk(o)}),p(this,"onPeerConnectionClosed",()=>{this.destroy()}),p(this,"onConnectionError",(o)=>{this.logger(`peer connection error ${this.id}%O`,o),this.eventTarget.getEventDispatcher("onPeerError")({peerId:this.id,streamType:this.streamType,error:o});const a=o.code;(a==="ERR_DATA_CHANNEL"||a==="ERR_CONNECTION_FAILURE")&&this.destroy()}),p(this,"destroy",()=>{this.cancelSegmentDownloading("peer-closed"),this.connection.destroy(),this.eventHandlers.onPeerClosed(this),this.onPeerClosed({peerId:this.id,streamType:this.streamType}),this.logger(`peer closed ${this.id}`)}),this.connection=t,this.eventHandlers=e,this.peerConfig=n,this.streamType=i,this.eventTarget=r,this.onPeerClosed=r.getEventDispatcher("onPeerClose"),this.id=zt.getPeerIdFromConnection(t),this.peerProtocol=new qi(t,n,{onSegmentChunkReceived:this.onSegmentChunkReceived,onCommandReceived:this.onCommandReceived},r),r.getEventDispatcher("onPeerConnect")({peerId:this.id,streamType:i}),t.on("error",this.onConnectionError),t.on("close",this.onPeerConnectionClosed),t.on("end",this.onPeerConnectionClosed),t.on("finish",this.onPeerConnectionClosed)}get downloadingSegment(){var t;return(t=this.downloadingContext)==null?void 0:t.request.segment}getSegmentStatus(t){const{externalId:e}=t;return this.loadedSegments.has(e)?"loaded":this.httpLoadingSegments.has(e)?"http-loading":void 0}downloadSegment(t){if(this.downloadingContext)throw new Error("Some segment already is downloading");this.downloadingContext={request:t,requestId:Math.floor(1e3*Math.random()),isSegmentDataCommandReceived:!1,controls:t.start({downloadSource:"p2p",peerId:this.id},{notReceivingBytesTimeoutMs:this.peerConfig.p2pNotReceivingBytesTimeoutMs,abort:(n)=>{if(!this.downloadingContext)return;const{request:i,requestId:r}=this.downloadingContext;this.sendCancelSegmentRequestCommand(i.segment,r),this.downloadingErrors.push(n),this.downloadingContext=void 0,this.downloadingErrors.filter((o)=>o.type==="bytes-receiving-timeout").length>=this.peerConfig.p2pErrorRetries&&this.destroy()}})};const e={c:R.SegmentRequest,r:this.downloadingContext.requestId,i:t.segment.externalId};t.loadedBytes&&(e.b=t.loadedBytes),this.peerProtocol.sendCommand(e)}async uploadSegmentData(t,e,n){const{externalId:i}=t;this.logger(`send segment ${t.externalId}to ${this.id}`);const r={c:R.SegmentData,i,r:e,s:n.byteLength};this.peerProtocol.sendCommand(r);try{await this.peerProtocol.splitSegmentDataToChunksAndUploadAsync(n,e),this.sendSegmentDataSendingCompletedCommand(t,e),this.logger(`segment ${i}has been sent to ${this.id}`)}catch{this.logger(`cancel segment uploading ${i}`)}}cancelSegmentDownloading(t){if(!this.downloadingContext)return;const{request:e,controls:n}=this.downloadingContext,{segment:i}=e;this.logger(`cancel segment request ${i.externalId}(${t})`);const r=new B(t);n.abortOnError(r),this.downloadingContext=void 0,this.downloadingErrors.push(r)}sendSegmentsAnnouncementCommand(t,e){const n={c:R.SegmentsAnnouncement,p:e,l:t};this.peerProtocol.sendCommand(n)}sendSegmentAbsentCommand(t,e){this.peerProtocol.sendCommand({c:R.SegmentAbsent,i:t,r:e})}sendCancelSegmentRequestCommand(t,e){this.peerProtocol.sendCommand({c:R.CancelSegmentRequest,i:t.externalId,r:e})}sendSegmentDataSendingCompletedCommand(t,e){this.peerProtocol.sendCommand({c:R.SegmentDataSendingCompleted,r:e,i:t.externalId})}static getPeerIdFromConnection(t){return function(e){const n=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)n[i/2]=parseInt(e.slice(i,i+2),16);return new TextDecoder().decode(n)}(t.id)}}function Oi(){const s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),t=/\b(iPad|iPhone|Macintosh).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent);return s||t}class Di{constructor(t,e,n,i,r){p(this,"streamShortId"),p(this,"client"),p(this,"_peers",new Map()),p(this,"logger",O("p2pml-core:p2p-tracker-client")),p(this,"onReceivePeerConnection",(h)=>{const c=zt.getPeerIdFromConnection(h);let d=this._peers.get(c);d!=null&&d.peer?h.destroy():(d||(d={potentialConnections:new Set()},h.idUtf8=c,d.potentialConnections.add(h),this._peers.set(c,d)),h.on("connect",()=>{if(d&&!d.peer){for(const f of d.potentialConnections)f!==h&&f.destroy();d.potentialConnections.clear(),d.peer=new zt(h,{onPeerClosed:this.onPeerClosed,onSegmentRequested:this.eventHandlers.onSegmentRequested,onSegmentsAnnouncement:this.eventHandlers.onSegmentsAnnouncement},this.config,this.stream.type,this.eventTarget),this.logger(`connected with peer:${d.peer.id}${this.streamShortId}`),this.eventHandlers.onPeerConnected(d.peer)}}))}),p(this,"onTrackerClientWarning",(h)=>{this.logger(`tracker warning(${this.streamShortId}:${h})`),this.eventTarget.getEventDispatcher("onTrackerWarning")({streamType:this.stream.type,warning:h})}),p(this,"onTrackerClientError",(h)=>{this.logger(`tracker error(${this.streamShortId}:${h})`),this.eventTarget.getEventDispatcher("onTrackerError")({streamType:this.stream.type,error:h})}),p(this,"onPeerClosed",(h)=>{this.logger(`peer closed:${h.id}`),this._peers.delete(h.id)}),this.stream=e,this.eventHandlers=n,this.config=i,this.eventTarget=r;const o=function(h){const c=Ci.fromUtf8(h).slice(1);return btoa(c)}(t);this.streamShortId=tt(e);const a=function(h){const c=[h],d=20-h.length;for(let f=0;f<d;f++)c.push(ki[Math.floor(62*Math.random())]);return c.join("")}(i.trackerClientVersionPrefix);this.client=new Se({infoHash:ln(o),peerId:ln(a),announce:Oi()?i.announceTrackers.slice(0,1):i.announceTrackers,rtcConfig:this.config.rtcConfig}),this.client.on("peer",this.onReceivePeerConnection),this.client.on("warning",this.onTrackerClientWarning),this.client.on("error",this.onTrackerClientError),this.logger(`create new client;stream:${this.streamShortId};hash:${o}peerId:${a}`)}start(){this.client.start()}destroy(){this.client.destroy();for(const{peer:t,potentialConnections:e}of this._peers.values()){t==null||t.destroy();for(const n of e)n.destroy()}this._peers.clear(),this.logger(`destroy client;stream:${this.streamShortId}`)}*peers(){for(const t of this._peers.values())t!=null&&t.peer&&(yield t.peer)}}function pn(s,t){for(const e of s.values()){const n=e.segments.get(t);if(n)return n}}function Y(s){return`${s.type}-${s.index}`}function Bt(s,t,e,n){const{highDemandTimeWindow:i,httpDownloadTimeWindow:r,p2pDownloadTimeWindow:o}=e;return{isHighDemand:Zt(s,t,i),isHttpDownloadable:Zt(s,t,r),isP2PDownloadable:Zt(s,t,o)&&(!n||n.isSegmentLoadingOrLoadedBySomeone(s))}}function Zt(s,t,e){const{startTime:n,endTime:i}=s,{position:r,rate:o}=t;return!(r+e*o<n||r>i)}class Mi{constructor(t,e,n,i,r,o,a){p(this,"trackerClient"),p(this,"isAnnounceMicrotaskCreated",!1),p(this,"onPeerConnected",(c)=>{const{httpLoading:d,loaded:f}=this.getSegmentsAnnouncement();c.sendSegmentsAnnouncementCommand(f,d)}),p(this,"broadcastAnnouncement",()=>{this.isAnnounceMicrotaskCreated||(this.isAnnounceMicrotaskCreated=!0,queueMicrotask(()=>{const{httpLoading:c,loaded:d}=this.getSegmentsAnnouncement();for(const f of this.trackerClient.peers())f.sendSegmentsAnnouncementCommand(d,c);this.isAnnounceMicrotaskCreated=!1}))}),p(this,"onSegmentRequested",async(c,d,f,y)=>{const b=function(g,u){for(const m of g.segments.values())if(m.externalId===u)return m}(this.stream,d);if(!b)return;const l=await this.segmentStorage.getSegmentData(b);l?await c.uploadSegmentData(b,f,y!==void 0?l.slice(y):l):c.sendSegmentAbsentCommand(d,f)}),this.streamManifestUrl=t,this.stream=e,this.requests=n,this.segmentStorage=i,this.config=r,this.eventTarget=o,this.onSegmentAnnouncement=a;const h=function(c,d){return`v2-${c}-${Y(d)}`}(this.config.swarmId??this.streamManifestUrl,this.stream);this.trackerClient=new Di(h,this.stream,{onPeerConnected:this.onPeerConnected,onSegmentRequested:this.onSegmentRequested,onSegmentsAnnouncement:this.onSegmentAnnouncement},this.config,this.eventTarget),this.segmentStorage.subscribeOnUpdate(this.stream,this.broadcastAnnouncement),this.trackerClient.start()}downloadSegment(t){const e=[];for(const o of this.trackerClient.peers())o.downloadingSegment||o.getSegmentStatus(t)!=="loaded"||e.push(o);const n=(i=e)[Math.floor(Math.random()*i.length)];var i;if(!n)return;const r=this.requests.getOrCreateRequest(t);n.downloadSegment(r)}isSegmentLoadingOrLoadedBySomeone(t){for(const e of this.trackerClient.peers())if(e.getSegmentStatus(t))return!0;return!1}isSegmentLoadedBySomeone(t){for(const e of this.trackerClient.peers())if(e.getSegmentStatus(t)==="loaded")return!0;return!1}get connectedPeerCount(){let t=0;for(const e of this.trackerClient.peers())t++;return t}getSegmentsAnnouncement(){const t=this.segmentStorage.getStoredSegmentExternalIdsOfStream(this.stream),e=[];for(const n of this.requests.httpRequests()){const i=this.stream.segments.get(n.segment.runtimeId);i&&e.push(i.externalId)}return{loaded:t,httpLoading:e}}destroy(){this.segmentStorage.unsubscribeFromUpdate(this.stream,this.broadcastAnnouncement),this.trackerClient.destroy()}}class Ni{constructor(t,e,n,i,r,o,a){p(this,"loaders",new Map()),p(this,"_currentLoaderItem"),p(this,"logger",O("p2pml-core:p2p-loaders-container")),this.streamManifestUrl=t,this.requests=n,this.segmentStorage=i,this.config=r,this.eventTarget=o,this.onSegmentAnnouncement=a,this.changeCurrentLoader(e)}createLoader(t){if(this.loaders.has(t.runtimeId))throw new Error("Loader for this stream already exists");const e=new Mi(this.streamManifestUrl,t,this.requests,this.segmentStorage,this.config,this.eventTarget,()=>{this._currentLoaderItem.loader===e&&this.onSegmentAnnouncement()}),n=tt(t);return this.logger(`created new loader:${n}`),{loader:e,stream:t,loggerInfo:tt(t)}}changeCurrentLoader(t){const e=this.loaders.get(t.runtimeId);if(this._currentLoaderItem&&(this.segmentStorage.getStoredSegmentExternalIdsOfStream(this._currentLoaderItem.stream).length?this.setLoaderDestroyTimeout(this._currentLoaderItem):this.destroyAndRemoveLoader(this._currentLoaderItem)),e)this._currentLoaderItem=e,clearTimeout(e.destroyTimeoutId),e.destroyTimeoutId=void 0;else{const n=this.createLoader(t);this.loaders.set(t.runtimeId,n),this._currentLoaderItem=n}this.logger(`change current p2p loader:${tt(t)}`)}setLoaderDestroyTimeout(t){t.destroyTimeoutId=window.setTimeout(()=>this.destroyAndRemoveLoader(t),this.config.p2pInactiveLoaderDestroyTimeoutMs)}destroyAndRemoveLoader(t){t.loader.destroy(),this.loaders.delete(t.stream.runtimeId),this.logger("destroy p2p loader: ",t.loggerInfo)}get currentLoader(){return this._currentLoaderItem.loader}destroy(){for(const{loader:t,destroyTimeoutId:e}of this.loaders.values())t.destroy(),clearTimeout(e);this.loaders.clear()}}let Ui=class{constructor(s,t,e,n,i,r){p(this,"currentAttempt"),p(this,"_failedAttempts",new Fi()),p(this,"finalData"),p(this,"bytes",[]),p(this,"_loadedBytes",0),p(this,"_totalBytes"),p(this,"_status","not-started"),p(this,"progress"),p(this,"notReceivingBytesTimeout"),p(this,"_abortRequestCallback"),p(this,"_logger"),p(this,"_isHandledByProcessQueue",!1),p(this,"onSegmentError"),p(this,"onSegmentAbort"),p(this,"onSegmentStart"),p(this,"onSegmentLoaded"),p(this,"abortOnTimeout",()=>{var h;if(this.throwErrorIfNotLoadingStatus(),!this.currentAttempt)return;this.setStatus("failed");const c=new B("bytes-receiving-timeout");(h=this._abortRequestCallback)==null||h.call(this,c),this.logger(`${this.downloadSource}${this.segment.externalId}failed ${c.type}`),this._failedAttempts.add({...this.currentAttempt,error:c}),this.onSegmentError({segment:this.segment,error:c,downloadSource:this.currentAttempt.downloadSource,peerId:this.currentAttempt.downloadSource==="p2p"?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback()}),p(this,"abortOnError",(h)=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.setStatus("failed"),this.logger(`${this.downloadSource}${this.segment.externalId}failed ${h.type}`),this._failedAttempts.add({...this.currentAttempt,error:h}),this.onSegmentError({segment:this.segment,error:h,downloadSource:this.currentAttempt.downloadSource,peerId:this.currentAttempt.downloadSource==="p2p"?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.notReceivingBytesTimeout.clear(),this.manageBandwidthCalculatorsState("stop"),this.requestProcessQueueCallback())}),p(this,"completeOnSuccess",()=>{this.throwErrorIfNotLoadingStatus(),this.currentAttempt&&(this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear(),this.finalData=Ce(this.bytes),this.setStatus("succeed"),this._totalBytes=this._loadedBytes,this.onSegmentLoaded({segmentUrl:this.segment.url,bytesLength:this.finalData.byteLength,downloadSource:this.currentAttempt.downloadSource,peerId:this.currentAttempt.downloadSource==="p2p"?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this.logger(`${this.currentAttempt.downloadSource}${this.segment.externalId}succeed`),this.requestProcessQueueCallback())}),p(this,"addLoadedChunk",(h)=>{if(this.throwErrorIfNotLoadingStatus(),!this.currentAttempt||!this.progress)return;this.notReceivingBytesTimeout.restart();const c=h.byteLength,{all:d,http:f}=this.bandwidthCalculators;d.addBytes(c),this.currentAttempt.downloadSource==="http"&&f.addBytes(c),this.bytes.push(h),this.progress.lastLoadedChunkTimestamp=performance.now(),this.progress.loadedBytes+=c,this._loadedBytes+=c}),p(this,"firstBytesReceived",()=>{this.throwErrorIfNotLoadingStatus(),this.notReceivingBytesTimeout.restart();}),this.segment=s,this.requestProcessQueueCallback=t,this.bandwidthCalculators=e,this.playback=n,this.playbackConfig=i,this.onSegmentError=r.getEventDispatcher("onSegmentError"),this.onSegmentAbort=r.getEventDispatcher("onSegmentAbort"),this.onSegmentStart=r.getEventDispatcher("onSegmentStart"),this.onSegmentLoaded=r.getEventDispatcher("onSegmentLoaded");const{byteRange:o}=this.segment;if(o){const{end:h,start:c}=o;this._totalBytes=h-c+1}this.notReceivingBytesTimeout=new Hi(this.abortOnTimeout);const{type:a}=this.segment.stream;this._logger=O(`p2pml-core:request-${a}`)}clearLoadedBytes(){this._loadedBytes=0,this.bytes=[],this._totalBytes=void 0}get status(){return this._status}setStatus(s){this._status=s,this._isHandledByProcessQueue=!1}get downloadSource(){var s;return(s=this.currentAttempt)==null?void 0:s.downloadSource}get loadedBytes(){return this._loadedBytes}get totalBytes(){return this._totalBytes}get data(){if(this.status==="succeed")return this.finalData||(this.finalData=Ce(this.bytes)),this.finalData}get failedAttempts(){return this._failedAttempts}get isHandledByProcessQueue(){return this._isHandledByProcessQueue}markHandledByProcessQueue(){this._isHandledByProcessQueue=!0}setTotalBytes(s){if(this._totalBytes!==void 0)throw new Error("Request total bytes value is already set");this._totalBytes=s}start(s,t){if(this._status==="succeed")throw new Error(`Request ${this.segment.externalId}has been already succeed.`);if(this._status==="loading")throw new Error(`Request ${this.segment.externalId}has been already started.`);this.setStatus("loading"),this.currentAttempt={...s},this.progress={startFromByte:this._loadedBytes,loadedBytes:0,startTimestamp:performance.now()},this.manageBandwidthCalculatorsState("start");const{notReceivingBytesTimeoutMs:e,abort:n}=t;return this._abortRequestCallback=n,e!==void 0&&this.notReceivingBytesTimeout.start(e),this.logger(`${s.downloadSource}${this.segment.externalId}started`),this.onSegmentStart({segment:this.segment,downloadSource:s.downloadSource,peerId:s.downloadSource==="p2p"?s.peerId:void 0}),{firstBytesReceived:this.firstBytesReceived,addLoadedChunk:this.addLoadedChunk,completeOnSuccess:this.completeOnSuccess,abortOnError:this.abortOnError}}abortFromProcessQueue(){var s,t,e,n;this.throwErrorIfNotLoadingStatus(),this.setStatus("aborted"),this.logger(`${(s=this.currentAttempt)==null?void 0:s.downloadSource}${this.segment.externalId}aborted`),(t=this._abortRequestCallback)==null||t.call(this,new B("abort")),this.onSegmentAbort({segment:this.segment,downloadSource:(e=this.currentAttempt)==null?void 0:e.downloadSource,peerId:((n=this.currentAttempt)==null?void 0:n.downloadSource)==="p2p"?this.currentAttempt.peerId:void 0,streamType:this.segment.stream.type}),this._abortRequestCallback=void 0,this.manageBandwidthCalculatorsState("stop"),this.notReceivingBytesTimeout.clear()}throwErrorIfNotLoadingStatus(){if(this._status!=="loading")throw new Error(`Request has been already ${this.status}.`)}logger(s){var t;this._logger.color=((t=this.currentAttempt)==null?void 0:t.downloadSource)==="http"?"green":"red",this._logger(s),this._logger.color=""}manageBandwidthCalculatorsState(s){var t;const{all:e,http:n}=this.bandwidthCalculators,i=s==="start"?"startLoading":"stopLoading";((t=this.currentAttempt)==null?void 0:t.downloadSource)==="http"&&n[i](),e[i]()}};class Fi{constructor(){p(this,"attempts",[])}add(t){this.attempts.push(t)}get httpAttemptsCount(){return this.attempts.reduce((t,e)=>e.downloadSource==="http"?t+1:t,0)}get lastAttempt(){return this.attempts[this.attempts.length-1]}clear(){this.attempts=[]}}class Hi{constructor(t){p(this,"timeoutId"),p(this,"ms"),this.action=t}start(t){if(this.timeoutId)throw new Error("Timeout is already started.");this.ms=t,this.timeoutId=window.setTimeout(this.action,this.ms)}restart(t){this.timeoutId&&clearTimeout(this.timeoutId),t&&(this.ms=t),this.ms&&(this.timeoutId=window.setTimeout(this.action,this.ms))}clear(){clearTimeout(this.timeoutId),this.timeoutId=void 0}}class $i{constructor(t,e,n,i,r){p(this,"requests",new Map()),this.requestProcessQueueCallback=t,this.bandwidthCalculators=e,this.playback=n,this.config=i,this.eventTarget=r}get executingHttpCount(){let t=0;for(const e of this.httpRequests())e.status==="loading"&&t++;return t}get executingP2PCount(){let t=0;for(const e of this.p2pRequests())e.status==="loading"&&t++;return t}get(t){return this.requests.get(t)}getOrCreateRequest(t){let e=this.requests.get(t);return e||(e=new Ui(t,this.requestProcessQueueCallback,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),this.requests.set(t,e)),e}remove(t){this.requests.delete(t.segment)}items(){return this.requests.values()}*httpRequests(){for(const t of this.requests.values())t.downloadSource==="http"&&(yield t)}*p2pRequests(){for(const t of this.requests.values())t.downloadSource==="p2p"&&(yield t)}destroy(){for(const t of this.requests.values())t.status==="loading"&&t.abortFromProcessQueue();this.requests.clear()}}class ji{constructor(t,e){p(this,"_status","pending"),p(this,"_shouldBeStartedImmediately",!1),this.segment=t,this.engineCallbacks=e}get status(){return this._status}get shouldBeStartedImmediately(){return this._shouldBeStartedImmediately}resolve(t,e){this._status==="pending"&&(this._status="succeed",this.engineCallbacks.onSuccess({data:t,bandwidth:e}))}reject(){this._status==="pending"&&(this._status="failed",this.engineCallbacks.onError(new Dt("failed")))}abort(){this._status==="pending"&&(this._status="aborted",this.engineCallbacks.onError(new Dt("aborted")))}markAsShouldBeStartedImmediately(){this._shouldBeStartedImmediately=!0}}function*mn(s,t,e,n){const{runtimeId:i,stream:r}=s,o=r.segments.get(i);if(!o)return;const a=r.segments.values();let h;do{const d=a.next();if(d.done)return;h=d.value}while(h!==o);const c=Bt(h,t,e,n);if(te(c)){const d=a.next();if(d.done)return;const f=d.value,y=Bt(f,t,e,n);if(te(y))return;c.isHighDemand=!0,yield{segment:h,statuses:c},yield{segment:f,statuses:y}}else yield{segment:h,statuses:c};for(const d of a){const f=Bt(d,t,e,n);if(te(f))break;yield{segment:d,statuses:f}}}function te(s){const{isHighDemand:t=!1,isHttpDownloadable:e=!1,isP2PDownloadable:n=!1}=s;return!t&&!e&&!n}class Wi{constructor(t,e,n,i,r,o,a){p(this,"requests"),p(this,"engineRequest"),p(this,"p2pLoaders"),p(this,"playback"),p(this,"segmentAvgDuration"),p(this,"logger"),p(this,"storageCleanUpIntervalId"),p(this,"levelChangedTimestamp"),p(this,"lastQueueProcessingTimeStamp"),p(this,"randomHttpDownloadInterval"),p(this,"isProcessQueueMicrotaskCreated",!1),p(this,"requestProcessQueueMicrotask",(c=!0)=>{const d=performance.now();!c&&this.lastQueueProcessingTimeStamp!==void 0&&d-this.lastQueueProcessingTimeStamp<=1e3||this.isProcessQueueMicrotaskCreated||(this.isProcessQueueMicrotaskCreated=!0,queueMicrotask(()=>{try{this.processQueue(),this.lastQueueProcessingTimeStamp=d}finally{this.isProcessQueueMicrotaskCreated=!1}}))}),this.streamManifestUrl=t,this.lastRequestedSegment=e,this.streamDetails=n,this.config=i,this.bandwidthCalculators=r,this.segmentStorage=o,this.eventTarget=a;const h=this.lastRequestedSegment.stream;if(this.playback={position:this.lastRequestedSegment.startTime,rate:1},this.segmentAvgDuration=function(c){const{segments:d}=c;let f=0;const y=d.size;for(const b of d.values())f+=b.endTime-b.startTime;return f/y}(h),this.requests=new $i(this.requestProcessQueueMicrotask,this.bandwidthCalculators,this.playback,this.config,this.eventTarget),!this.segmentStorage.isInitialized)throw new Error("Segment storage is not initialized.");this.segmentStorage.addIsSegmentLockedPredicate((c)=>c.stream===h&&function(d,f,y){const{isHighDemand:b=!1,isHttpDownloadable:l=!1,isP2PDownloadable:g=!1}=Bt(d,f,y);return b||l||g}(c,this.playback,this.config)),this.p2pLoaders=new Ni(this.streamManifestUrl,this.lastRequestedSegment.stream,this.requests,this.segmentStorage,this.config,this.eventTarget,this.requestProcessQueueMicrotask),this.logger=O(`p2pml-core:hybrid-loader-${h.type}`),this.logger.color="coral",this.setIntervalLoading()}setIntervalLoading(){const t=this.p2pLoaders.currentLoader.connectedPeerCount,e=1e3*Math.random()*t+1e3;this.randomHttpDownloadInterval=window.setTimeout(()=>{this.loadRandomThroughHttp(),this.setIntervalLoading()},e)}async loadSegment(t,e){this.logger(`requests:${dn(t)}`);const{stream:n}=t;n!==this.lastRequestedSegment.stream&&(this.logger(`stream changed to ${tt(n)}`),this.p2pLoaders.changeCurrentLoader(n)),this.lastRequestedSegment=t;const i=new ji(t,e);if(this.segmentStorage.hasSegment(t)){const r=await this.segmentStorage.getSegmentData(t);if(r){const{queueDownloadRatio:o}=this.generateQueue();i.resolve(r,this.getBandwidth(o))}}else this.engineRequest=i;this.requestProcessQueueMicrotask()}processRequests(t,e){var n;const{stream:i}=this.lastRequestedSegment,{httpErrorRetries:r}=this.config,o=performance.now();for(const a of this.requests.items()){const{downloadSource:h,status:c,segment:d,isHandledByProcessQueue:f}=a,y=((n=this.engineRequest)==null?void 0:n.segment)===d?this.engineRequest:void 0;switch(c){case"loading":t.has(d.runtimeId)||y||(a.abortFromProcessQueue(),this.requests.remove(a));break;case"succeed":if(!a.data||!h)break;h==="http"&&this.p2pLoaders.currentLoader.broadcastAnnouncement(),y&&(y.resolve(a.data,this.getBandwidth(e)),this.engineRequest=void 0),this.requests.remove(a),this.segmentStorage.storeSegment(a.segment,a.data,this.streamDetails.isLive);break;case"failed":h!=="http"||f||this.p2pLoaders.currentLoader.broadcastAnnouncement(),y||i.segments.has(a.segment.runtimeId)||this.requests.remove(a),a.failedAttempts.httpAttemptsCount>=r&&y&&(this.engineRequest=void 0,y.reject());break;case"not-started":case"aborted":this.requests.remove(a)}a.markHandledByProcessQueue();const{lastAttempt:b}=a.failedAttempts;b&&o-b.error.timestamp>6e4&&a.failedAttempts.clear()}}processQueue(){var t;const{queue:e,queueSegmentIds:n,queueDownloadRatio:i}=this.generateQueue();this.processRequests(n,i);const{simultaneousHttpDownloads:r,simultaneousP2PDownloads:o,httpErrorRetries:a}=this.config;if((t=this.engineRequest)!=null&&t.shouldBeStartedImmediately&&this.engineRequest.status==="pending"&&this.requests.executingHttpCount<r){const{segment:h}=this.engineRequest,c=this.requests.get(h);(!c||c.status==="not-started"||c.status==="failed"&&c.failedAttempts.httpAttemptsCount<this.config.httpErrorRetries)&&this.loadThroughHttp(h)}for(const h of e){const{statuses:c,segment:d}=h,f=this.requests.get(d);if(c.isHighDemand){if((f==null?void 0:f.downloadSource)==="http"&&f.status==="loading"||(f==null?void 0:f.downloadSource)==="http"&&f.status==="failed"&&f.failedAttempts.httpAttemptsCount>=a)continue;const y=(f==null?void 0:f.status)==="loading"&&f.downloadSource==="p2p";if(this.requests.executingHttpCount<r){y&&f.abortFromProcessQueue(),this.loadThroughHttp(d);continue}if(this.abortLastHttpLoadingInQueueAfterItem(e,d)&&this.requests.executingHttpCount<r){y&&f.abortFromProcessQueue(),this.loadThroughHttp(d);continue}if(y)continue;if(this.requests.executingP2PCount<o){this.loadThroughP2P(d);continue}if(this.abortLastP2PLoadingInQueueAfterItem(e,d)&&this.requests.executingP2PCount<o){this.loadThroughP2P(d);continue}}else if(c.isP2PDownloadable){if((f==null?void 0:f.status)==="loading")continue;(this.requests.executingP2PCount<o||this.p2pLoaders.currentLoader.isSegmentLoadedBySomeone(d)&&this.abortLastP2PLoadingInQueueAfterItem(e,d)&&this.requests.executingP2PCount<o)&&this.loadThroughP2P(d)}}}abortSegmentRequest(t){var e;((e=this.engineRequest)==null?void 0:e.segment.runtimeId)===t&&(this.engineRequest.abort(),this.logger("abort: ",dn(this.engineRequest.segment)),this.engineRequest=void 0,this.requestProcessQueueMicrotask())}loadThroughHttp(t){const e=this.requests.getOrCreateRequest(t);new gs(e,this.config,this.eventTarget),this.p2pLoaders.currentLoader.broadcastAnnouncement()}loadThroughP2P(t){this.p2pLoaders.currentLoader.downloadSegment(t)}loadRandomThroughHttp(){const{simultaneousHttpDownloads:t,httpErrorRetries:e}=this.config,n=this.p2pLoaders.currentLoader;if(this.requests.executingHttpCount>=t||!n.connectedPeerCount)return;const i=[];for(const{segment:c,statuses:d}of mn(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader)){if(!d.isHttpDownloadable||d.isP2PDownloadable||this.segmentStorage.hasSegment(c))continue;const f=this.requests.get(c);f&&(f.status==="loading"||f.status==="succeed"||(f.failedAttempts.httpAttemptsCount??0)>=e)||i.push(c)}if(!i.length||t-this.requests.executingHttpCount===0)return;const r=n.connectedPeerCount+1,o=Math.min(i.length,t*r),a=function(c){for(let d=c.length-1;d>0;d--){const f=Math.floor(Math.random()*(d+1));[c[d],c[f]]=[c[f],c[d]]}return c}(Array.from({length:o},(c,d)=>d));let h=o/r;for(const c of a){if(this.requests.executingHttpCount>=t)break;if(h>=1||Math.random()<=h){const d=i[c];this.loadThroughHttp(d)}if(h--,h<=0)break}}abortLastHttpLoadingInQueueAfterItem(t,e){for(const{segment:n}of un(t)){if(n===e)break;const i=this.requests.get(n);if((i==null?void 0:i.downloadSource)==="http"&&i.status==="loading")return i.abortFromProcessQueue(),!0}return!1}abortLastP2PLoadingInQueueAfterItem(t,e){for(const{segment:n}of un(t)){if(n===e)break;const i=this.requests.get(n);if((i==null?void 0:i.downloadSource)==="p2p"&&i.status==="loading")return i.abortFromProcessQueue(),!0}return!1}generateQueue(){var t;const e=[],n=new Set();let i=0,r=0;for(const o of mn(this.lastRequestedSegment,this.playback,this.config,this.p2pLoaders.currentLoader)){i++;const{segment:a}=o;this.segmentStorage.hasSegment(a)||((t=this.requests.get(a))==null?void 0:t.status)==="succeed"?r++:(e.push(o),n.add(a.runtimeId))}return{queue:e,queueSegmentIds:n,maxPossibleLength:i,alreadyLoadedCount:r,queueDownloadRatio:i!==0?r/i:0}}getBandwidth(t){const{http:e,all:n}=this.bandwidthCalculators,{activeLevelBitrate:i}=this.streamDetails;if(this.streamDetails.activeLevelBitrate===0)return n.getBandwidthLoadingOnly(3);const r=Math.max(n.getBandwidth(30,this.levelChangedTimestamp),n.getBandwidth(60,this.levelChangedTimestamp),n.getBandwidth(90,this.levelChangedTimestamp));if(t>=0.8||r>=0.9*i)return Math.max(n.getBandwidthLoadingOnly(1),n.getBandwidthLoadingOnly(3),n.getBandwidthLoadingOnly(5));const o=Math.max(e.getBandwidthLoadingOnly(1),e.getBandwidthLoadingOnly(3),e.getBandwidthLoadingOnly(5));return Math.max(r,o)}notifyLevelChanged(){this.levelChangedTimestamp=performance.now()}updatePlayback(t,e){var n;const i=this.playback.rate!==e,r=this.playback.position!==t;if(!i&&!r)return;const o=Math.abs(t-this.playback.position)/this.segmentAvgDuration>0.5;r&&(this.playback.position=t),i&&e!==0&&(this.playback.rate=e),o&&(this.logger("position significantly changed"),(n=this.engineRequest)==null||n.markAsShouldBeStartedImmediately()),this.requestProcessQueueMicrotask(o)}updateStream(t){t===this.lastRequestedSegment.stream&&(this.logger(`update stream:${tt(t)}`),this.requestProcessQueueMicrotask())}destroy(){var t;clearInterval(this.storageCleanUpIntervalId),clearInterval(this.randomHttpDownloadInterval),this.storageCleanUpIntervalId=void 0,(t=this.engineRequest)==null||t.abort(),this.requests.destroy(),this.p2pLoaders.destroy()}}class yn{constructor(t=2e4){p(this,"loadingsCount",0),p(this,"bytes",[]),p(this,"loadingOnlyTimestamps",[]),p(this,"timestamps",[]),p(this,"noLoadingsTime",0),p(this,"loadingsStoppedAt",0),this.clearThresholdMs=t}addBytes(t,e=performance.now()){this.bytes.push(t),this.loadingOnlyTimestamps.push(e-this.noLoadingsTime),this.timestamps.push(e)}startLoading(t=performance.now()){this.clearStale(),this.loadingsCount===0&&this.loadingsStoppedAt!==0&&(this.noLoadingsTime+=t-this.loadingsStoppedAt),this.loadingsCount++}stopLoading(t=performance.now()){this.loadingsCount>0&&(this.loadingsCount--,this.loadingsCount===0&&(this.loadingsStoppedAt=t))}getBandwidthLoadingOnly(t,e=Number.NEGATIVE_INFINITY){if(!this.loadingOnlyTimestamps.length)return 0;const n=1e3*t,i=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1];let r=i;const o=i-n;let a=0;for(let h=this.bytes.length-1;h>=0;h--){const c=this.loadingOnlyTimestamps[h];if(c<o||this.timestamps[h]<e)break;r=c,a+=this.bytes[h]}return 8e3*a/(i-r)}getBandwidth(t,e=Number.NEGATIVE_INFINITY,n=performance.now()){if(!this.timestamps.length)return 0;const i=n-1e3*t;let r=n,o=0;for(let a=this.bytes.length-1;a>=0;a--){const h=this.timestamps[a];if(h<i||h<e)break;r=h,o+=this.bytes[a]}return 8e3*o/(n-r)}clearStale(){if(!this.loadingOnlyTimestamps.length)return;const t=this.loadingOnlyTimestamps[this.loadingOnlyTimestamps.length-1]-this.clearThresholdMs;let e=0;for(const n of this.loadingOnlyTimestamps){if(n>t)break;e++}this.bytes.splice(0,e),this.loadingOnlyTimestamps.splice(0,e),this.timestamps.splice(0,e)}}class os{constructor(){p(this,"events",new Map())}dispatchEvent(t,...e){const n=this.events.get(t);if(n)for(const i of n)i(...e)}getEventDispatcher(t){let e=this.events.get(t);e||(e=[],this.events.set(t,e));const n=e;return(...i)=>{for(const r of n)r(...i)}}addEventListener(t,e){const n=this.events.get(t);n?n.push(e):this.events.set(t,[e])}removeEventListener(t,e){const n=this.events.get(t);if(n){const i=n.indexOf(e);i!==-1&&n.splice(i,1)}}}function ee(s){return`${Y(s.stream)}|${s.externalId}`}class Qi{constructor(t){p(this,"cache",new Map()),p(this,"_isInitialized",!1),p(this,"isSegmentLockedPredicates",[]),p(this,"logger"),p(this,"eventTarget",new os()),this.storageConfig=t,this.logger=O("p2pml-core:segment-memory-storage"),this.logger.color="RebeccaPurple"}async initialize(){this._isInitialized=!0,this.logger("initialized")}get isInitialized(){return this._isInitialized}addIsSegmentLockedPredicate(t){this.isSegmentLockedPredicates.push(t)}isSegmentLocked(t){return this.isSegmentLockedPredicates.some((e)=>e(t))}async storeSegment(t,e,n){const i=ee(t);this.cache.set(i,{segment:t,data:e,lastAccessed:performance.now()}),this.logger(`add segment:${i}`),this.dispatchStorageUpdatedEvent(t.stream),this.clear(n)}async getSegmentData(t){const e=ee(t),n=this.cache.get(e);if(n!==void 0)return n.lastAccessed=performance.now(),n.data}hasSegment(t){const e=ee(t);return this.cache.has(e)}getStoredSegmentExternalIdsOfStream(t){const e=Y(t),n=[];for(const{segment:i}of this.cache.values())Y(i.stream)===e&&n.push(i.externalId);return n}async clear(t){const e=1e3*(this.storageConfig.cachedSegmentExpiration??(t?1200:0));if(e===0)return!1;const n=[],i=[],r=new Set(),o=performance.now();for(const a of this.cache.entries()){const[h,c]=a,{lastAccessed:d,segment:f}=c;o-d>e?this.isSegmentLocked(f)||(n.push(h),r.add(f.stream)):i.push(a)}if(this.storageConfig.cachedSegmentsCount>0){let a=i.length-this.storageConfig.cachedSegmentsCount;if(a>0){i.sort(([,h],[,c])=>h.lastAccessed-c.lastAccessed);for(const[h,{segment:c}]of i)if(!this.isSegmentLocked(c)&&(n.push(h),r.add(c.stream),a--,a===0))break}}if(n.length){this.logger(`cleared ${n.length}segments`),n.forEach((a)=>this.cache.delete(a));for(const a of r)this.dispatchStorageUpdatedEvent(a)}return n.length>0}subscribeOnUpdate(t,e){const n=Y(t);this.eventTarget.addEventListener(`onStorageUpdated-${n}`,e)}unsubscribeFromUpdate(t,e){const n=Y(t);this.eventTarget.removeEventListener(`onStorageUpdated-${n}`,e)}dispatchStorageUpdatedEvent(t){this.eventTarget.dispatchEvent(`onStorageUpdated-${Y(t)}`,t)}async destroy(){this.cache.clear(),this._isInitialized=!1}}const xe=class qt{constructor(t){p(this,"eventTarget",new os()),p(this,"manifestResponseUrl"),p(this,"streams",new Map()),p(this,"mainStreamConfig"),p(this,"secondaryStreamConfig"),p(this,"commonCoreConfig"),p(this,"bandwidthCalculators",{all:new yn(),http:new yn()}),p(this,"segmentStorage"),p(this,"mainStreamLoader"),p(this,"secondaryStreamLoader"),p(this,"streamDetails",{isLive:!1,activeLevelBitrate:0});const e=function n(i){if(ts(i)){const r={};return Object.keys(i).forEach((o)=>{if(i[o]!==void 0){const a=n(i[o]);a!==void 0&&(r[o]=a)}}),r}return i}(t??{});this.commonCoreConfig=Xt({defaultConfig:qt.DEFAULT_COMMON_CORE_CONFIG,baseConfig:e}),this.mainStreamConfig=Xt({defaultConfig:qt.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:e==null?void 0:e.mainStream}),this.secondaryStreamConfig=Xt({defaultConfig:qt.DEFAULT_STREAM_CONFIG,baseConfig:e,specificStreamConfig:e==null?void 0:e.secondaryStream})}getConfig(){return{...ot(this.commonCoreConfig),mainStream:ot(this.mainStreamConfig),secondaryStream:ot(this.secondaryStreamConfig)}}applyDynamicConfig(t){const{mainStream:e,secondaryStream:n}=t;this.overrideAllConfigs(t,e,n),this.mainStreamConfig.isP2PDisabled&&this.destroyStreamLoader("main"),this.secondaryStreamConfig.isP2PDisabled&&this.destroyStreamLoader("secondary")}addEventListener(t,e){this.eventTarget.addEventListener(t,e)}removeEventListener(t,e){this.eventTarget.removeEventListener(t,e)}setManifestResponseUrl(t){this.manifestResponseUrl=t.split("?")[0]}hasSegment(t){return!!pn(this.streams,t)}getStream(t){return this.streams.get(t)}addStreamIfNoneExists(t){this.streams.has(t.runtimeId)||this.streams.set(t.runtimeId,{...t,segments:new Map()})}updateStream(t,e,n){var i,r;const o=this.streams.get(t);if(o){if(e)for(const a of e)o.segments.has(a.runtimeId)||o.segments.set(a.runtimeId,{...a,stream:o});if(n)for(const a of n)o.segments.delete(a);(i=this.mainStreamLoader)==null||i.updateStream(o),(r=this.secondaryStreamLoader)==null||r.updateStream(o)}}async loadSegment(t,e){if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");this.segmentStorage||(this.segmentStorage=new Qi(this.commonCoreConfig),await this.segmentStorage.initialize());const n=this.identifySegment(t);this.getStreamHybridLoader(n).loadSegment(n,e)}abortSegmentLoading(t){var e,n;(e=this.mainStreamLoader)==null||e.abortSegmentRequest(t),(n=this.secondaryStreamLoader)==null||n.abortSegmentRequest(t)}updatePlayback(t,e){var n,i;(n=this.mainStreamLoader)==null||n.updatePlayback(t,e),(i=this.secondaryStreamLoader)==null||i.updatePlayback(t,e)}setActiveLevelBitrate(t){var e,n;t!==this.streamDetails.activeLevelBitrate&&(this.streamDetails.activeLevelBitrate=t,(e=this.mainStreamLoader)==null||e.notifyLevelChanged(),(n=this.secondaryStreamLoader)==null||n.notifyLevelChanged())}setIsLive(t){this.streamDetails.isLive=t}isSegmentLoadable(t){try{const e=this.identifySegment(t);return(e.stream.type!=="main"||!this.mainStreamConfig.isP2PDisabled)&&(e.stream.type!=="secondary"||!this.secondaryStreamConfig.isP2PDisabled)}catch{return!1}}destroy(){var t,e,n;this.streams.clear(),(t=this.mainStreamLoader)==null||t.destroy(),(e=this.secondaryStreamLoader)==null||e.destroy(),(n=this.segmentStorage)==null||n.destroy(),this.mainStreamLoader=void 0,this.secondaryStreamLoader=void 0,this.segmentStorage=void 0,this.manifestResponseUrl=void 0,this.streamDetails={isLive:!1,activeLevelBitrate:0}}identifySegment(t){if(!this.manifestResponseUrl)throw new Error("Manifest response url is undefined");const e=pn(this.streams,t);if(!e)throw new Error(`Not found segment with id:${t}`);return e}overrideAllConfigs(t,e,n){dt(this.commonCoreConfig,t),dt(this.mainStreamConfig,t),dt(this.secondaryStreamConfig,t),e&&dt(this.mainStreamConfig,e),n&&dt(this.secondaryStreamConfig,n)}destroyStreamLoader(t){var e,n;t==="main"?((e=this.mainStreamLoader)==null||e.destroy(),this.mainStreamLoader=void 0):((n=this.secondaryStreamLoader)==null||n.destroy(),this.secondaryStreamLoader=void 0)}getStreamHybridLoader(t){return t.stream.type==="main"?(this.mainStreamLoader??(this.mainStreamLoader=this.createNewHybridLoader(t)),this.mainStreamLoader):(this.secondaryStreamLoader??(this.secondaryStreamLoader=this.createNewHybridLoader(t)),this.secondaryStreamLoader)}createNewHybridLoader(t){var e;if(!this.manifestResponseUrl)throw new Error("Manifest response url is not defined");if(!((e=this.segmentStorage)!=null&&e.isInitialized))throw new Error("Segment storage is not initialized");const n=t.stream.type==="main"?this.mainStreamConfig:this.secondaryStreamConfig;return new Wi(this.manifestResponseUrl,t,this.streamDetails,n,this.bandwidthCalculators,this.segmentStorage,this.eventTarget)}};p(xe,"DEFAULT_COMMON_CORE_CONFIG",{cachedSegmentExpiration:void 0,cachedSegmentsCount:0}),p(xe,"DEFAULT_STREAM_CONFIG",{isP2PDisabled:!1,simultaneousHttpDownloads:2,simultaneousP2PDownloads:3,highDemandTimeWindow:15,httpDownloadTimeWindow:3e3,p2pDownloadTimeWindow:6e3,webRtcMaxMessageSize:65535,p2pNotReceivingBytesTimeoutMs:2e3,p2pInactiveLoaderDestroyTimeoutMs:3e4,httpNotReceivingBytesTimeoutMs:3e3,httpErrorRetries:3,p2pErrorRetries:3,trackerClientVersionPrefix:Li,announceTrackers:[],rtcConfig:{iceServers:[]},validateP2PSegment:void 0,httpRequestSetup:void 0,swarmId:void 0});let zi=xe;const Vi=Sn.debug;var st,Ot,N,K,G,J,ft,as,Ee,z,Gi=Object.defineProperty,hs=(s)=>{throw TypeError(s);},x=(s,t,e)=>((n,i,r)=>i in n?Gi(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r)(s,typeof t!="symbol"?t+"":t,e),Ie=(s,t,e)=>t.has(s)||hs("Cannot "+e),S=(s,t,e)=>(Ie(s,t,"read from private field"),e?e.call(s):t.get(s)),H=(s,t,e)=>t.has(s)?hs("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),$=(s,t,e,n)=>(Ie(s,t,"write to private field"),t.set(s,e),e),ne=(s,t,e)=>(Ie(s,t,"access private method"),e);function cs(s,t){return t?`${s}|${t.start}-${t.end}`:s}function ds(s,t){if(s!==void 0&&t!==void 0&&s<=t)return{start:s,end:t}}class Ji{constructor(t,e){H(this,ft),x(this,"context"),x(this,"config"),x(this,"stats"),H(this,st),H(this,Ot),H(this,N),H(this,K),H(this,G),H(this,J),$(this,K,e),$(this,Ot,()=>new t.loader(t)),this.stats={aborted:!1,chunkCount:0,loading:{start:0,first:0,end:0},buffering:{start:0,first:0,end:0},parsing:{start:0,end:0},total:1,loaded:1,bwEstimate:0,retry:0}}load(t,e,n){var i;this.context=t,this.config=e,$(this,st,n);const r=this.stats,{rangeStart:o,rangeEnd:a}=t,h=ds(o,a!==void 0?a-1:void 0);$(this,J,cs(t.url,h));const c=S(this,K).isSegmentLoadable(S(this,J));if(!S(this,K).hasSegment(S(this,J))||c===!1)return $(this,N,S(this,Ot).call(this)),S(this,N).stats=this.stats,void((i=S(this,N))==null||i.load(t,e,n));S(this,K).loadSegment(S(this,J),{onSuccess:(d)=>{$(this,G,d);const f=S(this,G).data.byteLength;r.loading=function(y,b,l){const g=8e3*b/y,u=l-g;return{start:u-10,first:u,end:l}}(S(this,G).bandwidth,f,performance.now()),r.total=r.loaded=f,n.onProgress&&n.onProgress(this.stats,t,S(this,G).data,void 0),n.onSuccess({data:S(this,G).data,url:t.url},this.stats,t,void 0)},onError:(d)=>{d instanceof Dt&&d.type==="aborted"&&this.stats.aborted||ne(this,ft,as).call(this,d)}})}abort(){var t,e;S(this,N)?S(this,N).abort():(ne(this,ft,Ee).call(this),(e=(t=S(this,st))==null?void 0:t.onAbort)==null||e.call(t,this.stats,this.context,{}))}destroy(){S(this,N)?S(this,N).destroy():(this.stats.aborted||ne(this,ft,Ee).call(this),$(this,st,null),this.config=null)}}st=new WeakMap(),Ot=new WeakMap(),N=new WeakMap(),K=new WeakMap(),G=new WeakMap(),J=new WeakMap(),ft=new WeakSet(),as=function(s){var t;const e={code:0,text:""};(s instanceof Dt&&s.type==="failed"||s instanceof Error)&&(e.text=s.message),(t=S(this,st))==null||t.onError(e,this.context,null,this.stats)},Ee=function(){!S(this,G)&&S(this,J)&&(this.stats.aborted=!0,S(this,K).abortSegmentLoading(S(this,J)))};class Yi{constructor(t){H(this,z),x(this,"context"),x(this,"stats"),$(this,z,new t.loader(t)),this.stats=S(this,z).stats,this.context=S(this,z).context}load(t,e,n){S(this,z).load(t,e,n)}abort(){S(this,z).abort()}destroy(){S(this,z).destroy()}}z=new WeakMap();class Ki{constructor(t){x(this,"core"),this.core=t}processMainManifest(t){const{levels:e,audioTracks:n}=t;for(const[i,r]of e.entries()){const{url:o}=r;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(o)?o[0]:o,type:"main",index:i})}for(const[i,r]of n.entries()){const{url:o}=r;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(o)?o[0]:o,type:"secondary",index:i})}}updatePlaylist(t){if(!t.details)return;const{details:{url:e,fragments:n,live:i}}=t,r=this.core.getStream(e);if(!r)return;const o=new Set(r.segments.keys()),a=[];n.forEach((h,c)=>{const{url:d,byteRange:f,sn:y,start:b,end:l}=h;if(y==="initSegment")return;const[g,u]=f,m=ds(g,u!==void 0?u-1:void 0),_=cs(d,m);o.delete(_),r.segments.has(_)||a.push({runtimeId:_,url:d,externalId:i?y:c,byteRange:m,startTime:b,endTime:l})}),(a.length||o.size)&&this.core.updateStream(e,a,o.values())}}class ls{constructor(t){x(this,"core"),x(this,"segmentManager"),x(this,"hlsInstanceGetter"),x(this,"currentHlsInstance"),x(this,"debug",Vi("p2pml-hlsjs:engine")),x(this,"updateMediaElementEventHandlers",(e)=>{var n;const i=(n=this.currentHlsInstance)==null?void 0:n.media;if(!i)return;const r=e==="register"?"addEventListener":"removeEventListener";i[r]("timeupdate",this.handlePlaybackUpdate),i[r]("seeking",this.handlePlaybackUpdate),i[r]("ratechange",this.handlePlaybackUpdate)}),x(this,"handleManifestLoaded",(e,n)=>{const i=n.networkDetails;i instanceof XMLHttpRequest?this.core.setManifestResponseUrl(i.responseURL):i instanceof Response&&this.core.setManifestResponseUrl(i.url),this.segmentManager.processMainManifest(n)}),x(this,"handleLevelSwitching",(e,n)=>{n.bitrate&&this.core.setActiveLevelBitrate(n.bitrate)}),x(this,"handleLevelUpdated",(e,n)=>{this.currentHlsInstance&&this.currentHlsInstance.config.liveSyncDurationCount!==n.details.fragments.length-1&&n.details.live&&n.details.fragments[0].type==="main"&&!this.currentHlsInstance.userConfig.liveSyncDuration&&!this.currentHlsInstance.userConfig.liveSyncDurationCount&&n.details.fragments.length>4&&(this.debug("set liveSyncDurationCount "+(n.details.fragments.length-1)),this.currentHlsInstance.config.liveSyncDurationCount=n.details.fragments.length-1),this.core.setIsLive(n.details.live),this.segmentManager.updatePlaylist(n)}),x(this,"handleMediaAttached",()=>{this.updateMediaElementEventHandlers("register")}),x(this,"handleMediaDetached",()=>{this.updateMediaElementEventHandlers("unregister")}),x(this,"handlePlaybackUpdate",(e)=>{const n=e.target;this.core.updatePlayback(n.currentTime,n.playbackRate)}),x(this,"destroyCore",()=>this.core.destroy()),x(this,"destroy",()=>{this.destroyCore(),this.updateHlsEventsHandlers("unregister"),this.updateMediaElementEventHandlers("unregister"),this.currentHlsInstance=void 0}),this.core=new zi(t==null?void 0:t.core),this.segmentManager=new Ki(this.core)}static injectMixin(t){return e=t,i=class extends e{constructor(...r){var o;const a=r[0],{p2p:h,...c}=a??{},d=new ls(h);super({...c,...d.getConfigForHlsJs()}),H(this,n),d.bindHls(this),$(this,n,d),(o=h==null?void 0:h.onHlsJsCreated)==null||o.call(h,this)}get p2pEngine(){return S(this,n)}},n=new WeakMap(),i;var e,n,i}addEventListener(t,e){this.core.addEventListener(t,e)}removeEventListener(t,e){this.core.removeEventListener(t,e)}getConfigForHlsJs(){return{fLoader:this.createFragmentLoaderClass(),pLoader:this.createPlaylistLoaderClass()}}getConfig(){return{core:this.core.getConfig()}}applyDynamicConfig(t){t.core&&this.core.applyDynamicConfig(t.core)}bindHls(t){this.hlsInstanceGetter=typeof t=="function"?t:()=>t}initHlsEvents(){var t;const e=(t=this.hlsInstanceGetter)==null?void 0:t.call(this);this.currentHlsInstance!==e&&(this.currentHlsInstance&&this.destroy(),this.currentHlsInstance=e,this.updateHlsEventsHandlers("register"),this.updateMediaElementEventHandlers("register"))}updateHlsEventsHandlers(t){const e=this.currentHlsInstance;if(!e)return;const n=t==="register"?"on":"off";e[n]("hlsManifestLoaded",this.handleManifestLoaded),e[n]("hlsLevelSwitching",this.handleLevelSwitching),e[n]("hlsLevelUpdated",this.handleLevelUpdated),e[n]("hlsAudioTrackLoaded",this.handleLevelUpdated),e[n]("hlsDestroying",this.destroy),e[n]("hlsMediaAttaching",this.destroyCore),e[n]("hlsManifestLoading",this.destroyCore),e[n]("hlsMediaDetached",this.handleMediaDetached),e[n]("hlsMediaAttached",this.handleMediaAttached)}createFragmentLoaderClass(){const t=this.core,e=this;return class extends Ji{constructor(n){super(n,t)}static getEngine(){return e}}}createPlaylistLoaderClass(){const t=this;return class extends Yi{constructor(e){super(e),t.initHlsEvents()}}}}export{ls as HlsJsP2PEngine};